<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<title>MD Labs ATLAS Pro — AI Traffic Legal Analysis System</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚖️</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if(window.pdfjsLib){window.pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'}</script>
<style>
:root{--bg:#050810;--card:rgba(12,17,30,.82);--b1:rgba(148,163,184,.08);--b2:rgba(148,163,184,.18);--t1:#f1f5f9;--t2:#94a3b8;--t3:#64748b;--blue:#3b82f6;--indigo:#6366f1;--violet:#8b5cf6;--emerald:#10b981;--amber:#f59e0b;--red:#ef4444;--cyan:#06b6d4;--sans:'Noto Sans KR',system-ui,sans-serif;--mono:'JetBrains Mono',monospace}
*{box-sizing:border-box;margin:0;padding:0}html,body,#root{min-height:100vh;overflow-x:hidden}
body{background:var(--bg);color:var(--t1);font-family:var(--sans);-webkit-font-smoothing:antialiased}
::selection{background:rgba(99,102,241,.35)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(148,163,184,.18);border-radius:3px}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
textarea,input,button,select{font-family:var(--sans)}*{-webkit-user-select:text!important;user-select:text!important}input::placeholder,textarea::placeholder{color:rgba(148,163,184,.6)!important;-webkit-text-fill-color:rgba(148,163,184,.6)!important}
.drop-active{border-color:var(--blue)!important;background:rgba(59,130,246,.08)!important}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef,useCallback,useMemo}=React;

/* ╔══════════════════════════════════════════════════════════════╗
   ║  LAYER 0 — SECURITY                                        ║
   ║  입력 검증 · XSS 방지 · 데이터 무결성                       ║
   ╚══════════════════════════════════════════════════════════════╝ */
const SEC={
  sanitize(str){
    if(typeof str!=='string')return'';
    return str.replace(/[<>&"']/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;'})[c]||c);
  },
  validateText(str,maxLen=10000){
    if(typeof str!=='string')return'';
    return str.slice(0,maxLen).replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g,'');
  },
  validateFile(file,maxMB=50){
    if(!file)return{ok:false,reason:'파일 없음'};
    const mb=file.size/1024/1024;
    if(mb>maxMB)return{ok:false,reason:`${maxMB}MB 초과`};
    const ext=(file.name||'').split('.').pop().toLowerCase();
    const allowed=['pdf','jpg','jpeg','png','gif','webp','bmp','mp4','mov','avi','webm','txt'];
    if(!allowed.includes(ext)&&!file.type?.match(/^(image|video|application\/pdf|text)\//))
      return{ok:false,reason:'지원하지 않는 파일 형식'};
    return{ok:true};
  },
  safeJSON(key,fallback=[]){
    try{const d=localStorage.getItem(key);return d?JSON.parse(d):fallback}catch{return fallback}
  },
  safeStore(key,data,maxItems=200){
    try{const d=Array.isArray(data)?data.slice(0,maxItems):data;localStorage.setItem(key,JSON.stringify(d))}catch(e){console.warn('Storage failed:',e)}
  }
};

/* ╔══════════════════════════════════════════════════════════════╗
   ║  LAYER 1 — DATA (코드와 완전 분리된 데이터)                  ║
   ║  도표 DB · 법규 DB · 수정요소 DB                             ║
   ╚══════════════════════════════════════════════════════════════╝ */

/* ── 1-A. 수정요소 마스터 DB (18개) ── */
const MODS_DB=[
  {id:"M01",name:"야간",keywords:["야간","밤","어두","새벽","심야","한밤"],adj:5,desc:"야간 운전으로 시야 제한"},
  {id:"M02",name:"어린이·노약자",keywords:["어린이","아이","노약자","노인","장애인","유아","초등","어르신"],adj:-10,desc:"교통약자 보호의무 가중"},
  {id:"M03",name:"과속",keywords:["과속","제한속도 초과","속도위반","고속"],adj:10,desc:"제한속도 초과 운행"},
  {id:"M04",name:"음주",keywords:["음주","술","만취","혈중알콜","음주운전"],adj:15,desc:"음주상태 운전 (중과실)"},
  {id:"M05",name:"방향지시등 미사용",keywords:["깜빡이","깜박이","방향지시","신호 없이","지시등"],adj:5,desc:"차로변경시 방향지시등 미점등"},
  {id:"M06",name:"급제동",keywords:["급정거","급제동","급브레이크","급정지"],adj:10,desc:"합리적 이유 없는 급제동"},
  {id:"M07",name:"우천",keywords:["우천","비","빗길","폭우","미끄러","노면 젖"],adj:3,desc:"우천시 시야·제동거리 불리"},
  {id:"M08",name:"끼어들기",keywords:["끼어들기","끼어들","무리한 진입"],adj:5,desc:"무리한 끼어들기"},
  {id:"M09",name:"역주행",keywords:["역주행","반대방향","역방향"],adj:20,desc:"역주행 (중과실)"},
  {id:"M10",name:"무면허",keywords:["무면허","면허취소","면허정지"],adj:15,desc:"무면허 운전 (중과실)"},
  {id:"M11",name:"신호위반",keywords:["신호위반","적색진입","빨간불"],adj:20,desc:"교통신호 위반 (중과실)"},
  {id:"M12",name:"안전거리 미확보",keywords:["안전거리","바짝","밀착","차간거리"],adj:5,desc:"안전거리 미확보"},
  {id:"M13",name:"중앙선 침범",keywords:["중앙선","중앙선침범","중앙선 넘"],adj:20,desc:"중앙선 침범 (중과실)"},
  {id:"M14",name:"보행자 보호의무 위반",keywords:["횡단보도 미정지","보행자 무시","보행자 보호"],adj:10,desc:"보행자 보호의무 위반"},
  {id:"M15",name:"안전벨트 미착용",keywords:["안전벨트","벨트 미착용","시트벨트"],adj:3,desc:"안전벨트 미착용"},
  {id:"M16",name:"한눈팔기",keywords:["한눈","전방주시","핸드폰","스마트폰","DMB","휴대폰"],adj:10,desc:"전방주시의무 위반"},
  {id:"M17",name:"적재물 과적",keywords:["과적","적재","과다적재","적재량"],adj:5,desc:"적재물 과적"},
  {id:"M18",name:"도로공사·장애물",keywords:["공사","장애물","도로공사","낙하물"],adj:-5,desc:"도로 환경요인 참작"}
];

/* ── 1-B. 법규 마스터 DB ── */
const LAWS_DB=[
  {id:"L01",article:"도로교통법 제5조",desc:"신호·지시 준수 의무",triggers:["신호","적색","녹색","황색","교차로"]},
  {id:"L02",article:"도로교통법 제13조 제3항",desc:"중앙선 우측 통행 의무",triggers:["중앙선","침범","역주행"]},
  {id:"L03",article:"도로교통법 제17조",desc:"제한속도 준수",triggers:["과속","속도"]},
  {id:"L04",article:"도로교통법 제19조 제1항",desc:"안전거리 확보 의무",triggers:["추돌","안전거리","후행"]},
  {id:"L05",article:"도로교통법 제19조 제3항",desc:"차로변경시 통행 방해 금지",triggers:["차선변경","차로변경","끼어들기"]},
  {id:"L06",article:"도로교통법 제21조",desc:"앞지르기 방법·금지",triggers:["앞지르기","추월"]},
  {id:"L07",article:"도로교통법 제25조",desc:"교차로 통행방법 (좌·우회전)",triggers:["좌회전","우회전","교차로","비보호"]},
  {id:"L08",article:"도로교통법 제25조 제2항",desc:"우회전시 서행 및 보행자 보호",triggers:["우회전","보행자"]},
  {id:"L09",article:"도로교통법 제26조",desc:"교통정리 없는 교차로",triggers:["무신호","비신호","교차로","우선"]},
  {id:"L10",article:"도로교통법 제27조",desc:"횡단보도 보행자 보호 의무",triggers:["횡단보도","보행자","횡단"]},
  {id:"L11",article:"도로교통법 제44조",desc:"음주운전 금지",triggers:["음주","술"]},
  {id:"L12",article:"도로교통법 제48조",desc:"안전운전 의무",triggers:["안전운전"]},
  {id:"L13",article:"도로교통법 제49조 제1항 제8호",desc:"문열기 안전확인 의무",triggers:["문열기","도어링","문"]},
  {id:"L14",article:"민법 제750조",desc:"불법행위 손해배상 책임",triggers:[]},
  {id:"L15",article:"자동차손해배상보장법 제3조",desc:"운행자 책임",triggers:[]},
  {id:"L16",article:"교통사고처리특례법 제3조",desc:"처벌 특례 (12대 중과실)",triggers:["중앙선","신호위반","음주","무면허"]},
  {id:"L17",article:"도로교통법 제60조",desc:"고속도로 최저속도·갓길 진입 금지",triggers:["고속도로"]},
  {id:"L18",article:"도로교통법 제63조",desc:"고속도로 합류·진출 방법",triggers:["합류","진입","가속차로"]},
];

/* ── 1-C. KNIA 과실비율 인정기준 도표 DB ──
   v6.3 대비 변경: patterns[] 배열로 매칭 규칙을 데이터화
   → matchDiagram()에서 if문 하드코딩 완전 제거
   patterns: [{words:[필수키워드], weight:가중치, require:'all'|'any'}]
*/
/*═══════════════════════════════════════════════════════════════════
  MD Labs — 과실비율 도표 DB v2.0 (KNIA 기준 확장)
  손해보험협회 「자동차사고 과실비율 인정기준 2023.06」 기반
  총 200개 도표: 차대차 140 + 차대사람 35 + 차대자전거/이륜차 25
═══════════════════════════════════════════════════════════════════*/
const DB=[
// ══════════════════════════════════════════════════════════════════
//  PART 1: 차대차 — 교차로 (신호 있음)        도표 101~125
// ══════════════════════════════════════════════════════════════════
{id:"101",cat:"차대차",sub:"교차로",t:"녹색직진 vs 적색직진",bf:{a:0,b:100},
  mods:[{n:"과속",v:5,tg:"a"},{n:"현저한 과실",v:5,tg:"a"},{n:"중대한 과실",v:10,tg:"a"}],
  kw:["녹색","직진","적색","교차로","신호"],la:"녹색직진",lb:"적색직진",
  patterns:[{w:["녹색","직진","적색","직진"],wt:40,req:"all"},{w:["신호위반","직진"],wt:20,req:"all"}]},
{id:"102",cat:"차대차",sub:"교차로",t:"녹색직진 vs 적색좌회전",bf:{a:0,b:100},mods:[],
  kw:["녹색","직진","적색","좌회전","교차로"],la:"녹색직진",lb:"적색좌회전",
  patterns:[{w:["녹색","직진","적색","좌회전"],wt:40,req:"all"}]},
{id:"103",cat:"차대차",sub:"교차로",t:"녹색직진 vs 황색직진",bf:{a:20,b:80},
  mods:[{n:"과속",v:5,tg:"a"}],kw:["녹색","직진","황색","교차로"],la:"녹색직진",lb:"황색직진",
  patterns:[{w:["녹색","직진","황색"],wt:35,req:"all"}]},
{id:"104",cat:"차대차",sub:"교차로",t:"황색직진 vs 적색직진",bf:{a:30,b:70},mods:[],
  kw:["황색","적색","직진","교차로"],la:"황색직진",lb:"적색직진",
  patterns:[{w:["황색","직진","적색"],wt:30,req:"all"}]},
{id:"105",cat:"차대차",sub:"교차로",t:"양쪽 적색 직진",bf:{a:50,b:50},
  mods:[{n:"선진입",v:-10,tg:"a"},{n:"과속",v:5,tg:"a"}],
  kw:["적색","양쪽","직진","교차로","신호위반"],la:"적색직진A",lb:"적색직진B",
  patterns:[{w:["양쪽","적색","직진"],wt:35,req:"all"},{w:["적색","적색","교차로"],wt:25,req:"all"}]},
{id:"106",cat:"차대차",sub:"교차로",t:"직진 vs 비보호좌회전",bf:{a:30,b:70},
  mods:[{n:"과속",v:5,tg:"a"},{n:"좌회전 신호불이행",v:5,tg:"b"}],
  kw:["비보호","좌회전","직진","교차로"],la:"직진",lb:"비보호좌회전",
  patterns:[{w:["비보호","좌회전","직진"],wt:40,req:"all"},{w:["비보호","좌회전"],wt:20,req:"all"}]},
{id:"107",cat:"차대차",sub:"교차로",t:"좌회전신호좌회전 vs 적색직진",bf:{a:0,b:100},
  mods:[{n:"현저한 과실",v:5,tg:"a"}],
  kw:["좌회전","신호","적색","직진","교차로"],la:"좌회전신호",lb:"적색직진",
  patterns:[{w:["좌회전","신호","적색","직진"],wt:40,req:"all"}]},
{id:"108",cat:"차대차",sub:"교차로",t:"녹색우회전 vs 횡방향직진",bf:{a:60,b:40},
  mods:[{n:"서행의무위반",v:5,tg:"a"}],
  kw:["녹색","우회전","직진","교차로"],la:"녹색우회전",lb:"횡방향직진",
  patterns:[{w:["녹색","우회전","직진"],wt:30,req:"all"}]},
{id:"109",cat:"차대차",sub:"교차로",t:"적색우회전 vs 녹색직진",bf:{a:80,b:20},
  mods:[{n:"일시정지후 진입",v:-10,tg:"a"}],
  kw:["적색","우회전","녹색","직진","교차로"],la:"적색우회전",lb:"녹색직진",
  patterns:[{w:["적색","우회전","녹색","직진"],wt:35,req:"all"}]},
{id:"110",cat:"차대차",sub:"교차로",t:"녹색좌회전 vs 적색좌회전",bf:{a:0,b:100},mods:[],
  kw:["녹색","좌회전","적색","교차로"],la:"녹색좌회전",lb:"적색좌회전",
  patterns:[{w:["녹색","좌회전","적색","좌회전"],wt:35,req:"all"}]},
{id:"111",cat:"차대차",sub:"교차로",t:"녹색직진 vs 적색우회전",bf:{a:0,b:100},mods:[],
  kw:["녹색","직진","적색","우회전","교차로"],la:"녹색직진",lb:"적색우회전",
  patterns:[{w:["녹색","직진","적색","우회전"],wt:35,req:"all"}]},
{id:"112",cat:"차대차",sub:"교차로",t:"황색좌회전 vs 적색직진",bf:{a:35,b:65},mods:[],
  kw:["황색","좌회전","적색","직진","교차로"],la:"황색좌회전",lb:"적색직진",
  patterns:[{w:["황색","좌회전","적색","직진"],wt:30,req:"all"}]},
{id:"113",cat:"차대차",sub:"교차로",t:"좌회전신호 vs 녹색직진(잔여)",bf:{a:10,b:90},mods:[],
  kw:["좌회전","신호","녹색","직진","잔여"],la:"좌회전신호",lb:"잔여녹색직진",
  patterns:[{w:["좌회전","신호","잔여","직진"],wt:30,req:"all"}]},
{id:"114",cat:"차대차",sub:"교차로",t:"적색 우회전 vs 적색 직진",bf:{a:50,b:50},mods:[],
  kw:["적색","우회전","직진","교차로"],la:"적색우회전",lb:"적색직진",
  patterns:[{w:["적색","우회전","적색","직진"],wt:30,req:"all"}]},
{id:"115",cat:"차대차",sub:"교차로",t:"좌회전 vs 맞은편 좌회전(신호교차로)",bf:{a:50,b:50},
  mods:[{n:"선진입",v:-10,tg:"a"}],
  kw:["좌회전","맞은편","교차로","신호"],la:"좌회전A",lb:"좌회전B",
  patterns:[{w:["좌회전","맞은편","좌회전"],wt:30,req:"all"},{w:["양쪽","좌회전"],wt:20,req:"all"}]},
{id:"116",cat:"차대차",sub:"교차로",t:"녹색직진 vs 적색직진(보행자녹색시)",bf:{a:0,b:100},mods:[],
  kw:["녹색","직진","적색","보행자","교차로"],la:"녹색직진",lb:"적색직진",
  patterns:[{w:["녹색","직진","보행자","적색"],wt:25,req:"all"}]},
{id:"117",cat:"차대차",sub:"교차로",t:"좌회전신호 vs 황색직진",bf:{a:10,b:90},mods:[],
  kw:["좌회전","신호","황색","직진","교차로"],la:"좌회전신호",lb:"황색직진",
  patterns:[{w:["좌회전","신호","황색","직진"],wt:30,req:"all"}]},
{id:"118",cat:"차대차",sub:"교차로",t:"적색 우회전 후 좌측도로 녹색직진",bf:{a:80,b:20},mods:[],
  kw:["적색","우회전","녹색","좌측","교차로"],la:"적색우회전",lb:"녹색직진",
  patterns:[{w:["적색","우회전","녹색"],wt:25,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 2: 차대차 — 교차로 (무신호/비신호)    도표 201~230
// ══════════════════════════════════════════════════════════════════
{id:"201",cat:"차대차",sub:"교차로",t:"같은폭 교차로 우측차 우선",bf:{a:40,b:60},
  mods:[{n:"감속의무위반",v:5,tg:"a"},{n:"서행의무위반",v:5,tg:"b"},{n:"일시정지위반",v:10,tg:"b"},{n:"현저한 과실",v:5,tg:"a"},{n:"중대한 과실",v:10,tg:"a"}],
  kw:["무신호","교차로","직진","우측","동일","같은폭"],la:"좌측차",lb:"우측차",
  patterns:[{w:["무신호","교차로","우측"],wt:30,req:"all"},{w:["같은","폭","교차로"],wt:20,req:"all"},{w:["동일","폭","교차로"],wt:20,req:"all"}]},
{id:"202",cat:"차대차",sub:"교차로",t:"넓은도로 vs 좁은도로",bf:{a:30,b:70},
  mods:[{n:"감속위반",v:5,tg:"a"},{n:"서행위반",v:5,tg:"b"}],
  kw:["넓은","좁은","도로","교차로","무신호","대로","소로"],la:"넓은도로",lb:"좁은도로",
  patterns:[{w:["넓은","도로","좁은","도로"],wt:30,req:"all"},{w:["대로","소로","교차로"],wt:25,req:"all"},{w:["넓은","좁은","교차로"],wt:25,req:"all"}]},
{id:"203",cat:"차대차",sub:"교차로",t:"무신호 직진 vs 좌회전",bf:{a:40,b:60},
  mods:[{n:"좌회전차 선진입",v:-5,tg:"b"},{n:"직진차 과속",v:5,tg:"a"},{n:"현저한 과실",v:5,tg:"a"}],
  kw:["무신호","교차로","직진","좌회전"],la:"직진",lb:"좌회전",
  patterns:[{w:["무신호","직진","좌회전"],wt:30,req:"all"}]},
{id:"204",cat:"차대차",sub:"교차로",t:"무신호 직진 vs 우회전",bf:{a:30,b:70},
  mods:[{n:"서행의무위반",v:5,tg:"b"}],
  kw:["무신호","교차로","직진","우회전"],la:"직진",lb:"우회전",
  patterns:[{w:["무신호","직진","우회전"],wt:30,req:"all"}]},
{id:"205",cat:"차대차",sub:"교차로",t:"무신호 T자로 직진 vs 진입",bf:{a:30,b:70},
  mods:[{n:"과속",v:5,tg:"a"},{n:"일시정지위반",v:10,tg:"b"}],
  kw:["T자","교차로","직진","진입","무신호"],la:"직진",lb:"진입차",
  patterns:[{w:["T자","직진","진입"],wt:30,req:"all"},{w:["무신호","T","교차로"],wt:20,req:"all"}]},
{id:"206",cat:"차대차",sub:"교차로",t:"일시정지 표지 무시 진입",bf:{a:20,b:80},
  mods:[{n:"과속",v:5,tg:"a"},{n:"현저한 과실",v:5,tg:"a"}],
  kw:["일시정지","표지","정지선","무시","교차로"],la:"직진차",lb:"일시정지위반",
  patterns:[{w:["일시정지","무시"],wt:30,req:"all"},{w:["정지","표지","위반"],wt:25,req:"all"}]},
{id:"207",cat:"차대차",sub:"교차로",t:"무신호 좌회전 vs 좌회전(대향)",bf:{a:50,b:50},
  mods:[{n:"선진입",v:-10,tg:"a"}],
  kw:["무신호","좌회전","대향","맞은편","교차로"],la:"좌회전A",lb:"좌회전B",
  patterns:[{w:["무신호","좌회전","대향"],wt:30,req:"all"},{w:["맞은편","좌회전","좌회전"],wt:25,req:"all"}]},
{id:"208",cat:"차대차",sub:"교차로",t:"무신호 우회전 vs 직진(좌측)",bf:{a:60,b:40},mods:[],
  kw:["무신호","우회전","직진","좌측","교차로"],la:"우회전",lb:"직진(좌측)",
  patterns:[{w:["무신호","우회전","좌측","직진"],wt:25,req:"all"}]},
{id:"209",cat:"차대차",sub:"교차로",t:"무신호 동일방향 좌회전 vs 직진",bf:{a:70,b:30},mods:[],
  kw:["무신호","동일","좌회전","직진","교차로"],la:"좌회전",lb:"동일방향직진",
  patterns:[{w:["동일","방향","좌회전","직진"],wt:25,req:"all"}]},
{id:"210",cat:"차대차",sub:"교차로",t:"무신호 대로 직진 vs 소로 좌회전",bf:{a:20,b:80},mods:[],
  kw:["무신호","대로","소로","직진","좌회전","교차로"],la:"대로직진",lb:"소로좌회전",
  patterns:[{w:["대로","직진","소로","좌회전"],wt:30,req:"all"}]},
{id:"211",cat:"차대차",sub:"교차로",t:"무신호 소로 직진 vs 대로 좌회전",bf:{a:40,b:60},mods:[],
  kw:["무신호","소로","대로","직진","좌회전","교차로"],la:"소로직진",lb:"대로좌회전",
  patterns:[{w:["소로","직진","대로","좌회전"],wt:25,req:"all"}]},
{id:"212",cat:"차대차",sub:"교차로",t:"무신호 우측소로 우회전 vs 좌측대로 직진",bf:{a:80,b:20},mods:[],
  kw:["무신호","우측","소로","우회전","대로","직진"],la:"소로우회전",lb:"대로직진",
  patterns:[{w:["소로","우회전","대로","직진"],wt:30,req:"all"}]},
{id:"213",cat:"차대차",sub:"교차로",t:"점멸신호 황색점멸 vs 적색점멸",bf:{a:40,b:60},
  mods:[{n:"일시정지위반",v:10,tg:"b"},{n:"서행위반",v:5,tg:"a"}],
  kw:["점멸","황색","적색","교차로","점멸신호"],la:"황색점멸",lb:"적색점멸",
  patterns:[{w:["점멸","황색","적색"],wt:30,req:"all"},{w:["점멸","신호","교차로"],wt:20,req:"all"}]},
{id:"214",cat:"차대차",sub:"교차로",t:"회전교차로 회전 vs 진입",bf:{a:30,b:70},
  mods:[{n:"과속",v:5,tg:"b"},{n:"서행위반",v:5,tg:"b"},{n:"양보의무위반",v:10,tg:"b"}],
  kw:["회전","교차로","진입","로터리","원형"],la:"회전차",lb:"진입차",
  patterns:[{w:["회전","교차로","진입"],wt:35,req:"all"},{w:["로터리","진입"],wt:25,req:"all"},{w:["원형","교차로"],wt:20,req:"all"}]},
{id:"215",cat:"차대차",sub:"교차로",t:"회전교차로 진출 vs 회전",bf:{a:65,b:35},mods:[],
  kw:["회전","교차로","진출","나가는"],la:"진출차",lb:"회전차",
  patterns:[{w:["회전","교차로","진출"],wt:30,req:"all"},{w:["로터리","나가"],wt:20,req:"all"}]},
{id:"216",cat:"차대차",sub:"교차로",t:"일방통행 위반 진입",bf:{a:0,b:100},mods:[],
  kw:["일방통행","위반","역주행","교차로"],la:"정상진행",lb:"일방통행위반",
  patterns:[{w:["일방통행","위반"],wt:35,req:"all"},{w:["역주행","교차로"],wt:25,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 3: 차대차 — 대향(맞은편)              도표 301~320
// ══════════════════════════════════════════════════════════════════
{id:"301",cat:"차대차",sub:"대향",t:"중앙선 침범",bf:{a:0,b:100},
  mods:[{n:"과속",v:5,tg:"a"},{n:"현저한 과실",v:5,tg:"a"},{n:"중대한 과실",v:10,tg:"a"}],
  kw:["중앙선","침범","정면충돌","대향","역주행","반대"],la:"직진차",lb:"중앙선침범",
  patterns:[{w:["중앙선","침범"],wt:45,req:"all"},{w:["정면","충돌","대향"],wt:25,req:"all"},{w:["역주행","정면"],wt:25,req:"all"}]},
{id:"302",cat:"차대차",sub:"대향",t:"좌회전 vs 직진(대향)",bf:{a:70,b:30},
  mods:[{n:"좌회전 신호불이행",v:5,tg:"a"},{n:"직진차 과속",v:5,tg:"b"},{n:"현저한 과실",v:5,tg:"a"},{n:"중대한 과실",v:10,tg:"a"}],
  kw:["좌회전","직진","대향","맞은편","교차로"],la:"좌회전",lb:"직진(대향)",
  patterns:[{w:["좌회전","직진","대향"],wt:30,req:"all"},{w:["좌회전","맞은편","직진"],wt:25,req:"all"},{w:["비보호","좌회전","직진"],wt:30,req:"all"}]},
{id:"303",cat:"차대차",sub:"대향",t:"유턴 vs 직진",bf:{a:80,b:20},
  mods:[{n:"직진차 과속",v:5,tg:"b"},{n:"유턴금지구역",v:5,tg:"a"}],
  kw:["유턴","직진","대향","회전"],la:"유턴차",lb:"직진차",
  patterns:[{w:["유턴","직진"],wt:40,req:"all"},{w:["U턴","직진"],wt:35,req:"all"},{w:["회전","직진","대향"],wt:20,req:"all"}]},
{id:"304",cat:"차대차",sub:"대향",t:"중앙선 침범(커브길)",bf:{a:0,b:100},
  mods:[{n:"과속",v:5,tg:"a"},{n:"현저한 과실",v:5,tg:"a"}],
  kw:["중앙선","침범","커브","곡선","정면","대향"],la:"직진차",lb:"중앙선침범(커브)",
  patterns:[{w:["중앙선","침범","커브"],wt:35,req:"all"},{w:["곡선","중앙선"],wt:25,req:"all"}]},
{id:"305",cat:"차대차",sub:"대향",t:"중앙선 침범(추월 시)",bf:{a:0,b:100},mods:[],
  kw:["중앙선","침범","추월","앞지르기","대향"],la:"직진차",lb:"추월중침범",
  patterns:[{w:["추월","중앙선","침범"],wt:35,req:"all"},{w:["앞지르기","중앙선"],wt:30,req:"all"}]},
{id:"306",cat:"차대차",sub:"대향",t:"유턴 vs 좌회전(대향)",bf:{a:60,b:40},mods:[],
  kw:["유턴","좌회전","대향","맞은편"],la:"유턴차",lb:"좌회전차",
  patterns:[{w:["유턴","좌회전","대향"],wt:30,req:"all"}]},
{id:"307",cat:"차대차",sub:"대향",t:"좌회전 vs 좌회전(대향)",bf:{a:50,b:50},
  mods:[{n:"선진입",v:-10,tg:"a"}],
  kw:["좌회전","대향","맞은편","양쪽"],la:"좌회전A",lb:"좌회전B(대향)",
  patterns:[{w:["좌회전","좌회전","대향"],wt:30,req:"all"},{w:["맞은편","좌회전","양쪽"],wt:25,req:"all"}]},
{id:"308",cat:"차대차",sub:"대향",t:"편도1차로 대향 맞은편 진행",bf:{a:50,b:50},mods:[],
  kw:["편도","1차로","대향","맞은편","좁은"],la:"A차",lb:"B차",
  patterns:[{w:["편도","1차로","대향"],wt:25,req:"all"},{w:["좁은","도로","대향"],wt:20,req:"all"}]},
{id:"309",cat:"차대차",sub:"대향",t:"유턴금지구역 유턴",bf:{a:90,b:10},mods:[],
  kw:["유턴","금지","구역","위반","대향"],la:"유턴위반",lb:"직진차",
  patterns:[{w:["유턴","금지","위반"],wt:35,req:"all"}]},
{id:"310",cat:"차대차",sub:"대향",t:"불법 좌회전 vs 직진",bf:{a:90,b:10},mods:[],
  kw:["불법","좌회전","직진","금지","대향"],la:"불법좌회전",lb:"직진차",
  patterns:[{w:["불법","좌회전","직진"],wt:35,req:"all"},{w:["좌회전","금지","위반"],wt:30,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 4: 차대차 — 동행(같은방향)            도표 401~445
// ══════════════════════════════════════════════════════════════════
{id:"401",cat:"차대차",sub:"동행",t:"후행차 추돌 (기본)",bf:{a:0,b:100},
  mods:[{n:"급제동",v:10,tg:"a"},{n:"제동등 고장",v:5,tg:"a"},{n:"과속",v:5,tg:"b"},{n:"현저한 과실",v:5,tg:"b"},{n:"중대한 과실",v:10,tg:"b"}],
  kw:["추돌","후방","뒤따르던","후행","기본"],la:"선행차",lb:"후행차",
  patterns:[{w:["추돌"],wt:30,req:"all"},{w:["뒤","충돌"],wt:20,req:"all"},{w:["후행","추돌"],wt:25,req:"all"}]},
{id:"402",cat:"차대차",sub:"동행",t:"선행차 급정거 후 추돌",bf:{a:30,b:70},
  mods:[{n:"합리적 이유있는 급정거",v:-10,tg:"a"},{n:"과속",v:5,tg:"b"}],
  kw:["급정거","급제동","추돌","급브레이크","급정지"],la:"선행차(급정거)",lb:"후행차",
  patterns:[{w:["급정거","추돌"],wt:35,req:"all"},{w:["급제동","추돌"],wt:30,req:"all"},{w:["급브레이크","추돌"],wt:25,req:"all"}]},
{id:"403",cat:"차대차",sub:"동행",t:"적법주정차 차량 추돌",bf:{a:0,b:100},
  mods:[{n:"야간 미등 미점등",v:10,tg:"a"},{n:"비상점멸등 미점등",v:5,tg:"a"}],
  kw:["주정차","추돌","적법","정차","주차","도로변"],la:"주정차",lb:"추돌차",
  patterns:[{w:["적법","주정차","추돌"],wt:30,req:"all"},{w:["정차","차량","추돌"],wt:20,req:"all"}]},
{id:"404",cat:"차대차",sub:"동행",t:"불법주정차 차량 추돌",bf:{a:20,b:80},
  mods:[{n:"야간",v:5,tg:"b"},{n:"커브 부근",v:5,tg:"a"},{n:"현저한 과실",v:5,tg:"b"}],
  kw:["불법","주정차","추돌","위법","노상"],la:"불법주정차",lb:"추돌차",
  patterns:[{w:["불법","주정차","추돌"],wt:35,req:"all"},{w:["불법","정차","추돌"],wt:25,req:"all"}]},
{id:"405",cat:"차대차",sub:"동행",t:"차선변경 vs 직진(후방충돌)",bf:{a:70,b:30},
  mods:[{n:"신호불이행",v:10,tg:"a"},{n:"과속",v:5,tg:"b"},{n:"현저한 과실",v:5,tg:"a"},{n:"중대한 과실",v:10,tg:"a"}],
  kw:["차선","변경","직진","후방","끼어들기","진로"],la:"차선변경",lb:"직진차",
  patterns:[{w:["차선","변경","직진"],wt:35,req:"all"},{w:["끼어들기","직진"],wt:25,req:"all"},{w:["진로","변경","직진"],wt:25,req:"all"}]},
{id:"406",cat:"차대차",sub:"동행",t:"차선변경 vs 직진(측면충돌)",bf:{a:80,b:20},
  mods:[{n:"깜빡이",v:-5,tg:"a"},{n:"과속",v:5,tg:"b"}],
  kw:["차선","변경","직진","측면","옆면","사이드"],la:"차선변경",lb:"직진차",
  patterns:[{w:["차선","변경","측면"],wt:35,req:"all"},{w:["끼어들기","측면"],wt:25,req:"all"}]},
{id:"407",cat:"차대차",sub:"동행",t:"동시 차선변경 충돌",bf:{a:50,b:50},
  mods:[{n:"신호불이행",v:5,tg:"a"},{n:"급차선변경",v:5,tg:"a"}],
  kw:["동시","차선","변경","양쪽","충돌"],la:"차선변경A",lb:"차선변경B",
  patterns:[{w:["동시","차선","변경"],wt:35,req:"all"},{w:["양쪽","차선","변경"],wt:30,req:"all"}]},
{id:"408",cat:"차대차",sub:"동행",t:"진로변경(끼어들기) 직후 추돌",bf:{a:70,b:30},
  mods:[{n:"방향지시 미등",v:10,tg:"a"},{n:"급차선변경",v:5,tg:"a"}],
  kw:["끼어들기","진로","변경","추돌","직후","들어오자마자"],la:"끼어들기",lb:"후행차",
  patterns:[{w:["끼어들기","추돌"],wt:35,req:"all"},{w:["진로","변경","직후","추돌"],wt:30,req:"all"}]},
{id:"409",cat:"차대차",sub:"동행",t:"좌측 앞지르기 중 충돌",bf:{a:70,b:30},
  mods:[{n:"앞지르기금지 장소",v:10,tg:"a"},{n:"과속",v:5,tg:"a"}],
  kw:["앞지르기","추월","좌측","충돌","동행"],la:"앞지르기차",lb:"직진차",
  patterns:[{w:["앞지르기","충돌"],wt:30,req:"all"},{w:["추월","충돌"],wt:25,req:"all"}]},
{id:"410",cat:"차대차",sub:"동행",t:"우측 앞지르기(위법)",bf:{a:80,b:20},mods:[],
  kw:["우측","앞지르기","추월","위법","오른쪽"],la:"우측앞지르기",lb:"직진차",
  patterns:[{w:["우측","앞지르기"],wt:35,req:"all"},{w:["오른쪽","추월"],wt:25,req:"all"}]},
{id:"411",cat:"차대차",sub:"동행",t:"앞지르기 금지장소 추월",bf:{a:90,b:10},mods:[],
  kw:["앞지르기","금지","추월","금지","장소"],la:"금지장소추월",lb:"직진차",
  patterns:[{w:["앞지르기","금지","장소"],wt:35,req:"all"}]},
{id:"412",cat:"차대차",sub:"동행",t:"차로 감소 합류 충돌",bf:{a:50,b:50},
  mods:[{n:"속도우위",v:-5,tg:"a"},{n:"선진입",v:-10,tg:"a"}],
  kw:["차로","감소","합류","병합","충돌"],la:"합류차A",lb:"합류차B",
  patterns:[{w:["차로","감소","합류"],wt:30,req:"all"},{w:["병합","충돌"],wt:20,req:"all"}]},
{id:"413",cat:"차대차",sub:"동행",t:"정체 중 급차선변경",bf:{a:80,b:20},mods:[],
  kw:["정체","급차선변경","교통","정체","차선변경"],la:"급차선변경",lb:"직진차",
  patterns:[{w:["정체","급","차선","변경"],wt:30,req:"all"},{w:["정체","끼어들기"],wt:25,req:"all"}]},
{id:"414",cat:"차대차",sub:"동행",t:"다차선 2단계 차선변경",bf:{a:85,b:15},mods:[],
  kw:["2단계","차선변경","다차선","연속","차선변경"],la:"2단계변경",lb:"직진차",
  patterns:[{w:["2단계","차선","변경"],wt:30,req:"all"},{w:["연속","차선","변경"],wt:25,req:"all"}]},
{id:"415",cat:"차대차",sub:"동행",t:"정차후 출발 vs 직진(우회전)",bf:{a:70,b:30},mods:[],
  kw:["정차","출발","직진","우회전","재출발"],la:"재출발차",lb:"직진차",
  patterns:[{w:["정차","출발","직진"],wt:25,req:"all"},{w:["재출발","충돌"],wt:20,req:"all"}]},
{id:"416",cat:"차대차",sub:"동행",t:"선행 좌회전 vs 후행 직진",bf:{a:60,b:40},mods:[],
  kw:["선행","좌회전","후행","직진","동일","방향"],la:"선행좌회전",lb:"후행직진",
  patterns:[{w:["선행","좌회전","후행","직진"],wt:30,req:"all"}]},
{id:"417",cat:"차대차",sub:"동행",t:"선행 우회전 vs 후행 직진",bf:{a:60,b:40},mods:[],
  kw:["선행","우회전","후행","직진","동일","방향"],la:"선행우회전",lb:"후행직진",
  patterns:[{w:["선행","우회전","후행","직진"],wt:30,req:"all"}]},
{id:"418",cat:"차대차",sub:"동행",t:"전용차로 위반 진입 충돌",bf:{a:80,b:20},mods:[],
  kw:["전용","차로","위반","버스","전용","충돌"],la:"전용차로위반",lb:"직진차",
  patterns:[{w:["전용","차로","위반"],wt:30,req:"all"},{w:["버스","전용","충돌"],wt:25,req:"all"}]},
{id:"419",cat:"차대차",sub:"동행",t:"진로변경금지 장소 차선변경",bf:{a:90,b:10},mods:[],
  kw:["진로변경","금지","차선변경","실선","위반"],la:"금지차선변경",lb:"직진차",
  patterns:[{w:["진로변경","금지","차선변경"],wt:35,req:"all"},{w:["실선","위반","차선변경"],wt:30,req:"all"}]},
{id:"420",cat:"차대차",sub:"동행",t:"연쇄추돌(3중추돌)",bf:{a:0,b:100},
  mods:[{n:"1차 추돌차 과실",v:10,tg:"a"}],
  kw:["연쇄","추돌","3중","다중","연속","추돌"],la:"앞차",lb:"뒤차(최후)",
  patterns:[{w:["연쇄","추돌"],wt:30,req:"all"},{w:["3중","추돌"],wt:25,req:"all"},{w:["다중","추돌"],wt:25,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 5: 차대차 — 합류/진입                 도표 501~520
// ══════════════════════════════════════════════════════════════════
{id:"501",cat:"차대차",sub:"합류",t:"도로 진입 vs 직진",bf:{a:80,b:20},
  mods:[{n:"서행의무위반",v:5,tg:"a"},{n:"과속",v:5,tg:"b"},{n:"현저한 과실",v:5,tg:"a"}],
  kw:["진입","도로","합류","직진","본선"],la:"진입차",lb:"직진차",
  patterns:[{w:["도로","진입","직진"],wt:30,req:"all"},{w:["합류","직진"],wt:25,req:"all"}]},
{id:"502",cat:"차대차",sub:"합류",t:"고속도로 합류 vs 본선",bf:{a:70,b:30},
  mods:[{n:"과속",v:5,tg:"b"},{n:"합류신호불이행",v:5,tg:"a"},{n:"현저한 과실",v:5,tg:"a"}],
  kw:["고속도로","합류","본선","진입","가속차로","램프"],la:"합류차",lb:"본선차",
  patterns:[{w:["고속도로","합류","본선"],wt:35,req:"all"},{w:["가속","차로","합류"],wt:25,req:"all"},{w:["램프","합류"],wt:20,req:"all"}]},
{id:"503",cat:"차대차",sub:"합류",t:"도로외 장소에서 우회전 진입",bf:{a:80,b:20},mods:[],
  kw:["도로외","주차장","진입","우회전","장소"],la:"진입차",lb:"직진차",
  patterns:[{w:["도로외","진입","우회전"],wt:30,req:"all"},{w:["주차장","나와","진입"],wt:25,req:"all"}]},
{id:"504",cat:"차대차",sub:"합류",t:"도로외 장소에서 좌회전 진입",bf:{a:90,b:10},mods:[],
  kw:["도로외","주차장","진입","좌회전","장소"],la:"진입차",lb:"직진차",
  patterns:[{w:["도로외","진입","좌회전"],wt:30,req:"all"},{w:["주차장","나와","좌회전"],wt:25,req:"all"}]},
{id:"505",cat:"차대차",sub:"합류",t:"고속도로 진출 vs 본선",bf:{a:60,b:40},mods:[],
  kw:["고속도로","진출","감속","본선","나가는"],la:"진출차",lb:"본선차",
  patterns:[{w:["고속도로","진출","본선"],wt:30,req:"all"},{w:["감속","차로","진출"],wt:25,req:"all"}]},
{id:"506",cat:"차대차",sub:"합류",t:"직진 vs 도로가 아닌 장소에서 후진 진입",bf:{a:10,b:90},mods:[],
  kw:["도로외","후진","진입","직진","장소"],la:"직진차",lb:"후진진입",
  patterns:[{w:["도로외","후진","진입"],wt:30,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 6: 차대차 — 고속도로                  도표 551~570
// ══════════════════════════════════════════════════════════════════
{id:"551",cat:"차대차",sub:"고속도로",t:"고속도로 추돌(기본)",bf:{a:0,b:100},
  mods:[{n:"급제동",v:10,tg:"a"},{n:"과속",v:5,tg:"b"},{n:"안전거리미확보",v:5,tg:"b"}],
  kw:["고속도로","추돌","후방","안전거리"],la:"선행차",lb:"후행차",
  patterns:[{w:["고속도로","추돌"],wt:30,req:"all"}]},
{id:"552",cat:"차대차",sub:"고속도로",t:"고속도로 본선 정지차 추돌",bf:{a:30,b:70},
  mods:[{n:"안전조치불이행",v:10,tg:"a"},{n:"야간",v:5,tg:"b"}],
  kw:["고속도로","본선","정지","추돌","고장"],la:"정지차",lb:"추돌차",
  patterns:[{w:["고속도로","정지","추돌"],wt:30,req:"all"},{w:["고속도로","고장","추돌"],wt:25,req:"all"}]},
{id:"553",cat:"차대차",sub:"고속도로",t:"고속도로 갓길 정차 추돌",bf:{a:10,b:90},mods:[],
  kw:["고속도로","갓길","정차","추돌","노견"],la:"갓길정차",lb:"추돌차",
  patterns:[{w:["고속도로","갓길","추돌"],wt:30,req:"all"},{w:["갓길","정차","추돌"],wt:25,req:"all"}]},
{id:"554",cat:"차대차",sub:"고속도로",t:"고속도로 역주행",bf:{a:0,b:100},mods:[],
  kw:["고속도로","역주행","반대","진행","대향"],la:"정상진행",lb:"역주행차",
  patterns:[{w:["고속도로","역주행"],wt:40,req:"all"}]},
{id:"555",cat:"차대차",sub:"고속도로",t:"고속도로 차선변경 충돌",bf:{a:20,b:80},mods:[],
  kw:["고속도로","차선변경","직진","충돌"],la:"직진차",lb:"차선변경차",
  patterns:[{w:["고속도로","차선","변경"],wt:25,req:"all"}]},
{id:"556",cat:"차대차",sub:"고속도로",t:"고속도로 저속주행 추돌",bf:{a:20,b:80},mods:[],
  kw:["고속도로","저속","주행","추돌","느린"],la:"저속차",lb:"추돌차",
  patterns:[{w:["고속도로","저속","추돌"],wt:30,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 7: 차대차 — 기타                      도표 601~640
// ══════════════════════════════════════════════════════════════════
{id:"601",cat:"차대차",sub:"기타",t:"주차장 통로 직진 vs 출차(후진)",bf:{a:30,b:70},
  mods:[{n:"서행의무위반",v:5,tg:"a"},{n:"현저한 과실",v:5,tg:"b"}],
  kw:["주차장","통로","직진","출차","후진","주차구획"],la:"통로직진",lb:"출차(후진)",
  patterns:[{w:["주차장","통로","출차"],wt:35,req:"all"},{w:["주차장","후진","직진"],wt:30,req:"all"},{w:["출차","통로","직진"],wt:30,req:"all"}]},
{id:"602",cat:"차대차",sub:"기타",t:"주차장 통로 내 교행",bf:{a:50,b:50},mods:[],
  kw:["주차장","통로","교행","맞은편","주차"],la:"A차",lb:"B차",
  patterns:[{w:["주차장","통로","교행"],wt:30,req:"all"},{w:["주차장","맞은편"],wt:20,req:"all"}]},
{id:"603",cat:"차대차",sub:"기타",t:"주차장 통로 교차로 충돌",bf:{a:50,b:50},mods:[],
  kw:["주차장","통로","교차로","충돌"],la:"A차",lb:"B차",
  patterns:[{w:["주차장","통로","교차","충돌"],wt:30,req:"all"}]},
{id:"604",cat:"차대차",sub:"기타",t:"주차장 입구 진입 vs 진출",bf:{a:40,b:60},mods:[],
  kw:["주차장","입구","진입","진출","출입구"],la:"진입차",lb:"진출차",
  patterns:[{w:["주차장","입구","진입","진출"],wt:30,req:"all"}]},
{id:"605",cat:"차대차",sub:"기타",t:"후진 vs 후진",bf:{a:50,b:50},
  mods:[{n:"서행의무위반",v:5,tg:"a"},{n:"경적불이행",v:5,tg:"a"}],
  kw:["후진","양쪽","충돌","뒤로"],la:"후진A",lb:"후진B",
  patterns:[{w:["후진","후진"],wt:40,req:"all"},{w:["양쪽","후진"],wt:30,req:"all"}]},
{id:"606",cat:"차대차",sub:"기타",t:"후진 vs 직진",bf:{a:80,b:20},
  mods:[{n:"과속",v:5,tg:"b"},{n:"현저한 과실",v:5,tg:"a"}],
  kw:["후진","직진","뒤로","충돌"],la:"후진차",lb:"직진차",
  patterns:[{w:["후진","직진","충돌"],wt:35,req:"all"},{w:["후진","충돌"],wt:20,req:"all"}]},
{id:"607",cat:"차대차",sub:"기타",t:"위법차선변경 vs 오토바이",bf:{a:70,b:30},
  mods:[{n:"오토바이 과속",v:5,tg:"b"},{n:"차선변경금지위반",v:10,tg:"a"}],
  kw:["차선변경","오토바이","이륜","바이크","측면"],la:"차선변경차",lb:"오토바이",
  patterns:[{w:["차선변경","오토바이"],wt:35,req:"all"},{w:["차선변경","이륜"],wt:25,req:"all"}]},
{id:"608",cat:"차대차",sub:"기타",t:"문열기(도어링) 사고",bf:{a:10,b:90},
  mods:[{n:"주정차금지구역",v:5,tg:"b"},{n:"후방확인불이행",v:5,tg:"b"}],
  kw:["문","열기","도어","충돌","도어링"],la:"후행차",lb:"문열기차",
  patterns:[{w:["문","열기","충돌"],wt:40,req:"all"},{w:["도어","충돌"],wt:30,req:"all"},{w:["도어링"],wt:35,req:"all"}]},
{id:"609",cat:"차대차",sub:"기타",t:"주차구획 내 접촉",bf:{a:50,b:50},mods:[],
  kw:["주차","구획","접촉","주차장","옆차"],la:"A차",lb:"B차",
  patterns:[{w:["주차","구획","접촉"],wt:30,req:"all"},{w:["주차장","옆","접촉"],wt:20,req:"all"}]},
{id:"610",cat:"차대차",sub:"기타",t:"갓길(노견) 주행 충돌",bf:{a:80,b:20},mods:[],
  kw:["갓길","노견","주행","충돌","어깨"],la:"갓길주행",lb:"직진차",
  patterns:[{w:["갓길","주행","충돌"],wt:30,req:"all"},{w:["노견","주행"],wt:25,req:"all"}]},
{id:"611",cat:"차대차",sub:"기타",t:"터널 내 사고",bf:{a:0,b:100},
  mods:[{n:"터널 내 감속의무위반",v:5,tg:"b"},{n:"안전거리미확보",v:5,tg:"b"}],
  kw:["터널","내","사고","추돌","어두운"],la:"선행차",lb:"후행차",
  patterns:[{w:["터널","추돌"],wt:30,req:"all"},{w:["터널","사고"],wt:20,req:"all"}]},
{id:"612",cat:"차대차",sub:"기타",t:"이면도로(좁은 골목) 교행 충돌",bf:{a:50,b:50},mods:[],
  kw:["이면","도로","골목","교행","좁은","마을"],la:"A차",lb:"B차",
  patterns:[{w:["이면","도로","교행"],wt:25,req:"all"},{w:["골목","교행"],wt:25,req:"all"},{w:["좁은","길","교행"],wt:20,req:"all"}]},
{id:"613",cat:"차대차",sub:"기타",t:"급경사 도로 사고",bf:{a:50,b:50},
  mods:[{n:"내리막 차량 과실",v:10,tg:"a"}],
  kw:["급경사","내리막","오르막","경사","충돌"],la:"내리막차",lb:"오르막차",
  patterns:[{w:["경사","충돌"],wt:20,req:"all"},{w:["내리막","오르막","충돌"],wt:25,req:"all"}]},
{id:"614",cat:"차대차",sub:"기타",t:"비보호 우회전 vs 횡방향 직진",bf:{a:60,b:40},mods:[],
  kw:["비보호","우회전","횡방향","직진","교차로"],la:"우회전",lb:"횡방향직진",
  patterns:[{w:["비보호","우회전","직진"],wt:25,req:"all"}]},
{id:"615",cat:"차대차",sub:"기타",t:"공사구간 차선규제 충돌",bf:{a:50,b:50},mods:[],
  kw:["공사","구간","차선","규제","충돌"],la:"A차",lb:"B차",
  patterns:[{w:["공사","구간","충돌"],wt:25,req:"all"}]},
{id:"616",cat:"차대차",sub:"기타",t:"긴급차량 진로양보 미이행",bf:{a:80,b:20},mods:[],
  kw:["긴급","차량","진로","양보","소방","구급","경찰"],la:"비양보차",lb:"긴급차량",
  patterns:[{w:["긴급","차량","양보"],wt:30,req:"all"},{w:["소방","구급","양보"],wt:25,req:"all"}]},
{id:"617",cat:"차대차",sub:"기타",t:"적재물 낙하 후속사고",bf:{a:0,b:100},mods:[],
  kw:["적재물","낙하","떨어진","물건","도로","장애물"],la:"후행차",lb:"적재물낙하차",
  patterns:[{w:["적재물","낙하"],wt:35,req:"all"},{w:["물건","떨어진","도로"],wt:25,req:"all"}]},
{id:"618",cat:"차대차",sub:"기타",t:"도로상 물건 방치 후속사고",bf:{a:30,b:70},mods:[],
  kw:["도로","물건","방치","장애물","충돌"],la:"후행차",lb:"물건방치차",
  patterns:[{w:["도로","물건","방치"],wt:25,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 8: 차대사람 — 횡단보도               도표 보1~보20
// ══════════════════════════════════════════════════════════════════
{id:"보1",cat:"차대사람",sub:"횡단보도",t:"차녹색직진 vs 보행자적색횡단",bf:{c:20,p:80},
  mods:[{n:"야간",v:5,tg:"p"},{n:"과속",v:5,tg:"c"},{n:"어린이",v:-10,tg:"p"},{n:"노인",v:-5,tg:"p"},{n:"현저한 과실",v:5,tg:"c"}],
  kw:["횡단보도","녹색","적색","직진","보행자","횡단"],la:"차량",lb:"보행자",
  patterns:[{w:["횡단보도","녹색","적색"],wt:30,req:"all"},{w:["보행자","적색","횡단"],wt:25,req:"all"}]},
{id:"보2",cat:"차대사람",sub:"횡단보도",t:"차적색 vs 보행자녹색",bf:{c:100,p:0},
  mods:[{n:"보행자 뛰어들기",v:-5,tg:"p"}],
  kw:["횡단보도","적색","녹색","보행자","신호위반"],la:"차량",lb:"보행자",
  patterns:[{w:["횡단보도","차","적색","보행자","녹색"],wt:35,req:"all"},{w:["보행자","녹색","차","신호위반"],wt:30,req:"all"}]},
{id:"보3",cat:"차대사람",sub:"횡단보도",t:"무신호 횡단보도 보행자",bf:{c:80,p:20},
  mods:[{n:"야간",v:5,tg:"p"},{n:"과속",v:5,tg:"c"},{n:"어린이",v:-10,tg:"p"},{n:"현저한 과실",v:5,tg:"c"}],
  kw:["무신호","횡단보도","보행자","횡단"],la:"차량",lb:"보행자",
  patterns:[{w:["무신호","횡단보도","보행자"],wt:35,req:"all"}]},
{id:"보4",cat:"차대사람",sub:"횡단보도",t:"우회전 vs 횡단보도 보행자(녹색)",bf:{c:95,p:5},
  mods:[{n:"야간",v:3,tg:"p"},{n:"어린이",v:-3,tg:"p"}],
  kw:["우회전","횡단보도","보행자","녹색","횡단"],la:"우회전차",lb:"보행자",
  patterns:[{w:["우회전","횡단보도","보행자"],wt:35,req:"all"},{w:["우회전","보행자","녹색"],wt:30,req:"all"}]},
{id:"보5",cat:"차대사람",sub:"횡단보도",t:"좌회전 vs 횡단보도 보행자",bf:{c:90,p:10},
  mods:[{n:"야간",v:5,tg:"p"},{n:"어린이",v:-5,tg:"p"}],
  kw:["좌회전","횡단보도","보행자","횡단"],la:"좌회전차",lb:"보행자",
  patterns:[{w:["좌회전","횡단보도","보행자"],wt:35,req:"all"}]},
{id:"보6",cat:"차대사람",sub:"횡단보도",t:"보행자 황색점멸시 횡단",bf:{c:70,p:30},mods:[],
  kw:["황색","점멸","횡단보도","보행자","횡단"],la:"차량",lb:"보행자",
  patterns:[{w:["황색","점멸","횡단","보행자"],wt:25,req:"all"}]},
{id:"보7",cat:"차대사람",sub:"횡단보도",t:"횡단보도 직전 정지차 옆 통과 보행자 충격",bf:{c:90,p:10},mods:[],
  kw:["횡단보도","정지","차량","옆","통과","보행자"],la:"통과차",lb:"보행자",
  patterns:[{w:["횡단보도","정지","옆","통과","보행자"],wt:30,req:"all"}]},
{id:"보8",cat:"차대사람",sub:"횡단보도",t:"보행자 녹색 잔여시간(점멸) 횡단",bf:{c:80,p:20},mods:[],
  kw:["녹색","점멸","잔여","횡단보도","보행자"],la:"차량",lb:"보행자",
  patterns:[{w:["녹색","점멸","횡단","보행자"],wt:25,req:"all"}]},
{id:"보9",cat:"차대사람",sub:"횡단보도",t:"스쿨존 횡단보도 보행자(어린이)",bf:{c:95,p:5},
  mods:[{n:"과속",v:5,tg:"c"}],
  kw:["스쿨존","어린이","횡단보도","보호구역","초등학교"],la:"차량",lb:"어린이",
  patterns:[{w:["스쿨존","횡단보도","어린이"],wt:35,req:"all"},{w:["어린이","보호구역","횡단"],wt:30,req:"all"}]},
{id:"보10",cat:"차대사람",sub:"횡단보도",t:"횡단보도 부근(5m이내) 횡단 보행자",bf:{c:70,p:30},mods:[],
  kw:["횡단보도","부근","근처","5m","보행자","횡단"],la:"차량",lb:"보행자",
  patterns:[{w:["횡단보도","부근","보행자"],wt:25,req:"all"},{w:["횡단보도","근처","횡단"],wt:20,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 9: 차대사람 — 기타                   도표 보11~보30
// ══════════════════════════════════════════════════════════════════
{id:"보11",cat:"차대사람",sub:"기타",t:"횡단보도 밖 횡단",bf:{c:60,p:40},
  mods:[{n:"야간",v:5,tg:"p"},{n:"어린이",v:-10,tg:"p"},{n:"과속",v:5,tg:"c"},{n:"음주",v:10,tg:"p"}],
  kw:["횡단보도","밖","횡단","무단","차도"],la:"차량",lb:"보행자",
  patterns:[{w:["횡단보도","밖","횡단"],wt:30,req:"all"},{w:["무단","횡단"],wt:25,req:"all"}]},
{id:"보12",cat:"차대사람",sub:"기타",t:"차도 무단횡단(보행자)",bf:{c:40,p:60},
  mods:[{n:"야간",v:5,tg:"p"},{n:"어린이",v:-15,tg:"p"},{n:"과속",v:5,tg:"c"},{n:"음주보행",v:10,tg:"p"},{n:"현저한 과실",v:5,tg:"c"}],
  kw:["차도","무단","횡단","보행자","중앙","건너다"],la:"차량",lb:"보행자",
  patterns:[{w:["무단","횡단","차도"],wt:35,req:"all"},{w:["도로","건너다","보행자"],wt:20,req:"all"},{w:["횡단","금지","보행자"],wt:25,req:"all"}]},
{id:"보13",cat:"차대사람",sub:"기타",t:"보도 침범",bf:{c:100,p:0},
  mods:[],
  kw:["보도","인도","침범","보행자","인도","올라가"],la:"차량",lb:"보행자",
  patterns:[{w:["보도","침범"],wt:40,req:"all"},{w:["인도","침범"],wt:35,req:"all"},{w:["인도","올라가","보행자"],wt:25,req:"all"}]},
{id:"보14",cat:"차대사람",sub:"기타",t:"후진 vs 보행자",bf:{c:90,p:10},
  mods:[{n:"야간",v:5,tg:"p"},{n:"어린이",v:-5,tg:"p"}],
  kw:["후진","보행자","뒤","충돌","역진행"],la:"후진차",lb:"보행자",
  patterns:[{w:["후진","보행자"],wt:40,req:"all"},{w:["뒤로","보행자","충돌"],wt:25,req:"all"}]},
{id:"보15",cat:"차대사람",sub:"기타",t:"차도 보행(같은방향)",bf:{c:70,p:30},
  mods:[{n:"야간",v:5,tg:"p"},{n:"음주보행",v:10,tg:"p"}],
  kw:["차도","보행","같은","방향","걷다","보행자"],la:"차량",lb:"보행자",
  patterns:[{w:["차도","보행","같은","방향"],wt:25,req:"all"},{w:["차도","걷다","보행자"],wt:20,req:"all"}]},
{id:"보16",cat:"차대사람",sub:"기타",t:"차도 보행(반대방향)",bf:{c:60,p:40},mods:[],
  kw:["차도","보행","반대","방향","걷다","보행자","대향"],la:"차량",lb:"보행자",
  patterns:[{w:["차도","보행","반대","방향"],wt:25,req:"all"}]},
{id:"보17",cat:"차대사람",sub:"기타",t:"갓길(노견) 보행자 충격",bf:{c:85,p:15},mods:[],
  kw:["갓길","노견","보행자","충격","어깨"],la:"차량",lb:"보행자",
  patterns:[{w:["갓길","보행자"],wt:30,req:"all"},{w:["노견","보행자"],wt:25,req:"all"}]},
{id:"보18",cat:"차대사람",sub:"기타",t:"중앙분리대 있는 도로 무단횡단",bf:{a:30,p:70},mods:[],
  kw:["중앙분리대","무단","횡단","보행자","넘어"],la:"차량",lb:"보행자",
  patterns:[{w:["중앙분리대","무단","횡단"],wt:30,req:"all"}]},
{id:"보19",cat:"차대사람",sub:"기타",t:"도로공사 현장 보행자 사고",bf:{c:70,p:30},mods:[],
  kw:["공사","현장","보행자","도로","작업"],la:"차량",lb:"보행자",
  patterns:[{w:["도로","공사","보행자"],wt:25,req:"all"}]},
{id:"보20",cat:"차대사람",sub:"기타",t:"주차장 내 보행자 사고",bf:{c:80,p:20},mods:[],
  kw:["주차장","보행자","통로","충돌"],la:"차량",lb:"보행자",
  patterns:[{w:["주차장","보행자"],wt:30,req:"all"}]},
{id:"보21",cat:"차대사람",sub:"기타",t:"고속도로 보행자 사고",bf:{c:30,p:70},mods:[],
  kw:["고속도로","보행자","횡단","무단"],la:"차량",lb:"보행자",
  patterns:[{w:["고속도로","보행자"],wt:30,req:"all"}]},
{id:"보22",cat:"차대사람",sub:"기타",t:"보행자 차도 급진입(뛰어들기)",bf:{c:30,p:70},
  mods:[{n:"어린이",v:-15,tg:"p"},{n:"과속",v:5,tg:"c"}],
  kw:["뛰어들기","급진입","차도","보행자","갑자기"],la:"차량",lb:"보행자",
  patterns:[{w:["뛰어들기","차도"],wt:30,req:"all"},{w:["갑자기","차도","보행자"],wt:25,req:"all"}]},
{id:"보23",cat:"차대사람",sub:"기타",t:"교차로 횡단 보행자(신호없음)",bf:{c:70,p:30},mods:[],
  kw:["교차로","횡단","보행자","무신호"],la:"차량",lb:"보행자",
  patterns:[{w:["교차로","횡단","보행자","무신호"],wt:25,req:"all"}]},
{id:"보24",cat:"차대사람",sub:"기타",t:"보행자 음주 무단횡단",bf:{c:30,p:70},mods:[],
  kw:["음주","보행자","무단","횡단","술"],la:"차량",lb:"보행자",
  patterns:[{w:["음주","보행자","횡단"],wt:25,req:"all"},{w:["술","무단","횡단"],wt:20,req:"all"}]},
{id:"보25",cat:"차대사람",sub:"기타",t:"어린이보호구역 내 보행자",bf:{c:90,p:10},
  mods:[{n:"과속",v:5,tg:"c"}],
  kw:["어린이","보호구역","스쿨존","보행자","어린이"],la:"차량",lb:"어린이",
  patterns:[{w:["어린이","보호구역","보행자"],wt:30,req:"all"},{w:["스쿨존","보행자"],wt:25,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 10: 차대자전거/이륜차                도표 거1~거20
// ══════════════════════════════════════════════════════════════════
{id:"거1",cat:"차대자전거",sub:"교차로",t:"직진차 vs 자전거 횡단",bf:{a:70,b:30},
  mods:[{n:"과속",v:5,tg:"a"},{n:"자전거 신호위반",v:10,tg:"b"}],
  kw:["직진","자전거","횡단","교차로","자전거도로"],la:"직진차",lb:"자전거",
  patterns:[{w:["직진","자전거","횡단"],wt:30,req:"all"},{w:["자전거","교차로"],wt:20,req:"all"}]},
{id:"거2",cat:"차대자전거",sub:"동행",t:"추돌 자전거",bf:{a:90,b:10},
  mods:[{n:"야간",v:5,tg:"b"},{n:"자전거 무등화",v:5,tg:"b"}],
  kw:["자전거","추돌","후방","충돌","같은방향"],la:"차량",lb:"자전거",
  patterns:[{w:["자전거","추돌"],wt:35,req:"all"}]},
{id:"거3",cat:"차대자전거",sub:"동행",t:"차선변경 vs 자전거",bf:{a:85,b:15},mods:[],
  kw:["차선변경","자전거","측면","충돌"],la:"차량",lb:"자전거",
  patterns:[{w:["차선변경","자전거"],wt:35,req:"all"}]},
{id:"거4",cat:"차대자전거",sub:"기타",t:"문열기 vs 자전거",bf:{a:10,b:90},
  mods:[{n:"자전거 전조등 미사용",v:5,tg:"b"}],
  kw:["문","열기","자전거","도어링","도어"],la:"자전거",lb:"문열기차",
  patterns:[{w:["문","열기","자전거"],wt:40,req:"all"},{w:["도어","자전거"],wt:30,req:"all"}]},
{id:"거5",cat:"차대자전거",sub:"교차로",t:"우회전 vs 자전거 직진",bf:{a:80,b:20},mods:[],
  kw:["우회전","자전거","직진","교차로"],la:"우회전차",lb:"자전거",
  patterns:[{w:["우회전","자전거","직진"],wt:30,req:"all"}]},
{id:"거6",cat:"차대자전거",sub:"교차로",t:"좌회전 vs 자전거 직진",bf:{a:80,b:20},mods:[],
  kw:["좌회전","자전거","직진","교차로"],la:"좌회전차",lb:"자전거",
  patterns:[{w:["좌회전","자전거","직진"],wt:30,req:"all"}]},
{id:"거7",cat:"차대자전거",sub:"기타",t:"자전거도로 역주행 자전거",bf:{a:40,b:60},mods:[],
  kw:["자전거도로","역주행","자전거","반대"],la:"차량",lb:"역주행자전거",
  patterns:[{w:["자전거도로","역주행"],wt:30,req:"all"},{w:["자전거","역주행"],wt:25,req:"all"}]},
{id:"거8",cat:"차대자전거",sub:"기타",t:"자전거 차도 주행 추돌",bf:{a:80,b:20},mods:[],
  kw:["자전거","차도","주행","추돌"],la:"차량",lb:"자전거",
  patterns:[{w:["자전거","차도","추돌"],wt:25,req:"all"}]},
{id:"거9",cat:"차대자전거",sub:"기타",t:"자전거 보도 주행 vs 보행자",bf:{a:0,b:100},mods:[],
  kw:["자전거","보도","보행자","인도","충돌"],la:"보행자",lb:"자전거",
  patterns:[{w:["자전거","보도","보행자"],wt:30,req:"all"},{w:["자전거","인도","보행자"],wt:25,req:"all"}]},
{id:"거10",cat:"차대자전거",sub:"교차로",t:"무신호 교차로 직진차 vs 자전거",bf:{a:60,b:40},mods:[],
  kw:["무신호","교차로","자전거","직진"],la:"직진차",lb:"자전거",
  patterns:[{w:["무신호","교차로","자전거"],wt:25,req:"all"}]},
{id:"거11",cat:"차대자전거",sub:"기타",t:"PM(전동킥보드) vs 차량",bf:{a:60,b:40},
  mods:[{n:"PM 차도주행",v:5,tg:"b"},{n:"PM 보도주행",v:10,tg:"b"},{n:"PM 안전모미착용",v:5,tg:"b"}],
  kw:["전동킥보드","PM","킥보드","전동","개인형이동장치"],la:"차량",lb:"PM",
  patterns:[{w:["전동킥보드","충돌"],wt:30,req:"all"},{w:["PM","충돌"],wt:25,req:"all"},{w:["킥보드","사고"],wt:25,req:"all"}]},
{id:"거12",cat:"차대자전거",sub:"기타",t:"PM(전동킥보드) vs 보행자",bf:{a:0,b:100},mods:[],
  kw:["전동킥보드","보행자","PM","인도","보도"],la:"보행자",lb:"PM",
  patterns:[{w:["전동킥보드","보행자"],wt:30,req:"all"},{w:["킥보드","보행자"],wt:25,req:"all"}]},
{id:"거13",cat:"차대자전거",sub:"기타",t:"후진차 vs 자전거",bf:{a:90,b:10},mods:[],
  kw:["후진","자전거","충돌"],la:"후진차",lb:"자전거",
  patterns:[{w:["후진","자전거"],wt:30,req:"all"}]},
{id:"거14",cat:"차대자전거",sub:"합류",t:"도로 진입차 vs 자전거도로 자전거",bf:{a:90,b:10},mods:[],
  kw:["도로","진입","자전거도로","자전거","합류"],la:"진입차",lb:"자전거",
  patterns:[{w:["진입","자전거도로","자전거"],wt:30,req:"all"}]},
{id:"거15",cat:"차대자전거",sub:"기타",t:"이륜차(오토바이) vs 차량 측면충돌",bf:{a:40,b:60},mods:[],
  kw:["이륜차","오토바이","측면","충돌","바이크"],la:"차량",lb:"이륜차",
  patterns:[{w:["이륜차","측면","충돌"],wt:25,req:"all"},{w:["오토바이","측면"],wt:20,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 11: 차대차 — 교차로 추가              도표 119~130
// ══════════════════════════════════════════════════════════════════
{id:"119",cat:"차대차",sub:"교차로",t:"녹색좌회전 vs 황색좌회전(대향)",bf:{a:20,b:80},mods:[],
  kw:["녹색","좌회전","황색","대향","교차로"],la:"녹색좌회전",lb:"황색좌회전",
  patterns:[{w:["녹색","좌회전","황색","좌회전"],wt:30,req:"all"}]},
{id:"120",cat:"차대차",sub:"교차로",t:"적색 좌회전 vs 녹색 직진",bf:{a:100,b:0},mods:[],
  kw:["적색","좌회전","녹색","직진","교차로","신호위반"],la:"적색좌회전",lb:"녹색직진",
  patterns:[{w:["적색","좌회전","녹색","직진"],wt:35,req:"all"}]},
{id:"121",cat:"차대차",sub:"교차로",t:"직진신호 직진 vs 좌회전신호 좌회전",bf:{a:50,b:50},
  mods:[{n:"선진입",v:-10,tg:"a"}],
  kw:["직진","신호","좌회전","교차로"],la:"직진신호",lb:"좌회전신호",
  patterns:[{w:["직진","신호","좌회전","신호"],wt:25,req:"all"}]},
{id:"122",cat:"차대차",sub:"교차로",t:"녹색 우회전 vs 녹색 좌회전(대향)",bf:{a:40,b:60},mods:[],
  kw:["녹색","우회전","좌회전","대향","교차로"],la:"녹색우회전",lb:"녹색좌회전",
  patterns:[{w:["녹색","우회전","녹색","좌회전"],wt:25,req:"all"}]},
{id:"123",cat:"차대차",sub:"교차로",t:"비보호좌회전 vs 비보호좌회전(대향)",bf:{a:50,b:50},mods:[],
  kw:["비보호","좌회전","대향","양쪽","교차로"],la:"비보호좌A",lb:"비보호좌B",
  patterns:[{w:["비보호","좌회전","대향","좌회전"],wt:25,req:"all"}]},
{id:"124",cat:"차대차",sub:"교차로",t:"녹색 직진 vs 녹색 우회전(동일방향)",bf:{a:30,b:70},mods:[],
  kw:["녹색","직진","우회전","동일","방향","교차로"],la:"녹색직진",lb:"녹색우회전",
  patterns:[{w:["녹색","직진","우회전","동일"],wt:25,req:"all"}]},
{id:"125",cat:"차대차",sub:"교차로",t:"양쪽 황색 직진",bf:{a:50,b:50},mods:[],
  kw:["양쪽","황색","직진","교차로"],la:"황색직진A",lb:"황색직진B",
  patterns:[{w:["양쪽","황색","직진"],wt:30,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 12: 차대차 — 무신호 교차로 추가       도표 217~228
// ══════════════════════════════════════════════════════════════════
{id:"217",cat:"차대차",sub:"교차로",t:"무신호 동일폭 양쪽 좌회전",bf:{a:50,b:50},mods:[],
  kw:["무신호","동일","양쪽","좌회전","교차로"],la:"좌회전A",lb:"좌회전B",
  patterns:[{w:["무신호","양쪽","좌회전"],wt:25,req:"all"}]},
{id:"218",cat:"차대차",sub:"교차로",t:"무신호 소로 직진 vs 소로 직진",bf:{a:40,b:60},
  mods:[{n:"우측차 우선",v:-10,tg:"b"}],
  kw:["무신호","소로","직진","양쪽","교차로"],la:"좌측소로",lb:"우측소로",
  patterns:[{w:["무신호","소로","직진","소로"],wt:25,req:"all"}]},
{id:"219",cat:"차대차",sub:"교차로",t:"무신호 T자로 우회전 vs 직진",bf:{a:40,b:60},mods:[],
  kw:["무신호","T자","우회전","직진","교차로"],la:"우회전",lb:"직진",
  patterns:[{w:["무신호","T자","우회전","직진"],wt:25,req:"all"}]},
{id:"220",cat:"차대차",sub:"교차로",t:"무신호 Y자로 충돌",bf:{a:50,b:50},mods:[],
  kw:["무신호","Y자","교차로","충돌","갈림길"],la:"A차",lb:"B차",
  patterns:[{w:["Y자","교차로"],wt:25,req:"all"},{w:["갈림길","충돌"],wt:20,req:"all"}]},
{id:"221",cat:"차대차",sub:"교차로",t:"무신호 대로 우회전 vs 소로 직진",bf:{a:30,b:70},mods:[],
  kw:["무신호","대로","우회전","소로","직진"],la:"대로우회전",lb:"소로직진",
  patterns:[{w:["대로","우회전","소로","직진"],wt:25,req:"all"}]},
{id:"222",cat:"차대차",sub:"교차로",t:"무신호 5지 이상 교차로",bf:{a:50,b:50},mods:[],
  kw:["무신호","5지","다지","교차로","복잡"],la:"A차",lb:"B차",
  patterns:[{w:["5지","교차로"],wt:20,req:"all"},{w:["다지","교차로"],wt:20,req:"all"}]},
{id:"223",cat:"차대차",sub:"교차로",t:"무신호 우측차 우선 (좌측차 선진입)",bf:{a:30,b:70},
  mods:[{n:"좌측차 명확한 선진입",v:-10,tg:"a"}],
  kw:["무신호","우측","우선","선진입","좌측","교차로"],la:"좌측차(선진입)",lb:"우측차",
  patterns:[{w:["무신호","우측","우선","선진입"],wt:25,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 13: 차대차 — 대향 추가               도표 311~318
// ══════════════════════════════════════════════════════════════════
{id:"311",cat:"차대차",sub:"대향",t:"중앙선 침범(도로공사 등 장애물 회피)",bf:{a:30,b:70},mods:[],
  kw:["중앙선","침범","공사","장애물","회피","대향"],la:"직진차",lb:"장애물회피차",
  patterns:[{w:["중앙선","침범","장애물","회피"],wt:25,req:"all"},{w:["중앙선","공사","회피"],wt:20,req:"all"}]},
{id:"312",cat:"차대차",sub:"대향",t:"좌회전 vs 유턴(대향)",bf:{a:40,b:60},mods:[],
  kw:["좌회전","유턴","대향","맞은편"],la:"좌회전",lb:"유턴차",
  patterns:[{w:["좌회전","유턴","대향"],wt:25,req:"all"}]},
{id:"313",cat:"차대차",sub:"대향",t:"좁은 도로 대향 교행(비양보)",bf:{a:50,b:50},mods:[],
  kw:["좁은","도로","대향","교행","양보","비양보"],la:"A차",lb:"B차",
  patterns:[{w:["좁은","도로","대향","교행"],wt:25,req:"all"}]},
{id:"314",cat:"차대차",sub:"대향",t:"중앙선 침범(졸음운전)",bf:{a:0,b:100},mods:[],
  kw:["중앙선","침범","졸음","운전","대향"],la:"직진차",lb:"졸음중앙선침범",
  patterns:[{w:["졸음","중앙선","침범"],wt:30,req:"all"}]},
{id:"315",cat:"차대차",sub:"대향",t:"중앙선 없는 도로 정면충돌",bf:{a:50,b:50},mods:[],
  kw:["중앙선","없는","도로","정면","충돌","대향"],la:"A차",lb:"B차",
  patterns:[{w:["중앙선","없는","정면","충돌"],wt:25,req:"all"}]},
{id:"316",cat:"차대차",sub:"대향",t:"유턴 vs 유턴(대향)",bf:{a:50,b:50},mods:[],
  kw:["유턴","양쪽","대향","맞은편"],la:"유턴A",lb:"유턴B",
  patterns:[{w:["유턴","유턴","대향"],wt:25,req:"all"},{w:["양쪽","유턴"],wt:20,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 14: 차대차 — 동행 추가               도표 421~435
// ══════════════════════════════════════════════════════════════════
{id:"421",cat:"차대차",sub:"동행",t:"1차로 저속주행 2차로 차선변경 충돌",bf:{a:70,b:30},mods:[],
  kw:["1차로","저속","2차로","차선변경","추월","충돌"],la:"차선변경차",lb:"직진차",
  patterns:[{w:["1차로","저속","차선변경"],wt:25,req:"all"}]},
{id:"422",cat:"차대차",sub:"동행",t:"버스 정류장 출발 vs 직진",bf:{a:60,b:40},mods:[],
  kw:["버스","정류장","출발","직진","합류"],la:"버스출발",lb:"직진차",
  patterns:[{w:["버스","정류장","출발","직진"],wt:30,req:"all"}]},
{id:"423",cat:"차대차",sub:"동행",t:"택시 급정차(승객하차) 추돌",bf:{a:30,b:70},mods:[],
  kw:["택시","급정차","승객","하차","추돌"],la:"택시",lb:"후행차",
  patterns:[{w:["택시","급정차","추돌"],wt:30,req:"all"},{w:["택시","승객","하차","추돌"],wt:25,req:"all"}]},
{id:"424",cat:"차대차",sub:"동행",t:"화물차 사각지대 차선변경",bf:{a:80,b:20},mods:[],
  kw:["화물차","사각지대","차선변경","대형","트럭"],la:"화물차",lb:"피해차",
  patterns:[{w:["화물차","사각지대","차선변경"],wt:25,req:"all"},{w:["대형","사각","차선변경"],wt:20,req:"all"}]},
{id:"425",cat:"차대차",sub:"동행",t:"앞지르기 완료 후 급차선복귀",bf:{a:70,b:30},mods:[],
  kw:["앞지르기","급","차선","복귀","끼어들기"],la:"급복귀차",lb:"후행차",
  patterns:[{w:["앞지르기","급","복귀"],wt:25,req:"all"}]},
{id:"426",cat:"차대차",sub:"동행",t:"고속도로 1차로 저속주행 추돌",bf:{a:20,b:80},mods:[],
  kw:["고속도로","1차로","저속","추돌","앞차"],la:"저속차",lb:"후행차",
  patterns:[{w:["고속도로","1차로","저속","추돌"],wt:25,req:"all"}]},
{id:"427",cat:"차대차",sub:"동행",t:"끼어들기 거부 접촉사고",bf:{a:40,b:60},mods:[],
  kw:["끼어들기","거부","접촉","차선변경","방어"],la:"직진차(거부)",lb:"끼어들기차",
  patterns:[{w:["끼어들기","거부","접촉"],wt:25,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 15: 차대차 — 합류/고속도로 추가      도표 507~515, 557~562
// ══════════════════════════════════════════════════════════════════
{id:"507",cat:"차대차",sub:"합류",t:"주유소/편의점 진출 vs 직진",bf:{a:80,b:20},mods:[],
  kw:["주유소","편의점","진출","직진","도로"],la:"진출차",lb:"직진차",
  patterns:[{w:["주유소","진출","직진"],wt:25,req:"all"},{w:["편의점","진출","도로"],wt:20,req:"all"}]},
{id:"508",cat:"차대차",sub:"합류",t:"이면도로에서 대로 진입",bf:{a:80,b:20},mods:[],
  kw:["이면","도로","대로","진입","골목"],la:"이면도로차",lb:"대로차",
  patterns:[{w:["이면","도로","대로","진입"],wt:25,req:"all"},{w:["골목","대로","진입"],wt:20,req:"all"}]},
{id:"509",cat:"차대차",sub:"합류",t:"아파트단지 내 도로 진출 vs 직진",bf:{a:70,b:30},mods:[],
  kw:["아파트","단지","진출","직진","도로"],la:"진출차",lb:"직진차",
  patterns:[{w:["아파트","단지","진출"],wt:25,req:"all"}]},
{id:"557",cat:"차대차",sub:"고속도로",t:"고속도로 터널 내 추돌",bf:{a:10,b:90},
  mods:[{n:"안전거리미확보",v:5,tg:"b"}],
  kw:["고속도로","터널","추돌","어두운"],la:"선행차",lb:"후행차",
  patterns:[{w:["고속도로","터널","추돌"],wt:30,req:"all"}]},
{id:"558",cat:"차대차",sub:"고속도로",t:"고속도로 사고 후 2차사고",bf:{a:20,b:80},
  mods:[{n:"안전조치불이행(1차)",v:10,tg:"a"}],
  kw:["고속도로","2차","사고","연쇄","후속"],la:"1차사고차",lb:"2차추돌차",
  patterns:[{w:["고속도로","2차","사고"],wt:25,req:"all"},{w:["2차","추돌","사고"],wt:20,req:"all"}]},
{id:"559",cat:"차대차",sub:"고속도로",t:"고속도로 낙하물 사고",bf:{a:0,b:100},mods:[],
  kw:["고속도로","낙하물","적재물","떨어진"],la:"후행차",lb:"낙하물차",
  patterns:[{w:["고속도로","낙하물"],wt:30,req:"all"},{w:["고속도로","적재물","떨어진"],wt:25,req:"all"}]},
{id:"560",cat:"차대차",sub:"고속도로",t:"고속도로 안개구간 다중추돌",bf:{a:30,b:70},mods:[],
  kw:["고속도로","안개","다중","추돌","시야"],la:"선행차",lb:"후행차",
  patterns:[{w:["고속도로","안개","추돌"],wt:25,req:"all"},{w:["안개","다중","추돌"],wt:20,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 16: 차대차 — 기타 추가               도표 619~635
// ══════════════════════════════════════════════════════════════════
{id:"619",cat:"차대차",sub:"기타",t:"세차장/자동세차기 접촉",bf:{a:50,b:50},mods:[],
  kw:["세차","자동","세차기","접촉","세차장"],la:"A차",lb:"B차",
  patterns:[{w:["세차","접촉"],wt:20,req:"all"}]},
{id:"620",cat:"차대차",sub:"기타",t:"견인차 견인 중 사고",bf:{a:30,b:70},mods:[],
  kw:["견인","견인차","사고","끌려가는","로프"],la:"견인차",lb:"후행차",
  patterns:[{w:["견인","사고"],wt:20,req:"all"}]},
{id:"621",cat:"차대차",sub:"기타",t:"비포장도로 충돌",bf:{a:50,b:50},mods:[],
  kw:["비포장","도로","충돌","흙길","자갈"],la:"A차",lb:"B차",
  patterns:[{w:["비포장","도로","충돌"],wt:20,req:"all"}]},
{id:"622",cat:"차대차",sub:"기타",t:"언덕 정상부 충돌",bf:{a:50,b:50},mods:[],
  kw:["언덕","정상","충돌","오르막","내리막","고개"],la:"A차",lb:"B차",
  patterns:[{w:["언덕","정상","충돌"],wt:20,req:"all"},{w:["고개","정상","충돌"],wt:15,req:"all"}]},
{id:"623",cat:"차대차",sub:"기타",t:"좁은골목 후진차 vs 직진차",bf:{a:70,b:30},mods:[],
  kw:["골목","후진","직진","좁은","이면"],la:"후진차",lb:"직진차",
  patterns:[{w:["골목","후진","직진"],wt:25,req:"all"}]},
{id:"624",cat:"차대차",sub:"기타",t:"주차장 만차시 대기 충돌",bf:{a:50,b:50},mods:[],
  kw:["주차장","만차","대기","충돌","기다리다"],la:"A차",lb:"B차",
  patterns:[{w:["주차장","만차","충돌"],wt:20,req:"all"}]},
{id:"625",cat:"차대차",sub:"기타",t:"무인정산기 앞 접촉",bf:{a:50,b:50},mods:[],
  kw:["무인","정산기","접촉","톨게이트","요금소"],la:"A차",lb:"B차",
  patterns:[{w:["정산기","접촉"],wt:20,req:"all"},{w:["톨게이트","접촉"],wt:15,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 17: 차대사람 추가                     도표 보26~보35
// ══════════════════════════════════════════════════════════════════
{id:"보26",cat:"차대사람",sub:"기타",t:"주차장 진출입로 보행자",bf:{c:80,p:20},mods:[],
  kw:["주차장","진출입","보행자","입구","출구"],la:"차량",lb:"보행자",
  patterns:[{w:["주차장","진출입","보행자"],wt:25,req:"all"}]},
{id:"보27",cat:"차대사람",sub:"기타",t:"아파트단지 내 보행자",bf:{c:80,p:20},mods:[],
  kw:["아파트","단지","보행자","주거","단지내"],la:"차량",lb:"보행자",
  patterns:[{w:["아파트","단지","보행자"],wt:25,req:"all"}]},
{id:"보28",cat:"차대사람",sub:"기타",t:"교통섬(안전지대) 보행자",bf:{c:80,p:20},mods:[],
  kw:["교통섬","안전지대","보행자","대기"],la:"차량",lb:"보행자",
  patterns:[{w:["교통섬","보행자"],wt:25,req:"all"},{w:["안전지대","보행자"],wt:20,req:"all"}]},
{id:"보29",cat:"차대사람",sub:"횡단보도",t:"비보호 우회전 vs 횡단보도 보행자",bf:{c:90,p:10},mods:[],
  kw:["비보호","우회전","횡단보도","보행자"],la:"우회전차",lb:"보행자",
  patterns:[{w:["비보호","우회전","횡단보도","보행자"],wt:30,req:"all"}]},
{id:"보30",cat:"차대사람",sub:"기타",t:"차도에 누워있는 보행자 사고",bf:{c:50,p:50},mods:[],
  kw:["차도","누워","보행자","쓰러진","도로"],la:"차량",lb:"보행자",
  patterns:[{w:["차도","누워","보행자"],wt:25,req:"all"},{w:["쓰러진","도로","보행자"],wt:20,req:"all"}]},
{id:"보31",cat:"차대사람",sub:"기타",t:"실버존(노인보호구역) 보행자",bf:{c:90,p:10},mods:[],
  kw:["실버존","노인","보호구역","보행자","어르신"],la:"차량",lb:"노인",
  patterns:[{w:["실버존","보행자"],wt:25,req:"all"},{w:["노인","보호구역","보행자"],wt:20,req:"all"}]},

// ══════════════════════════════════════════════════════════════════
//  PART 18: 차대자전거/이륜/PM 추가          도표 거16~거25
// ══════════════════════════════════════════════════════════════════
{id:"거16",cat:"차대자전거",sub:"교차로",t:"좌회전차 vs 자전거 횡단(무신호)",bf:{a:70,b:30},mods:[],
  kw:["좌회전","자전거","횡단","무신호","교차로"],la:"좌회전차",lb:"자전거",
  patterns:[{w:["좌회전","자전거","횡단","무신호"],wt:25,req:"all"}]},
{id:"거17",cat:"차대자전거",sub:"기타",t:"주차장 내 자전거 사고",bf:{a:70,b:30},mods:[],
  kw:["주차장","자전거","충돌","통로"],la:"차량",lb:"자전거",
  patterns:[{w:["주차장","자전거"],wt:25,req:"all"}]},
{id:"거18",cat:"차대자전거",sub:"기타",t:"전동킥보드 역주행 vs 차량",bf:{a:30,b:70},mods:[],
  kw:["전동킥보드","역주행","PM","반대","차량"],la:"차량",lb:"역주행PM",
  patterns:[{w:["전동킥보드","역주행"],wt:30,req:"all"},{w:["PM","역주행"],wt:25,req:"all"}]},
{id:"거19",cat:"차대자전거",sub:"기타",t:"전동킥보드 무단횡단",bf:{a:40,b:60},mods:[],
  kw:["전동킥보드","무단","횡단","PM","차도"],la:"차량",lb:"PM무단횡단",
  patterns:[{w:["전동킥보드","무단","횡단"],wt:25,req:"all"},{w:["킥보드","무단","횡단"],wt:20,req:"all"}]},
{id:"거20",cat:"차대자전거",sub:"기타",t:"오토바이 과속 vs 차량 우회전",bf:{a:40,b:60},mods:[],
  kw:["오토바이","과속","우회전","이륜","차량"],la:"우회전차",lb:"과속오토바이",
  patterns:[{w:["오토바이","과속","우회전"],wt:25,req:"all"}]},
{id:"거21",cat:"차대자전거",sub:"동행",t:"오토바이 차량 사이 빠져나가기(레인스플리팅)",bf:{a:30,b:70},mods:[],
  kw:["오토바이","사이","빠져나가","레인","스플리팅","이륜"],la:"차량",lb:"빠져나가는오토바이",
  patterns:[{w:["오토바이","사이","빠져나가"],wt:25,req:"all"},{w:["레인","스플리팅"],wt:20,req:"all"}]},
{id:"거22",cat:"차대자전거",sub:"교차로",t:"신호위반 오토바이 vs 녹색직진",bf:{a:0,b:100},mods:[],
  kw:["신호위반","오토바이","녹색","직진","교차로"],la:"녹색직진",lb:"신호위반오토바이",
  patterns:[{w:["신호위반","오토바이","녹색","직진"],wt:30,req:"all"}]},
{id:"거23",cat:"차대자전거",sub:"기타",t:"배달오토바이 과속 추돌",bf:{a:20,b:80},mods:[],
  kw:["배달","오토바이","과속","추돌","배달원"],la:"차량",lb:"배달오토바이",
  patterns:[{w:["배달","오토바이","추돌"],wt:25,req:"all"},{w:["배달","과속","추돌"],wt:20,req:"all"}]},
{id:"거24",cat:"차대자전거",sub:"기타",t:"자전거 2인 탑승 사고",bf:{a:60,b:40},mods:[],
  kw:["자전거","2인","탑승","사고","동승"],la:"차량",lb:"2인자전거",
  patterns:[{w:["자전거","2인","탑승"],wt:20,req:"all"}]},
{id:"거25",cat:"차대자전거",sub:"기타",t:"전동휠/전동보드 vs 차량",bf:{a:50,b:50},mods:[],
  kw:["전동휠","전동보드","원휠","PM","차량"],la:"차량",lb:"전동휠/보드",
  patterns:[{w:["전동휠","차량"],wt:20,req:"all"},{w:["전동보드","차량"],wt:20,req:"all"}]},

// ══════ 추가 도표 (200개 완성) ══════
{id:"126",cat:"차대차",sub:"교차로",t:"비보호우회전 vs 직진(대향)",bf:{a:60,b:40},mods:[],
  kw:["비보호","우회전","직진","대향","교차로"],la:"비보호우회전",lb:"직진차",
  patterns:[{w:["비보호","우회전","직진"],wt:25,req:"all"}]},
{id:"317",cat:"차대차",sub:"대향",t:"불법유턴 vs 좌회전(대향)",bf:{a:70,b:30},mods:[],
  kw:["불법","유턴","좌회전","대향"],la:"불법유턴",lb:"좌회전차",
  patterns:[{w:["불법","유턴","좌회전"],wt:25,req:"all"}]},
{id:"428",cat:"차대차",sub:"동행",t:"차선변경 시도 중 원래차로 복귀 충돌",bf:{a:60,b:40},mods:[],
  kw:["차선변경","시도","복귀","충돌","원래"],la:"복귀차",lb:"후행차",
  patterns:[{w:["차선변경","복귀","충돌"],wt:25,req:"all"}]},
{id:"510",cat:"차대차",sub:"합류",t:"골목에서 후진 진출 vs 직진",bf:{a:90,b:10},mods:[],
  kw:["골목","후진","진출","직진","뒤로"],la:"후진진출",lb:"직진차",
  patterns:[{w:["골목","후진","진출","직진"],wt:25,req:"all"}]},
{id:"561",cat:"차대차",sub:"고속도로",t:"고속도로 갓길 주행 충돌",bf:{a:80,b:20},mods:[],
  kw:["고속도로","갓길","주행","충돌","노견"],la:"갓길주행차",lb:"직진차",
  patterns:[{w:["고속도로","갓길","주행","충돌"],wt:25,req:"all"}]},
{id:"626",cat:"차대차",sub:"기타",t:"스쿨존 내 차대차 사고",bf:{a:50,b:50},
  mods:[{n:"과속",v:10,tg:"a"},{n:"과속",v:10,tg:"b"}],
  kw:["스쿨존","어린이","보호구역","차대차"],la:"A차",lb:"B차",
  patterns:[{w:["스쿨존","차대차"],wt:20,req:"all"},{w:["어린이","보호구역","차"],wt:15,req:"all"}]},
{id:"보32",cat:"차대사람",sub:"기타",t:"공영주차장 내 보행자",bf:{c:80,p:20},mods:[],
  kw:["공영","주차장","보행자","지하","충돌"],la:"차량",lb:"보행자",
  patterns:[{w:["공영","주차장","보행자"],wt:20,req:"all"}]},
{id:"보33",cat:"차대사람",sub:"횡단보도",t:"자전거 횡단도 보행자 충돌",bf:{c:70,p:30},mods:[],
  kw:["자전거","횡단도","보행자","횡단","자전거도로"],la:"차량",lb:"보행자",
  patterns:[{w:["자전거","횡단도","보행자"],wt:20,req:"all"}]},
{id:"거26",cat:"차대자전거",sub:"기타",t:"공유자전거(따릉이) vs 차량",bf:{a:60,b:40},mods:[],
  kw:["공유","자전거","따릉이","공유자전거","차량"],la:"차량",lb:"공유자전거",
  patterns:[{w:["공유","자전거","차량"],wt:20,req:"all"},{w:["따릉이","충돌"],wt:20,req:"all"}]}
];

/* ╔══════════════════════════════════════════════════════════════╗
   ║  LAYER 2 — ENGINE (데이터 기반 분석 엔진)                    ║
   ║  매칭 · 수정요소 감지 · 과실비율 산정 · 법규 추출            ║
   ╚══════════════════════════════════════════════════════════════╝ */

/* ── 2-A. 도표 매칭 (패턴 기반 — if문 없음) ── */
function matchDiagram(text){
  const t=(text||'').replace(/\s+/g,' ').toLowerCase();
  if(t.length<5)return null;

  const scored=DB.map(d=>{
    let s=0;
    // (a) 기본 키워드 매칭
    d.kw.forEach(k=>{if(t.includes(k))s+=8});
    // (b) 카테고리 보너스
    if((t.includes('보행자')||t.includes('사람'))&&d.cat==='차대사람')s+=20;
    if((t.includes('자전거')||t.includes('이륜'))&&d.cat==='차대자전거')s+=20;
    // (c) 패턴 매칭 (데이터 드리븐 — 핵심!)
    (d.patterns||[]).forEach(p=>{
      if(p.req==='all'){
        if(p.w.every(w=>t.includes(w)))s+=p.wt;
      }else{
        if(p.w.some(w=>t.includes(w)))s+=p.wt;
      }
    });
    // (d) 서브카테고리 키워드 약한 보너스
    if(t.includes('교차로')&&d.sub==='교차로')s+=5;
    if(t.includes('고속도로')&&d.kw.includes('고속도로'))s+=8;
    if(t.includes('주차장')&&d.kw.includes('주차장'))s+=8;
    return{d,score:s};
  });

  scored.sort((a,b)=>b.score-a.score);
  if(scored[0].score<15)return null;
  const top=scored[0];
  return{
    match:top.d,
    confidence:top.score>=50?"상":top.score>=30?"중":"하",
    matchScore:top.score,
    alts:scored.slice(1,4).filter(x=>x.score>=15).map(x=>({id:x.d.id,t:x.d.t,score:x.score}))
  };
}

/* ── 2-B. 수정요소 감지 (데이터 드리븐) ── */
function detectMods(text){
  const t=(text||'').toLowerCase();
  return MODS_DB.filter(m=>m.keywords.some(k=>t.includes(k))).map(m=>m.name);
}

/* ── 2-C. 과실비율 산정 ── */
function calcFault(d,mods){
  let fA,fB;const isPed=d.bf.p!==undefined;
  if(isPed){fA=100-d.bf.p;fB=d.bf.p}else{fA=d.bf.a;fB=d.bf.b}
  (d.mods||[]).forEach(m=>{
    if(mods.some(am=>m.n.includes(am)||am.includes(m.n))){
      if(m.tg==='a')fA+=m.v;else if(m.tg==='b')fB+=m.v;else{if(isPed)fB+=m.v;else fA+=m.v}
    }
  });
  fA=Math.max(0,Math.min(100,fA));fB=Math.max(0,Math.min(100,fB));
  const t=fA+fB;if(t>0&&t!==100){fA=Math.round(fA/t*100);fB=100-fA}
  return{fA,fB};
}

/* ── 2-D. 관련 법규 추출 (DB 기반) ── */
function getLaws(d,text){
  const t=(text||'').toLowerCase();
  const matched=LAWS_DB.filter(l=>
    l.triggers.length===0||(l.triggers.some(tr=>t.includes(tr)))
  );
  // 카테고리별 필수 법규
  const result=[...matched];
  if(d.cat==='차대사람'&&!result.find(l=>l.id==='L10'))
    result.unshift(LAWS_DB.find(l=>l.id==='L10'));
  // 민법 750조 항상 포함
  if(!result.find(l=>l.id==='L14'))result.push(LAWS_DB.find(l=>l.id==='L14'));
  // 중복 제거 + 최대 8개
  const unique=[...new Map(result.filter(Boolean).map(l=>[l.id,l])).values()];
  return unique.slice(0,8).map(l=>({a:l.article,d:l.desc}));
}

/* ── 2-E. AI 감정서 분석 텍스트 생성 ── */
function generateAnalysis(r,input){
  const d=r.diagram;const isPed=d.cat==='차대사람';const isBike=d.cat==='차대자전거';
  const lines=[];

  // 사고 유형 분석
  lines.push(`본 건은 ${d.cat} 사고 중 "${d.sub}" 유형에 해당하며, 손해보험협회 과실비율 인정기준 도표 ${d.id}(${d.t})이 적용됩니다.`);

  // 과실 근거
  if(isPed){
    lines.push(`기본 과실비율은 차량측 ${100-d.bf.p}% : 보행자 ${d.bf.p}%입니다.`);
    if(d.bf.p===0)lines.push(`보행자가 정당한 통행권을 가진 상황으로, 차량측에 전적인 과실이 인정됩니다.`);
    else lines.push(`보행자에게도 ${d.bf.p}%의 기본 과실이 인정되는 것은 보행자의 안전주의 의무에 기인합니다.`);
  }else if(isBike){
    lines.push(`기본 과실비율은 자동차 ${d.bf.a}% : 자전거 ${d.bf.b}%입니다.`);
    lines.push(`자동차는 자전거 대비 교통약자에 해당하는 자전거에 대한 주의의무가 가중됩니다.`);
  }else{
    lines.push(`기본 과실비율은 ${r.labelA} ${d.bf.a}% : ${r.labelB} ${d.bf.b}%입니다.`);
    if(d.bf.b>=90)lines.push(`${r.labelB}측의 과실이 압도적으로 높은 것은 중대한 교통법규 위반에 기인합니다.`);
    else if(Math.abs(d.bf.a-d.bf.b)<=20)lines.push(`쌍방 과실이 비교적 균형적인 것은 양측 모두 주의의무가 있는 상황입니다.`);
  }

  // 수정요소 분석
  if(r.mods?.length>0){
    lines.push(`수정요소로 ${r.mods.join(', ')}이(가) 감지되었습니다.`);
    r.mods.forEach(m=>{
      const mdb=MODS_DB.find(x=>x.name===m);
      if(mdb)lines.push(`- ${m}: ${mdb.desc} (일반적 조정폭 ${mdb.adj>0?'+':''}${mdb.adj}%)`);
    });
    lines.push(`수정요소를 반영한 최종 과실비율은 ${r.labelA} ${r.faultA}% : ${r.labelB} ${r.faultB}%로 산정됩니다.`);
  }else{
    lines.push(`별도의 수정요소가 감지되지 않아 기본 과실비율이 최종 비율로 적용됩니다.`);
  }

  return lines.join('\n');
}

/* ╔══════════════════════════════════════════════════════════════╗
   ║  LAYER 3 — UTILITIES (PDF·OCR·영상·KB)                      ║
   ╚══════════════════════════════════════════════════════════════╝ */

/* ── PDF TEXT EXTRACTION ── */
async function extractPDFText(file,onStatus,onProgress,maxPages=20){
  if(!window.pdfjsLib)throw new Error("PDF.js 라이브러리 없음");
  onStatus?.("PDF 파일 읽는 중...");onProgress?.(5);
  const buf=await file.arrayBuffer();
  onStatus?.("PDF 파싱 중...");onProgress?.(10);
  const pdf=await window.pdfjsLib.getDocument({data:buf}).promise;
  const n=Math.min(pdf.numPages,maxPages);
  onStatus?.(`총 ${pdf.numPages}페이지 감지 (${n}페이지 처리)`);onProgress?.(15);
  let allText='';
  for(let i=1;i<=n;i++){
    onStatus?.(`페이지 ${i}/${n} 텍스트 추출...`);
    onProgress?.(15+Math.round((i/n)*80));
    const page=await pdf.getPage(i);
    const tc=await page.getTextContent();
    const pt=tc.items.map(it=>it.str).join(' ');
    if(pt.trim())allText+=`\n[p${i}] ${pt.trim()}`;
  }
  onProgress?.(98);
  return{text:allText.trim(),totalPages:pdf.numPages,extracted:n};
}

/* ── PDF → Image for OCR fallback ── */
async function renderPDFToImages(file,onStatus,onProgress,maxPages=5){
  if(!window.pdfjsLib)throw new Error("PDF.js 없음");
  const buf=await file.arrayBuffer();
  const pdf=await window.pdfjsLib.getDocument({data:buf}).promise;
  const n=Math.min(pdf.numPages,maxPages);
  const imgs=[];
  for(let i=1;i<=n;i++){
    onStatus?.(`페이지 ${i}/${n} 이미지 렌더링...`);
    onProgress?.(Math.round((i/n)*90));
    const page=await pdf.getPage(i);
    const vp=page.getViewport({scale:2});
    const cv=document.createElement('canvas');
    cv.width=vp.width;cv.height=vp.height;
    const ctx=cv.getContext('2d');
    ctx.fillStyle='#fff';ctx.fillRect(0,0,cv.width,cv.height);
    await page.render({canvasContext:ctx,viewport:vp}).promise;
    imgs.push(cv.toDataURL('image/png'));
  }
  return imgs;
}

/* ── OCR (Tesseract.js v5) ── */
function loadScript(url,timeout=15000){
  return new Promise((ok,fail)=>{
    if(document.querySelector(`script[src="${url}"]`)&&window.Tesseract){ok();return}
    const s=document.createElement('script');s.src=url;s.async=true;
    const t=setTimeout(()=>{s.remove();fail(new Error('timeout'))},timeout);
    s.onload=()=>{clearTimeout(t);setTimeout(ok,400)};s.onerror=()=>{clearTimeout(t);s.remove();fail(new Error('failed'))};
    document.head.appendChild(s);
  });
}
async function ensureTesseract(){
  if(window.Tesseract)return true;
  for(const u of["https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js","https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"]){
    try{await loadScript(u);if(window.Tesseract)return true}catch(e){}
  }
  return false;
}
function imgToCanvas(src){
  return new Promise((ok,fail)=>{
    const img=new Image();img.crossOrigin='anonymous';
    img.onload=()=>{const c=document.createElement('canvas');c.width=Math.min(img.width,2000);c.height=Math.round(img.height*(c.width/img.width));const x=c.getContext('2d');x.fillStyle='#fff';x.fillRect(0,0,c.width,c.height);x.drawImage(img,0,0,c.width,c.height);ok(c.toDataURL('image/png'))};
    img.onerror=()=>fail(new Error('이미지 로드 실패'));
    if(typeof src==='string')img.src=src;
    else{const r=new FileReader();r.onload=e=>{img.src=e.target.result};r.onerror=()=>fail(new Error('파일읽기실패'));r.readAsDataURL(src)}
  });
}
async function runOCR(imgSrc,onStatus,onProgress){
  onStatus?.("Tesseract.js 로딩...");onProgress?.(5);
  if(!await ensureTesseract())throw new Error("Tesseract.js 로딩 실패");
  onStatus?.("이미지 전처리...");onProgress?.(10);
  const du=await imgToCanvas(imgSrc);
  onStatus?.("OCR 워커 생성 + 한국어 데이터...");onProgress?.(15);
  let w;
  try{
    w=await window.Tesseract.createWorker("kor+eng",1,{logger:m=>{
      if(m.status==='loading language traineddata'){onStatus?.(`한국어 데이터 ${Math.round((m.progress||0)*100)}%`);onProgress?.(20+Math.round((m.progress||0)*35))}
      else if(m.status==='recognizing text'){onStatus?.(`텍스트 인식 ${Math.round((m.progress||0)*100)}%`);onProgress?.(60+Math.round((m.progress||0)*35))}
    }});
  }catch(e){
    try{w=await window.Tesseract.createWorker("eng",1,{})}catch(e2){throw new Error(`OCR엔진 생성 실패`)}
  }
  const r=await w.recognize(du);
  await w.terminate().catch(()=>{});
  return{text:(r?.data?.text||'').trim(),confidence:Math.round(r?.data?.confidence||0)};
}

/* ── Video Env ── */
function grabFrames(v,n,onMsg){return new Promise((ok,fail)=>{
  const d=v.duration;if(!d||!isFinite(d))return fail(new Error("영상길이 오류"));
  const cv=document.createElement('canvas'),ctx=cv.getContext('2d'),fr=[],ts=[];
  for(let i=1;i<=n;i++)ts.push(Math.max(.1,Math.min(d-.05,(d/(n+1))*i)));
  let idx=0;const sf=setTimeout(()=>ok(fr),12000);
  function nx(){if(idx>=ts.length){clearTimeout(sf);ok(fr);return}onMsg?.(`프레임 ${idx+1}/${n}`);v.currentTime=ts[idx]}
  v.onseeked=()=>{try{cv.width=v.videoWidth||640;cv.height=v.videoHeight||360;ctx.drawImage(v,0,0,cv.width,cv.height);fr.push({time:ts[idx],url:cv.toDataURL('image/jpeg',.7)})}catch(e){}idx++;nx()};
  v.onerror=()=>{clearTimeout(sf);fail(new Error("프레임 오류"))};nx();
})}
function analyzeEnv(du){return new Promise(ok=>{
  const img=new Image();img.onload=()=>{try{
    const cv=document.createElement('canvas'),ctx=cv.getContext('2d'),sw=Math.min(img.width,480),sh=Math.round(img.height*(sw/img.width));
    cv.width=sw;cv.height=sh;ctx.drawImage(img,0,0,sw,sh);const px=ctx.getImageData(0,0,sw,sh).data;
    let tb=0,dk=0,rp=0,gp=0,yp=0,rpAll=0,gpAll=0,ypAll=0,n=0;
    for(let i=0;i<px.length;i+=8){const r=px[i],g=px[i+1],b=px[i+2],l=r*.299+g*.587+b*.114;tb+=l;n++;if(l<45)dk++;
      const isRed=r>180&&g<100&&b<100,isGreen=g>180&&r<100&&b<100,isYellow=r>180&&g>150&&b<80;
      if(isRed)rpAll++;if(isGreen)gpAll++;if(isYellow)ypAll++;
      const py=Math.floor((i/4)/sw);if(py<sh*.6){if(isRed)rp++;if(isGreen)gp++;if(isYellow)yp++}}
    const avg=Math.round(tb/n),st=Math.max(3,n*.0002);
    ok({brightness:avg,isNight:avg<80||dk/n>.55,label:avg<65?"야간":avg<95?"새벽/야간":"주간",
      red:rp>st||rpAll>st*2,green:gp>st||gpAll>st*2,yellow:yp>st||ypAll>st*2,
      redCount:rpAll,greenCount:gpAll,yellowCount:ypAll})
  }catch(e){ok({brightness:128,isNight:false,label:"오류",red:false,green:false,yellow:false,redCount:0,greenCount:0,yellowCount:0})}};
  img.onerror=()=>ok({brightness:128,isNight:false,label:"오류",red:false,green:false,yellow:false,redCount:0,greenCount:0,yellowCount:0});img.src=du;
})}

/* ── GPU Server (ATLAS Pro) ── */
const GPU_MODES={local:'http://localhost:8090',cloud:localStorage.getItem('atlas_gpu_cloud_url')||'',ngrok:localStorage.getItem('atlas_gpu_ngrok_url')||''};
const GPU_MODE=localStorage.getItem('atlas_gpu_mode')||'local';
const GPU_SERVER_URL=(GPU_MODE==='cloud'?GPU_MODES.cloud:GPU_MODE==='ngrok'?GPU_MODES.ngrok:GPU_MODES.local)||'http://localhost:8090';

/* ── Supabase 판례 검색 (ATLAS Pro) ── */
async function searchPrecedentsDB(text,accidentType,max=5){
  try{
    const kw=[];
    ['차선변경','추돌','횡단보도','과속','음주','안전거리','급제동','비보호좌회전','우회전','유턴','역주행','보행자','자전거','교차로','주차장','야간','후진','중앙선침범','직진','좌회전','합류','신호위반','적색','녹색'].forEach(k=>{if(text.includes(k))kw.push(k)});
    if(kw.length===0)return[];
    let catFilter='';
    if(accidentType==='차대사람')catFilter='보행자_사고';
    else if(accidentType==='차대자전거')catFilter='이륜차_PM';
    else catFilter='교차로_사고';
    const r=await fetch(`/api/precedents`,{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({keywords:kw.slice(0,5).join(','),categories:catFilter,limit:max}),
      signal:AbortSignal.timeout(8000)});
    if(!r.ok)return[];
    const data=await r.json();
    return(data.results||[]).map(d=>({...d,matchScore:kw.filter(k=>(d.keywords||'').includes(k)).length*15+(d.fault_ratio?20:0),source:'supabase'}));
  }catch(e){console.warn('판례DB:',e.message);return[]}
}
async function callGPUServer(file,type='video'){
  try{
    const fd=new FormData();fd.append('file',file);
    const r=await fetch(`${GPU_SERVER_URL}/analyze/${type}`,{method:'POST',body:fd,headers:{'ngrok-skip-browser-warning':'1'},signal:AbortSignal.timeout(60000)});
    if(!r.ok)throw new Error(`GPU서버 ${r.status}`);
    return await r.json();
  }catch(e){console.warn('GPU서버:',e.message);return{success:false,error:e.message}}
}
async function checkGPUServer(){
  try{const r=await fetch(`${GPU_SERVER_URL}/health`,{headers:{'ngrok-skip-browser-warning':'1'},signal:AbortSignal.timeout(3000)});
    return(await r.json())?.status==='ok'}catch{return false}
}

/* ── Knowledge Base ── */
const KB_KEY='mdlabs_kb_v4';
function loadKB(){return SEC.safeJSON(KB_KEY,[])}
function saveKB(kb){SEC.safeStore(KB_KEY,kb,200)}
function parsePrecedent(rawText){
  const text=SEC.validateText(rawText,5000);
  const r={id:'P'+Date.now().toString(36)+Math.random().toString(36).slice(2,5),rawText:text.slice(0,3000),caseNumber:null,court:null,date:null,accidentType:'차대차',faultA:50,faultB:50,keywords:[],legalBasis:[],keyFacts:[],summary:'',confidence:25,verified:false,createdAt:new Date().toISOString()};
  for(const p of[/(\d{4}[가-힣]+\d{3,})/,/사건[번호:\s]*([^\n,]{5,25})/]){const m=text.match(p);if(m){r.caseNumber=m[1].trim();r.confidence+=15;break}}
  for(const c of['대법원','서울중앙지방법원','서울고등법원','수원지방법원','인천지방법원','대전지방법원','부산지방법원']){if(text.includes(c)){r.court=c;r.confidence+=10;break}}
  const dm=text.match(/(\d{4})[.\-\/년]\s*(\d{1,2})[.\-\/월]\s*(\d{1,2})/);
  if(dm){r.date=`${dm[1]}-${dm[2].padStart(2,'0')}-${dm[3].padStart(2,'0')}`;r.confidence+=5}
  if(/보행자|횡단보도.*보행/.test(text))r.accidentType='차대사람';
  else if(/자전거|이륜|오토바이/.test(text))r.accidentType='차대자전거';
  const fm=text.match(/과실[비율:\s]*(\d{1,3})\s*[:%]\s*(\d{1,3})/)||text.match(/(\d{1,3})\s*[:%대]\s*(\d{1,3})\s*(?:과실|비율)/);
  if(fm){const a=+fm[1],b=+fm[2];if(a+b>=90&&a+b<=110){r.faultA=Math.round(a/(a+b)*100);r.faultB=100-r.faultA;r.confidence+=20}}
  ['신호위반','중앙선침범','차선변경','추돌','횡단보도','과속','음주','안전거리','급제동','비보호좌회전','우회전','유턴','역주행','보행자','자전거','교차로','고속도로','주차장','야간','우천','어린이','노인','직진','좌회전','우회전','끼어들기','합류','후진'].forEach(k=>{if(text.includes(k))r.keywords.push(k)});
  if(r.keywords.length>=2)r.confidence+=10;
  const laws=new Set();let lm;const re=/(?:도로교통법|민법|자동차손해배상보장법|교통사고처리특례법)\s*제?\s*\d+조?/g;
  while((lm=re.exec(text)))laws.add(lm[0]);r.legalBasis=[...laws].slice(0,6);
  r.keyFacts=text.split(/[.。\n]/).filter(s=>s.trim().length>15&&s.length<200).filter(s=>['사고','충돌','횡단','직진','추돌','차선','신호','과실','피해'].some(k=>s.includes(k))).slice(0,4).map(s=>s.trim());
  r.summary=[r.caseNumber,r.court,r.accidentType,`${r.faultA}:${r.faultB}`].filter(Boolean).join(' · ');
  r.confidence=Math.min(95,r.confidence);return r;
}
function findSimilar(text,kb,max=5){
  if(!kb.length)return[];
  const kw=[];
  ['차선변경','추돌','횡단보도','과속','음주','안전거리','급제동','비보호좌회전','우회전','유턴','역주행','보행자','자전거','교차로','주차장','야간','후진','중앙선침범','직진','좌회전','합류'].forEach(k=>{if(text.includes(k))kw.push(k)});
  let type='차대차';if(/보행자|사람/.test(text))type='차대사람';else if(/자전거|이륜/.test(text))type='차대자전거';
  return kb.map(c=>{let s=0;if(c.accidentType===type)s+=30;(c.keywords||[]).forEach(k=>{if(kw.includes(k))s+=15});if(c.verified)s+=15;return{...c,matchScore:s}}).filter(x=>x.matchScore>=20).sort((a,b)=>b.matchScore-a.matchScore).slice(0,max);
}

/* ╔══════════════════════════════════════════════════════════════╗
   ║  LAYER 4 — UI COMPONENTS                                    ║
   ╚══════════════════════════════════════════════════════════════╝ */

const STEPS=[
  {id:"upload",icon:"📎",label:"자료 입력",desc:"텍스트·파일 확인"},
  {id:"scan",icon:"📄",label:"자료분석",desc:"PDF·이미지 텍스트 추출"},
  {id:"video",icon:"🎬",label:"영상 환경분석",desc:"주야간·신호 추출"},
  {id:"gpu",icon:"🖥️",label:"GPU 객체탐지",desc:"차량·보행자·신호 AI 탐지"},
  {id:"claude",icon:"🤖",label:"ATLAS AI 추론",desc:"1차 분석 · 도표매칭 · 과실산정"},
  {id:"match",icon:"📋",label:"엔진 비교분석",desc:"패턴매칭 검증 · 학습데이터 축적"},
  {id:"similar",icon:"🧠",label:"판례 검색",desc:"유사 판례 비교"},
  {id:"result",icon:"⚖️",label:"결과 산출",desc:"과실비율+법적근거"},
];

function AgentPipeline({stepStates}){
  const isRunning=Object.values(stepStates).some(s=>s.status==='running');
  const activeStep=STEPS.find(s=>(stepStates[s.id]||{}).status==='running');
  return<div style={{background:"rgba(8,12,24,.6)",border:"1px solid rgba(99,102,241,.1)",borderRadius:12,padding:"10px 14px",marginBottom:14}}>
    <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:8}}>
      {isRunning?<div style={{width:14,height:14,border:"2px solid #6366f140",borderTopColor:"#6366f1",borderRadius:7,animation:"spin .7s linear infinite",flexShrink:0}}/>:<div style={{width:6,height:6,borderRadius:3,background:"#1e293b",flexShrink:0}}/>}
      <span style={{fontSize:12,fontWeight:800,color:isRunning?"#c7d2fe":"#94a3b8",letterSpacing:.5}}>ATLAS AGENT</span>
      {activeStep&&<span style={{fontSize:11,color:"#a5b4fc",fontWeight:700}}>{activeStep.label}</span>}
      <span style={{fontSize:9,color:"#475569",marginLeft:"auto"}}>v8.5</span>
    </div>
    <div style={{display:"flex",gap:2,alignItems:"center"}}>
      {STEPS.map((step,i)=>{const st=stepStates[step.id]||{status:'idle'};const isRun=st.status==='running',isDone=st.status==='done',isErr=st.status==='error';
      return<React.Fragment key={step.id}>
        <div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:2}} title={`${step.label}: ${st.msg||step.desc}`}>
          <div style={{width:36,height:36,borderRadius:9,display:"flex",alignItems:"center",justifyContent:"center",fontSize:13,
            background:isDone?"rgba(16,185,129,.12)":isErr?"rgba(239,68,68,.1)":isRun?"rgba(99,102,241,.15)":"rgba(15,23,42,.4)",
            border:`1.5px solid ${isDone?"rgba(16,185,129,.3)":isErr?"rgba(239,68,68,.3)":isRun?"rgba(99,102,241,.4)":"rgba(30,41,59,.3)"}`,
            transition:"all .3s",boxShadow:isRun?"0 0 8px rgba(99,102,241,.3)":"none"}}>
            {isRun?<div style={{width:14,height:14,border:"2.5px solid #6366f140",borderTopColor:"#a5b4fc",borderRadius:7,animation:"spin .6s linear infinite"}}/>:isDone?"✅":isErr?"❌":step.icon}
          </div>
          <div style={{fontSize:10,fontWeight:isDone?700:isRun?800:500,color:isDone?"#10b981":isErr?"#ef4444":isRun?"#c7d2fe":"#475569",textAlign:"center",lineHeight:1.1}}>{step.label}</div>
        </div>
        {i<STEPS.length-1&&<div style={{width:14,height:2,background:isDone?"#10b98160":"#334155",borderRadius:1,flexShrink:0,marginTop:-8}}/>}
      </React.Fragment>})}
    </div>
    {activeStep&&stepStates[activeStep.id]?.msg&&<div style={{marginTop:6,fontSize:10,color:"#a5b4fc",fontWeight:600,textAlign:"center",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{stepStates[activeStep.id].msg}</div>}
  </div>;
}

const C={bg:"#050810",card:"rgba(12,17,30,.82)",b1:"rgba(148,163,184,.08)",b2:"rgba(148,163,184,.18)",t1:"#f1f5f9",t2:"#94a3b8",t3:"#64748b",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",emerald:"#10b981",amber:"#f59e0b",red:"#ef4444",cyan:"#06b6d4"};
const Tag=({children,color=C.indigo,sx})=><span style={{display:"inline-flex",padding:"3px 9px",borderRadius:7,fontSize:10.5,fontWeight:600,background:`${color}15`,color,border:`1px solid ${color}25`,...sx}}>{children}</span>;
const Btn=({children,onClick,primary,disabled,small,sx})=><button onClick={onClick} disabled={disabled} style={{padding:small?"6px 14px":"11px 22px",borderRadius:small?8:12,border:primary?"none":`1px solid ${C.b2}`,background:disabled?"#1e293b":primary?`linear-gradient(135deg,${C.blue},${C.violet})`:"rgba(30,41,59,.5)",color:disabled?"#475569":primary?"#fff":C.t2,fontSize:small?11:13,fontWeight:600,cursor:disabled?"not-allowed":"pointer",transition:"all .25s",...sx}}>{children}</button>;
const FBar=({la,lb,va,vb})=>{const[on,s]=useState(false);useEffect(()=>{s(false);setTimeout(()=>s(true),300)},[va,vb]);
return<div style={{margin:"12px 0"}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:5}}><span style={{fontFamily:"var(--mono)",fontWeight:800,fontSize:12,color:C.blue}}>{la} {va}%</span><span style={{fontFamily:"var(--mono)",fontWeight:800,fontSize:12,color:C.red}}>{lb} {vb}%</span></div><div style={{display:"flex",height:40,borderRadius:20,overflow:"hidden",background:"#0c1222",border:`1px solid ${C.b1}`}}><div style={{display:"flex",alignItems:"center",justifyContent:"center",background:`linear-gradient(135deg,#1d4ed8,${C.blue})`,color:"#fff",fontWeight:800,fontSize:13,fontFamily:"var(--mono)",transition:"width 1.2s cubic-bezier(.16,1,.3,1)",width:on?`${va}%`:"0%",minWidth:va>0?38:0}}>{va>8&&`${va}%`}</div><div style={{display:"flex",alignItems:"center",justifyContent:"center",background:`linear-gradient(135deg,${C.red},#b91c1c)`,color:"#fff",fontWeight:800,fontSize:13,fontFamily:"var(--mono)",transition:"width 1.2s cubic-bezier(.16,1,.3,1)",width:on?`${vb}%`:"0%",minWidth:vb>0?38:0}}>{vb>8&&`${vb}%`}</div></div></div>};

/* ╔══════════════════════════════════════════════════════════════╗
   ║  LAYER 5 — MAIN APP                                         ║
   ╚══════════════════════════════════════════════════════════════╝ */
/* ═══ 서버 API 연동 ═══ */
const API_BASE=window.location.origin;
const SESSION_ID=(()=>{let s=sessionStorage.getItem('mdl_sid');if(!s){s='s-'+Date.now()+'-'+Math.random().toString(36).slice(2,8);sessionStorage.setItem('mdl_sid',s)}return s})();

async function saveToServer(data){
  try{
    const res=await fetch(API_BASE+'/api/save',{method:'POST',headers:{'Content-Type':'application/json','X-Session-ID':SESSION_ID},body:JSON.stringify({...data,session_id:SESSION_ID})});
    if(!res.ok)return null;
    return await res.json();
  }catch(e){console.warn('서버 저장 실패:',e);return null}
}
async function sendFeedback(analysisId,isCorrect,comment){
  try{
    const res=await fetch(API_BASE+'/api/feedback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({analysis_id:analysisId,is_correct:isCorrect,comment:comment||''})});
    if(!res.ok)return null;
    return await res.json();
  }catch(e){console.warn('피드백 저장 실패:',e);return null}
}
async function savePrecedentToServer(entry,diagramId,category){
  try{
    const res=await fetch(API_BASE+'/api/precedents',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      case_number:entry.caseNumber||'',court:entry.court||'',date:entry.date||null,
      category:category||entry.accidentType||'차대차',subcategory:'',diagram_id:diagramId||null,
      fault_a:entry.faultA,fault_b:entry.faultB,keywords:entry.keywords||[],
      legal_basis:entry.legalBasis||[],key_facts:entry.keyFacts||[],
      summary:(entry.summary||entry.rawText||'').slice(0,5000),source:'user',confidence:entry.confidence||25
    })});
    if(!res.ok)return null;
    return await res.json();
  }catch(e){console.warn('판례 서버 저장 실패:',e);return null}
}
async function callClaudeAPI(text,diagramList){
  try{
    const res=await fetch(API_BASE+'/api/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,diagramList,mode:'match',sessionId:SESSION_ID})});
    if(!res.ok)return null;
    return await res.json();
  }catch(e){console.warn('ATLAS API 호출 실패:',e);return null}
}
async function callClaudeReport(analysisData){
  try{
    const res=await fetch(API_BASE+'/api/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:analysisData.input_text||'분석',mode:'report',analysisData,sessionId:SESSION_ID})});
    if(!res.ok)return null;
    return await res.json();
  }catch(e){console.warn('ATLAS AI 감정서 생성 실패:',e);return null}
}

function App(){
  const[kb,setKb]=useState(()=>loadKB());
  const[input,setInput]=useState("");
  const[files,setFiles]=useState([]);
  const[pdfText,setPdfText]=useState("");
  const[ocrResult,setOcrResult]=useState(null);
  const[vidSrc,setVidSrc]=useState(null);
  const[vidEnv,setVidEnv]=useState(null);
  const[vidFrames,setVidFrames]=useState([]);
  const vidRef=useRef(null);
  useEffect(()=>{checkGPUServer().then(ok=>{setGpuAvail(ok);if(ok)console.log('🖥️ ATLAS Pro GPU 서버 연결됨')})},[]);
  const[result,setResult]=useState(null);
  const[running,setRunning]=useState(false);
  const[page,setPage]=useState("input");
  const[showKB,setShowKB]=useState(false);
  const[showReport,setShowReport]=useState(false);
  const taRef=useRef(null);
  const[stepStates,setStepStates]=useState({});
  const[savedId,setSavedId]=useState(null);
  const[fbSent,setFbSent]=useState(false);
  const[agreed,setAgreed]=useState(false);
  const[llmResult,setLlmResult]=useState(null);
  const[llmLoading,setLlmLoading]=useState(false);
  const[gpuResult,setGpuResult]=useState(null);
  const[gpuAvail,setGpuAvail]=useState(null);
  const[gpuMode,setGpuMode]=useState(GPU_MODE);
  const setStep=(id,status,progress,msg)=>setStepStates(p=>({...p,[id]:{status,progress:progress??p[id]?.progress,msg:msg??p[id]?.msg}}));
  const resetSteps=()=>setStepStates({});
  const mx={maxWidth:900,margin:"0 auto",padding:"0 16px"};
  const stats=useMemo(()=>({total:kb.length,verified:kb.filter(c=>c.verified).length}),[kb]);
  const addToKB=(entry,diagramId,category)=>{const n=[entry,...kb];setKb(n);saveKB(n);savePrecedentToServer(entry,diagramId,category).catch(()=>{})};
  const removeFromKB=id=>{const n=kb.filter(c=>c.id!==id);setKb(n);saveKB(n)};

  function checkPDF(f){
    if(!f)return false;
    if(f.type==='application/pdf')return true;
    return(f.name||'').toLowerCase().endsWith('.pdf');
  }
  const addFiles=fl=>{
    const arr=Array.from(fl).map(f=>{
      const check=SEC.validateFile(f);
      if(!check.ok){alert(check.reason);return null}
      const pdf=checkPDF(f);
      return{file:f,name:SEC.sanitize(f.name||'unknown'),type:f.type||'',size:f.size||0,preview:null,id:Date.now()+'-'+Math.random().toString(36).slice(2),pdf};
    }).filter(Boolean);
    arr.forEach(nf=>{
      if(nf.type.startsWith('image/')){const r=new FileReader();r.onload=e=>{nf.preview=e.target.result;setFiles(p=>[...p])};r.readAsDataURL(nf.file)}
      if(nf.type.startsWith('video/')){setVidSrc(URL.createObjectURL(nf.file));setVidFrames([]);setVidEnv(null)}
    });
    setFiles(p=>[...p,...arr]);
  };

  // ═══ FULL ANALYSIS ═══
  const runAnalysis=useCallback(async()=>{
    if(running)return;
    const safeInput=SEC.validateText(input);
    const hasText=safeInput.trim().length>=5;
    const hasPDF=files.some(f=>f.pdf===true||checkPDF(f.file));
    const hasImage=files.some(f=>f.type?.startsWith('image/'));
    const hasVideo=!!vidSrc;
    if(!hasText&&!hasPDF&&!hasImage&&!hasVideo)return;
    setRunning(true);setResult(null);setPdfText("");setOcrResult(null);resetSteps();
    let combined=safeInput.trim();

    // Step 1
    setStep("upload","done",100,"입력 확인 완료"+(hasPDF?" · PDF감지":"")+(hasImage?" · 이미지":"")+(hasVideo?" · 영상":""));
    await new Promise(r=>setTimeout(r,200));

    // Step 2: PDF
    if(hasPDF){
      setStep("scan","running",0,"PDF 텍스트 직접 추출 시작...");
      const pf=files.find(f=>f.pdf===true||checkPDF(f.file));
      try{
        const pr=await extractPDFText(pf.file,msg=>setStep("scan","running",null,msg),pct=>setStep("scan","running",pct));
        if(pr.text&&pr.text.length>20){
          setPdfText(pr.text);combined=combined?combined+"\n\n[PDF 추출]\n"+pr.text:pr.text;
          setStep("scan","done",100,`${pr.text.length}자 추출 (${pr.extracted}/${pr.totalPages}페이지)`);
        }else{
          setStep("scan","running",50,"텍스트 없음 → 이미지 OCR 시도...");
          try{
            const imgs=await renderPDFToImages(pf.file,msg=>setStep("scan","running",null,msg),pct=>setStep("scan","running",50+pct*0.2));
            if(imgs.length>0&&await ensureTesseract()){
              let ocrText='';
              for(let i=0;i<imgs.length;i++){setStep("scan","running",70+Math.round((i/imgs.length)*25),`페이지 ${i+1} OCR...`);
                try{const r=await runOCR(imgs[i],null,null);if(r.text)ocrText+=`\n[p${i+1}] ${r.text}`}catch(e){}}
              if(ocrText.length>10){setPdfText(ocrText);combined+="\n\n[PDF OCR]\n"+ocrText;setStep("scan","done",100,`OCR ${ocrText.length}자 추출`)}
              else setStep("scan","done",100,"텍스트 추출 실패");
            }else{setStep("scan","done",100,"이미지 PDF — OCR 불가")}
          }catch(e2){setStep("scan","error",null,e2.message)}
        }
      }catch(e){setStep("scan","error",null,e.message)}
      await new Promise(r=>setTimeout(r,200));
    }else{setStep("scan","skip",null,"PDF 없음")}

    // Step 3: OCR
    if(hasImage){
      setStep("scan","running",0,"이미지 OCR...");
      const img=files.find(f=>f.type?.startsWith('image/'));
      try{
        const res=await runOCR(img.file,msg=>setStep("scan","running",null,msg),pct=>setStep("scan","running",pct));
        if(res.text?.length>3){setOcrResult(res);combined+="\n\n[OCR]\n"+res.text;setStep("scan","done",100,`${res.text.length}자 · 신뢰도${res.confidence}%`)}
        else setStep("scan","done",100,"텍스트 없음");
      }catch(e){setStep("scan","error",null,e.message)}
      await new Promise(r=>setTimeout(r,200));
    }else{setStep("scan","skip",null,"이미지 없음")}

    // Step 4: Video
    if(hasVideo&&vidRef.current){
      setStep("video","running",0,"프레임 추출...");
      try{
        const fr=await grabFrames(vidRef.current,10,msg=>setStep("video","running",null,msg));
        setVidFrames(fr);
        if(fr.length>0){
          const envs=[];for(let i=0;i<fr.length;i++){setStep("video","running",Math.round((i/fr.length)*80+20));envs.push(await analyzeEnv(fr[i].url))}
          const nightN=envs.filter(e=>e.isNight).length,avgBr=Math.round(envs.reduce((s,e)=>s+e.brightness,0)/envs.length);
          const env={perFrame:envs,timeOfDay:nightN>fr.length/2?"야간":"주간",avgBr,
            hasRed:envs.some(e=>e.red),hasGreen:envs.some(e=>e.green),hasYellow:envs.some(e=>e.yellow),
            redTotal:envs.reduce((s,e)=>s+(e.redCount||0),0),greenTotal:envs.reduce((s,e)=>s+(e.greenCount||0),0),
            yellowTotal:envs.reduce((s,e)=>s+(e.yellowCount||0),0)};
          setVidEnv(env);
          let et=`\n[영상환경: ${env.timeOfDay} 밝기${avgBr}]`;
          if(env.hasRed||env.hasGreen||env.hasYellow){
            et+=" 교차로 신호";
            if(env.hasRed)et+=" 적색 적색신호";
            if(env.hasGreen)et+=" 녹색 녹색신호 직진";
            if(env.hasYellow)et+=" 황색";
            if(env.hasRed&&env.hasGreen)et+=" 신호위반 직진 교차로사고";
          }
          if(env.timeOfDay==="야간")et+=" 야간 야간사고";
          if(!safeInput.trim()){
            et+=" 직진 차대차 충돌 사고 교차로";
            if(env.hasRed&&env.hasGreen)et+=" 녹색직진 적색직진 신호교차로";
            else if(env.hasRed)et+=" 적색 신호위반 교차로";
            else if(env.hasGreen)et+=" 녹색 직진 교차로";
            else et+=" 무신호";
          }
          combined+=et;
          setStep("video","done",100,`${env.timeOfDay} · 밝기${avgBr} ${env.hasRed?"🔴":""}${env.hasGreen?"🟢":""}${env.hasYellow?"🟡":""} ${!env.hasRed&&!env.hasGreen&&!env.hasYellow?"(신호미감지)":""}`);
        }
      }catch(e){setStep("video","error",null,e.message)}
      await new Promise(r=>setTimeout(r,200));
    }else{setStep("video","skip",null,"영상 없음")}

    // Step 4.5: GPU Object Detection (ATLAS Pro)
    if(hasVideo&&gpuAvail){
      setStep("gpu","running",10,"GPU 서버 연결...");
      try{
        const vidFile=files.find(f=>f.type?.startsWith('video/'));
        if(vidFile?.file){
          setStep("gpu","running",30,"RTX 4080 객체 탐지 중...");
          const gr=await callGPUServer(vidFile.file,'video');
          if(gr?.success){
            setGpuResult(gr);
            const s=gr.summary;
            let gt=`\n[GPU분석: ${s.accident_type} 차량${s.vehicle_count}대`;
            if(s.has_pedestrian)gt+=" 보행자감지";
            if(s.has_bicycle)gt+=" 자전거감지";
            if(s.has_signal)gt+=` 신호:${s.signal_color}`;
            gt+=` ${s.time_of_day}]`;
            s.detected_objects?.forEach(o=>{gt+=` ${o.class_name}`});
            combined+=gt;
            setStep("gpu","done",100,`${s.accident_type} · 차량${s.vehicle_count} · 신뢰도${(s.confidence_avg*100).toFixed(0)}%`);
          }else{setStep("gpu","done",100,"GPU 분석 실패: "+(gr?.error||""))}
        }else{setStep("gpu","skip",null,"영상 파일 없음")}
      }catch(e){setStep("gpu","error",null,e.message)}
      await new Promise(r=>setTimeout(r,200));
    }else if(hasImage&&gpuAvail){
      setStep("gpu","running",10,"이미지 객체 탐지...");
      try{
        const imgFile=files.find(f=>f.type?.startsWith('image/'));
        if(imgFile?.file){
          const gr=await callGPUServer(imgFile.file,'image');
          if(gr?.success){
            setGpuResult(gr);
            const s=gr.summary;
            let gt=`\n[GPU분석: ${s.accident_type} 차량${s.vehicle_count}대`;
            if(s.has_pedestrian)gt+=" 보행자감지";
            gt+=`]`;
            combined+=gt;
            setStep("gpu","done",100,`${s.accident_type} · 객체${s.detected_objects?.length||0}개`);
          }else{setStep("gpu","done",100,"GPU 분석 실패")}
        }
      }catch(e){setStep("gpu","error",null,e.message)}
      await new Promise(r=>setTimeout(r,200));
    }else{setStep("gpu","skip",null,gpuAvail===false?"GPU 서버 미연결":"영상/이미지 없음")}

    // ═══ Step 6: ATLAS AI 1차 추론 (PRIMARY) ═══
    if(combined.length<5){setStep("claude","error",null,"텍스트 부족");setRunning(false);return}
    setStep("claude","running",10,"ATLAS AI 분석 요청 중...");
    const diagramListStr=DB.map(d=>{const bf=d.bf;const fa=bf.a??bf.c??0;const fb=bf.b??bf.p??0;return`${d.id}: ${d.t} [A${fa}:B${fb}] (${d.cat}/${d.sub})`}).join('\n');
    let claudeInput=combined;
    if(gpuResult?.for_claude)claudeInput+="\n\n"+gpuResult.for_claude;
    const accType=combined.includes('보행자')||combined.includes('사람')?'차대사람':combined.includes('자전거')||combined.includes('이륜')?'차대자전거':'차대차';
    const dbResults=await searchPrecedentsDB(combined,accType,10);
    if(dbResults.length>0)claudeInput+="\n\n## 유사 판례 DB 검색 결과\n"+dbResults.slice(0,5).map(d=>`- ${d.case_number||''} (${d.court||''}) 과실${d.fault_ratio||'?'} ${d.categories||''} ${(d.summary||'').slice(0,100)}`).join('\n');
    setStep("claude","running",30,"ATLAS AI 추론 중...");
    let claudeResult=null;
    try{
      const cr=await callClaudeAPI(claudeInput,diagramListStr);
      if(cr?.success&&cr.result){claudeResult=cr.result;claudeResult._tokens=cr.tokens||0;
        setStep("claude","done",100,`도표 ${cr.result.diagram_id||'?'} · 과실 ${cr.result.fault_a??'?'}:${cr.result.fault_b??'?'}`);
      }else{setStep("claude","done",100,"ATLAS AI 실패 → 엔진 폴백")}
    }catch(e){setStep("claude","error",null,"AI API 오류 → 엔진 폴백")}
    await new Promise(r=>setTimeout(r,200));

    // ═══ Step 7: 엔진 비교분석 ═══
    setStep("match","running",40,`${DB.length}개 도표 패턴매칭...`);
    await new Promise(r=>setTimeout(r,300));
    const m=matchDiagram(combined);
    if(m){setStep("match","done",100,`엔진: ${m.match.id} (${m.matchScore}점)`)}
    else{setStep("match","done",100,"엔진 매칭 실패")}
    await new Promise(r=>setTimeout(r,150));

    if(!claudeResult&&!m){
      setStep("result","error",null,"분석 불가");
      setResult({error:true,text:combined});setRunning(false);setPage("result");return;
    }

    // ═══ Step 8: 판례 검색 ═══
    setStep("similar","running",30,"유사 판례 검색...");
    await new Promise(r=>setTimeout(r,200));
    const sim=findSimilar(combined,kb);
    const allSimilar=[...sim,...dbResults.filter(d=>!sim.some(s=>s.id===d.id))].sort((a,b)=>(b.matchScore||0)-(a.matchScore||0)).slice(0,10);
    setStep("similar","done",100,allSimilar.length?`${allSimilar.length}건`:"없음");
    await new Promise(r=>setTimeout(r,150));

    // ═══ Step 9: 결과 산출 ═══
    setStep("result","running",60,"과실비율 종합 산출...");
    await new Promise(r=>setTimeout(r,400));
    const mods=detectMods(combined);
    let engineFaultA=50,engineFaultB=50,engineDiagram=null;
    if(m){const ef=calcFault(m.match,mods);engineFaultA=ef.fA;engineFaultB=ef.fB;engineDiagram=m.match}

    let primaryDiagram,primaryFaultA,primaryFaultB,primarySource;
    if(claudeResult&&claudeResult.diagram_id){
      const claudeDiag=DB.find(d=>d.id===claudeResult.diagram_id);
      primaryDiagram=claudeDiag||engineDiagram||DB[0];
      primaryFaultA=claudeResult.fault_a??engineFaultA;
      primaryFaultB=claudeResult.fault_b??engineFaultB;
      primarySource='claude';
    }else if(m){
      primaryDiagram=engineDiagram;primaryFaultA=engineFaultA;primaryFaultB=engineFaultB;primarySource='engine';
    }else{
      primaryDiagram=DB[0];primaryFaultA=50;primaryFaultB=50;primarySource='fallback';
    }

    const isPed=primaryDiagram.bf?.p!==undefined;
    const resultObj={
      diagram:primaryDiagram,confidence:claudeResult?.confidence||(m?.confidence)||"중",
      matchScore:m?.matchScore||0,alts:m?.alts||[],
      faultA:primaryFaultA,faultB:primaryFaultB,
      labelA:primaryDiagram.la||(isPed?"차량":"A"),labelB:primaryDiagram.lb||(isPed?"보행자":"B"),
      mods,appliedMods:(primaryDiagram.mods||[]).map(mod=>({...mod,applied:mods.some(dm=>mod.n.includes(dm)||dm.includes(mod.n))})),
      laws:getLaws(primaryDiagram,combined),similar:allSimilar,dbPrecedents:dbResults,text:combined,
      primarySource,claudeResult,engineMatch:m,engineFault:{a:engineFaultA,b:engineFaultB},
      diagramMatch:primarySource==='claude'&&m?(primaryDiagram.id===m.match.id?"일치":"불일치"):"N/A"
    };
    if(claudeResult?.analysis){
      resultObj.analysis=claudeResult.analysis;
      if(claudeResult.reasoning)resultObj.analysis=claudeResult.reasoning+"\n\n"+resultObj.analysis;
    }else{resultObj.analysis=generateAnalysis(resultObj,safeInput)}
    setResult(resultObj);
    setLlmResult(claudeResult||null);setLlmLoading(false);
    setSavedId(null);setFbSent(false);

    saveToServer({
      input_text:safeInput,input_type:hasPDF?'pdf':hasImage?'ocr':hasVideo?'video':'text',
      has_pdf:hasPDF,has_image:hasImage,has_video:hasVideo,
      pdf_text:pdfText,ocr_text:ocrResult?.text||'',video_env:vidEnv,
      diagram_id:primaryDiagram.id,diagram_title:primaryDiagram.t,category:primaryDiagram.cat,subcategory:primaryDiagram.sub,
      confidence:resultObj.confidence,match_score:resultObj.matchScore,alt_diagrams:resultObj.alts,
      fault_a:primaryFaultA,fault_b:primaryFaultB,label_a:resultObj.labelA,label_b:resultObj.labelB,
      base_fault_a:isPed?(primaryDiagram.bf?.c||0):(primaryDiagram.bf?.a||0),
      base_fault_b:isPed?(primaryDiagram.bf?.p||0):(primaryDiagram.bf?.b||0),
      detected_mods:mods,applied_mods:resultObj.appliedMods,laws:resultObj.laws.map(l=>({a:l.a,d:l.d})),
      analysis_text:resultObj.analysis,llm_used:primarySource==='claude',primary_source:primarySource,
      gpu_used:!!gpuResult,gpu_result:gpuResult?.summary||null
    }).then(res=>{if(res?.id)setSavedId(res.id);else setSavedId('local')}).catch(()=>{setSavedId('local')});

    if(claudeResult){
      const llmData={llm_response:claudeResult,llm_used:true,llm_diagram_id:claudeResult.diagram_id||null,
        llm_fault_a:claudeResult.fault_a,llm_fault_b:claudeResult.fault_b,llm_confidence:claudeResult.confidence||null,
        llm_reasoning:claudeResult.reasoning||'',llm_analysis:claudeResult.analysis||'',
        llm_modifiers:claudeResult.detected_modifiers||[],llm_tokens:claudeResult._tokens||0,
        engine_diagram_id:m?.match?.id||null,engine_fault_a:engineFaultA,engine_fault_b:engineFaultB,
        primary_source:primarySource};
      fetch(API_BASE+'/api/save',{method:'PATCH',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({session_id:SESSION_ID,llm_data:llmData})}).catch(()=>{});
    }

    setStep("result","done",100,`${primarySource==='claude'?'🤖':'📋'} ${primaryDiagram.id} · ${primaryFaultA}:${primaryFaultB}`);
    setRunning(false);setPage("result");
  },[input,files,vidSrc,kb,running]);

  const examples=["편도 2차로에서 1차로 직진 중 2차로 차량이 깜빡이 없이 차선변경하여 측면 충돌","횡단보도 녹색신호에 보행자 횡단 중 우회전 차량에 충격","무신호 교차로에서 직진 중 좌측 좁은 도로에서 나온 차량과 충돌","주차장 통로 직진 중 후진 출차 차량과 접촉","고속도로에서 앞차 급정거로 추돌","비보호좌회전 중 직진 차량과 교차로에서 충돌","중앙선 침범 차량과 정면 충돌"];

  /* ═══════════ AI 감정서 ═══════════ */
  const genReportId=()=>'MDL-'+new Date().getFullYear()+'-'+String(new Date().getMonth()+1).padStart(2,'0')+'-'+Math.random().toString(36).slice(2,7).toUpperCase();
  const reportId=useMemo(()=>genReportId(),[result]);
  const now=new Date();
  const fmtDate=`${now.getFullYear()}년 ${now.getMonth()+1}월 ${now.getDate()}일`;
  const fmtTime=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

  function AIReport({r,pdfText,ocrResult,vidEnv,llmResult,onClose}){
    if(!r||r.error)return null;
    const d=r.diagram;const printRef=useRef(null);

    const handlePrint=()=>{
      const w=window.open('','_blank','width=900,height=1200');
      if(!w)return;const el=printRef.current;if(!el)return;
      w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>AI 감정서 - ${SEC.sanitize(reportId)}</title>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
        <style>
          *{margin:0;padding:0;box-sizing:border-box}
          body{font-family:'Noto Sans KR',sans-serif;color:#1a1a2e;background:#fff;padding:40px 50px;font-size:12px;line-height:1.8}
          .report-header{text-align:center;border-bottom:3px double #1a1a2e;padding-bottom:20px;margin-bottom:30px}
          .section{margin-bottom:22px}.section-title{font-size:14px;font-weight:800;color:#1a1a2e;border-left:4px solid #3b5998;padding-left:10px;margin-bottom:10px}
          .section-body{padding-left:14px;font-size:12px;line-height:2}
          .fault-bar{display:flex;height:32px;border-radius:16px;overflow:hidden;border:1px solid #ddd;margin:10px 0}
          .fault-bar-a{background:#3b5998;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px}
          .fault-bar-b{background:#c0392b;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px}
          table{width:100%;border-collapse:collapse;margin:8px 0;font-size:11px}
          th{background:#f0f0f5;padding:7px 10px;text-align:left;border:1px solid #ddd;font-weight:700}
          td{padding:7px 10px;border:1px solid #ddd;vertical-align:top}
          .law-item{padding:6px 10px;border-left:3px solid #3b5998;background:#f8f9ff;margin-bottom:6px;border-radius:0 4px 4px 0}
          .disclaimer{margin-top:30px;padding:14px;border:1px solid #e0e0e0;border-radius:6px;background:#fefefe;font-size:10px;color:#888;text-align:center;line-height:1.8}
          .stamp{display:inline-flex;flex-direction:column;align-items:center;justify-content:center;border:2px solid #3b5998;border-radius:50%;width:62px;height:62px;text-align:center;font-weight:900;font-size:10px;color:#3b5998;margin-top:10px;line-height:1.3}
          @media print{body{padding:20px 30px}@page{margin:15mm}}
        </style></head><body>`);
      w.document.write(el.innerHTML);
      w.document.write('</body></html>');
      w.document.close();setTimeout(()=>{w.print()},600);
    };

    const TS={hdr:{textAlign:"center",borderBottom:"3px double #1a1a2e",paddingBottom:20,marginBottom:28},
      sec:{marginBottom:24},st:{fontSize:14,fontWeight:800,borderLeft:"4px solid #3b5998",paddingLeft:10,marginBottom:10},
      sb:{paddingLeft:14},th:{background:"#f0f0f5",padding:"8px 12px",border:"1px solid #ddd",fontWeight:700},
      td:{padding:"8px 12px",border:"1px solid #ddd"}};

    return<div style={{position:"fixed",inset:0,zIndex:1000,background:"rgba(0,0,0,.85)",backdropFilter:"blur(8px)",overflowY:"auto",animation:"fadeUp .3s"}}>
      <div style={{maxWidth:860,margin:"20px auto",padding:"0 12px"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,position:"sticky",top:10,zIndex:10}}>
          <button onClick={onClose} style={{padding:"8px 16px",borderRadius:10,border:`1px solid ${C.b2}`,background:"rgba(15,23,42,.9)",color:C.t2,fontSize:12,fontWeight:600,cursor:"pointer",backdropFilter:"blur(10px)"}}>← 돌아가기</button>
          <button onClick={handlePrint} style={{padding:"8px 18px",borderRadius:10,border:"none",background:`linear-gradient(135deg,${C.blue},${C.violet})`,color:"#fff",fontSize:12,fontWeight:700,cursor:"pointer"}}>🖨️ 인쇄 / PDF 저장</button>
        </div>
        <div ref={printRef} style={{background:"#fff",color:"#1a1a2e",borderRadius:12,padding:"clamp(24px,4vw,48px)",fontFamily:"'Noto Sans KR',sans-serif",fontSize:12,lineHeight:2,boxShadow:"0 8px 60px rgba(0,0,0,.5)"}}>

          {/* HEADER */}
          <div style={TS.hdr}>
            <div style={{fontSize:11,color:"#3b5998",fontWeight:700,letterSpacing:3,marginBottom:4}}>MD LABS AI ANALYSIS · ATLAS Pro</div>
            <div style={{fontSize:"clamp(22px,4vw,28px)",fontWeight:900,letterSpacing:2}}>교통사고 과실비율 AI 감정서</div>
            <div style={{fontSize:12,color:"#666",marginTop:6}}>손해보험협회 과실비율 인정기준 기반 AI 분석 보고서</div>
            <div style={{display:"flex",justifyContent:"space-between",fontSize:10.5,color:"#888",marginTop:14,padding:"0 10px"}}>
              <span>문서번호: <b style={{color:"#333"}}>{reportId}</b></span>
              <span>분석일시: <b style={{color:"#333"}}>{fmtDate} {fmtTime}</b></span>
            </div>
          </div>

          {/* 1. 사고 개요 */}
          <div style={TS.sec}><div style={TS.st}>제1장 사고 개요</div><div style={TS.sb}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:11.5}}>
              <tbody>
                <tr><th style={{...TS.th,width:"25%"}}>사고 유형</th><td style={TS.td}>{d.cat}</td>
                    <th style={{...TS.th,width:"25%"}}>세부 분류</th><td style={TS.td}>{d.sub}</td></tr>
                <tr><th style={TS.th}>적용 도표</th><td style={TS.td}><b>{d.id}</b> — {d.t}</td>
                    <th style={TS.th}>매칭 신뢰도</th><td style={TS.td}>{r.confidence==="상"?"■■■ 상 ("+r.matchScore+"점)":r.confidence==="중"?"■■□ 중 ("+r.matchScore+"점)":"■□□ 하 ("+r.matchScore+"점)"}</td></tr>
                <tr><th style={TS.th}>당사자 A</th><td style={TS.td}>{r.labelA}</td>
                    <th style={TS.th}>당사자 B</th><td style={TS.td}>{r.labelB}</td></tr>
              </tbody>
            </table>
            {input.trim()&&<div style={{marginTop:10,padding:10,background:"#f8f9ff",borderRadius:6,border:"1px solid #e8e8f0"}}>
              <div style={{fontSize:10,fontWeight:700,color:"#666",marginBottom:3}}>사고 상황 기술</div>
              <div style={{fontSize:11.5,lineHeight:1.9,color:"#2c3e50"}}>{SEC.sanitize(input.trim())}</div>
            </div>}
          </div></div>

          {/* 2. 증거 분석 */}
          <div style={TS.sec}><div style={TS.st}>제2장 증거자료 분석</div><div style={TS.sb}>
            {pdfText&&<div style={{marginBottom:10}}>
              <div style={{fontSize:11,fontWeight:700,color:"#3b5998",marginBottom:4}}>2-1. PDF 문서 텍스트 추출</div>
              <div style={{padding:8,background:"#f5f5fa",borderRadius:6,border:"1px solid #e0e0e8",fontSize:10.5,lineHeight:1.7,maxHeight:120,overflow:"hidden",color:"#555"}}>{SEC.sanitize(pdfText.slice(0,800))}...</div>
            </div>}
            {ocrResult?.text&&<div style={{marginBottom:10}}>
              <div style={{fontSize:11,fontWeight:700,color:"#3b5998",marginBottom:4}}>OCR 분석 (신뢰도 {ocrResult.confidence}%)</div>
              <div style={{padding:8,background:"#f5f5fa",borderRadius:6,border:"1px solid #e0e0e8",fontSize:10.5,lineHeight:1.7,maxHeight:80,overflow:"hidden",color:"#555"}}>{SEC.sanitize(ocrResult.text.slice(0,500))}</div>
            </div>}
            {vidEnv&&<div style={{marginBottom:10}}>
              <div style={{fontSize:11,fontWeight:700,color:"#3b5998",marginBottom:4}}>영상 환경 분석</div>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:11}}>
                <tbody>
                  <tr><th style={{...TS.th,width:"30%"}}>시간대</th><td style={TS.td}>{vidEnv.timeOfDay} (평균 밝기 {vidEnv.avgBr})</td></tr>
                  <tr><th style={TS.th}>신호 감지</th><td style={TS.td}>{vidEnv.hasRed?"🔴 적색 ":""}{vidEnv.hasGreen?"🟢 녹색 ":""}{vidEnv.hasYellow?"🟡 황색 ":""}{!vidEnv.hasRed&&!vidEnv.hasGreen&&!vidEnv.hasYellow?"미감지":""}</td></tr>
                  <tr><th style={TS.th}>분석 프레임</th><td style={TS.td}>{vidEnv.perFrame?.length||0}개</td></tr>
                </tbody>
              </table>
            </div>}
            {gpuResult&&gpuResult.success&&<div style={{marginBottom:10}}>
              <div style={{fontSize:11,fontWeight:700,color:"#e74c3c",marginBottom:4}}>🖥️ GPU 객체 탐지 (ATLAS Pro)</div>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:11}}>
                <tbody>
                  <tr><th style={{...TS.th,width:"30%"}}>모델</th><td style={TS.td}>{gpuResult.model} ({gpuResult.device})</td></tr>
                  <tr><th style={TS.th}>추정 사고유형</th><td style={{...TS.td,fontWeight:700,color:"#c0392b"}}>{gpuResult.summary.accident_type}</td></tr>
                  <tr><th style={TS.th}>감지 차량</th><td style={TS.td}>{gpuResult.summary.vehicle_count}대</td></tr>
                  <tr><th style={TS.th}>보행자</th><td style={TS.td}>{gpuResult.summary.has_pedestrian?"✅ 감지":"미감지"}</td></tr>
                  <tr><th style={TS.th}>자전거/PM</th><td style={TS.td}>{gpuResult.summary.has_bicycle?"✅ 감지":"미감지"}</td></tr>
                  <tr><th style={TS.th}>신호등</th><td style={TS.td}>{gpuResult.summary.has_signal?`✅ ${gpuResult.summary.signal_color}`:"미감지"}</td></tr>
                  <tr><th style={TS.th}>감지 객체</th><td style={TS.td}>{gpuResult.summary.detected_objects?.map((o,i)=>`${o.class_name}(${(o.confidence*100).toFixed(0)}%)`).join(", ")||"-"}</td></tr>
                  <tr><th style={TS.th}>처리 시간</th><td style={TS.td}>{gpuResult.processing_time_sec}초</td></tr>
                </tbody>
              </table>
            </div>}
            {!pdfText&&!ocrResult?.text&&!vidEnv&&!gpuResult&&<div style={{fontSize:11,color:"#999",fontStyle:"italic"}}>첨부 증거자료 없음 — 텍스트 입력 기반 분석</div>}
          </div></div>

          {/* 3. 과실비율 */}
          <div style={TS.sec}><div style={TS.st}>제3장 과실비율 산정 결과</div><div style={TS.sb}>
            <div style={{fontSize:11.5,lineHeight:2,marginBottom:12,color:"#333",whiteSpace:"pre-line"}}>{r.analysis||`도표 ${d.id}(${d.t})을 적용하여 과실비율을 산정합니다.`}</div>
            <div style={{display:"flex",height:36,borderRadius:18,overflow:"hidden",border:"2px solid #ddd",margin:"14px 0"}}>
              <div className="fault-bar-a" style={{width:`${r.faultA}%`,minWidth:r.faultA>0?40:0,background:"linear-gradient(135deg,#2c5aa0,#3b82f6)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:800,fontSize:14}}>{r.faultA>8?`${r.faultA}%`:""}</div>
              <div className="fault-bar-b" style={{width:`${r.faultB}%`,minWidth:r.faultB>0?40:0,background:"linear-gradient(135deg,#c0392b,#e74c3c)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:800,fontSize:14}}>{r.faultB>8?`${r.faultB}%`:""}</div>
            </div>
            <div style={{display:"flex",gap:20,justifyContent:"center",margin:"16px 0"}}>
              {[{l:r.labelA,v:r.faultA,c:"#2c5aa0"},{l:r.labelB,v:r.faultB,c:"#c0392b"}].map((p,i)=>
                <div key={i} style={{textAlign:"center",padding:"14px 30px",border:`2px solid ${p.c}30`,borderRadius:10,minWidth:150,background:`${p.c}05`}}>
                  <div style={{fontSize:11,color:"#666",marginBottom:4,fontWeight:600}}>{p.l}</div>
                  <div style={{fontSize:34,fontWeight:900,color:p.c}}>{p.v}%</div>
                </div>)}
            </div>
            <div style={{textAlign:"center",fontSize:13,fontWeight:800,color:"#1a1a2e",margin:"10px 0",padding:8,background:"#f0f4ff",borderRadius:6}}>
              과실비율 = {r.labelA} <span style={{color:"#2c5aa0"}}>{r.faultA}%</span> : {r.labelB} <span style={{color:"#c0392b"}}>{r.faultB}%</span>
            </div>
          </div></div>

          {/* 4. 수정요소 */}
          <div style={TS.sec}><div style={TS.st}>제4장 수정요소 검토</div><div style={TS.sb}>
            <div style={{fontSize:11,lineHeight:2,marginBottom:8,color:"#555"}}>
              기본 과실비율({d.bf.p!==undefined?`보행자 ${d.bf.p}%`:`A ${d.bf.a||0} : B ${d.bf.b||0}`})에 대하여 {MODS_DB.length}개 수정요소를 검토하였습니다.
            </div>
            {r.appliedMods?.length>0?<table style={{width:"100%",borderCollapse:"collapse",fontSize:11}}>
              <thead><tr><th style={TS.th}>수정요소</th><th style={{...TS.th,width:"15%"}}>조정</th><th style={{...TS.th,width:"15%"}}>대상</th><th style={{...TS.th,width:"15%"}}>적용</th></tr></thead>
              <tbody>{r.appliedMods.map((m,i)=><tr key={i} style={{background:m.applied?"#f0fff4":"#fff"}}>
                <td style={TS.td}>{m.n}</td>
                <td style={{...TS.td,textAlign:"center",fontWeight:700,color:m.v>0?"#c0392b":"#2c5aa0"}}>{m.v>0?"+":""}{m.v}%</td>
                <td style={{...TS.td,textAlign:"center"}}>{m.tg==='a'?r.labelA:m.tg==='b'?r.labelB:"공통"}</td>
                <td style={{...TS.td,textAlign:"center",fontWeight:700,color:m.applied?"#16a34a":"#999"}}>{m.applied?"적용":"미적용"}</td>
              </tr>)}</tbody>
            </table>:<div style={{fontSize:11,color:"#999",fontStyle:"italic"}}>해당 도표의 수정요소 없음</div>}
            {r.mods?.length>0&&<div style={{marginTop:8,fontSize:11,color:"#3b5998"}}>✓ 감지된 수정요소: {r.mods.join(', ')}</div>}
          </div></div>

          {/* 5. 법적 근거 */}
          {r.laws?.length>0&&<div style={TS.sec}><div style={TS.st}>제5장 관련 법적 근거</div><div style={TS.sb}>
            {r.laws.map((l,i)=><div key={i} style={{padding:"7px 12px",borderLeft:"3px solid #3b5998",background:"#f8f9ff",marginBottom:6,borderRadius:"0 4px 4px 0"}}>
              <div style={{fontWeight:700,color:"#2c3e50",fontSize:11.5}}>{l.a}</div>
              <div style={{color:"#666",fontSize:10.5}}>{l.d}</div>
            </div>)}
          </div></div>}

          {/* 6. 유사 도표 */}
          {r.alts?.length>0&&<div style={TS.sec}><div style={TS.st}>제6장 유사 적용 도표</div><div style={TS.sb}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:11}}>
              <thead><tr><th style={{...TS.th,width:"15%"}}>도표번호</th><th style={TS.th}>사고 유형</th><th style={{...TS.th,width:"15%"}}>매칭점수</th></tr></thead>
              <tbody>{r.alts.map(a=><tr key={a.id}>
                <td style={{...TS.td,fontWeight:700,color:"#3b5998"}}>{a.id}</td>
                <td style={TS.td}>{a.t}</td>
                <td style={{...TS.td,textAlign:"center"}}>{a.score}점</td>
              </tr>)}</tbody>
            </table>
          </div></div>}

          {/* 7. 유사 판례 */}
          {r.similar?.length>0&&<div style={TS.sec}><div style={TS.st}>제7장 유사 판례 분석 {r.dbPrecedents?.length>0&&`(DB ${r.dbPrecedents.length}건 포함)`}</div><div style={TS.sb}>
            {r.similar.map(c=><div key={c.id} style={{padding:8,border:"1px solid #e8e8f0",borderRadius:6,marginBottom:6,background:c.source==='supabase'?"#f0fff0":"#fafafa"}}>
              <div style={{fontSize:11,fontWeight:700}}>{c.source==='supabase'?'📗':'📘'} {c.case_name||c.accidentType||''} — {c.case_number||c.caseNumber||"판례번호 미상"}</div>
              <div style={{fontSize:10.5,color:"#666"}}>과실비율: {c.fault_a||c.faultA||'?'}% : {c.fault_b||c.faultB||'?'}% {(c.court)||''} {c.date?`| ${c.date}`:''}</div>
              {c.summary&&<div style={{fontSize:10,color:"#555",marginTop:3,lineHeight:1.6}}>{c.summary.slice(0,200)}</div>}
            </div>)}
          </div></div>}

          {/* 8. ATLAS AI 분석 */}
          {llmResult&&!llmResult.error&&<div style={TS.sec}><div style={{...TS.st,borderLeftColor:"#6366f1"}}>제8장 ATLAS AI 분석</div><div style={TS.sb}>
            <div style={{background:"#f0f0ff",border:"1px solid #d0d0f0",borderRadius:8,padding:12,marginBottom:10}}>
              <div style={{fontSize:10,color:"#6366f1",fontWeight:700,marginBottom:6}}>🤖 AI 분석 엔진: ATLAS AI (MD Labs)</div>
              {llmResult.reasoning&&<p style={{fontSize:10.5,color:"#444",lineHeight:1.9,marginBottom:8}}>
                <b>AI 추론 과정:</b> {llmResult.reasoning}</p>}
              {llmResult.analysis&&<p style={{fontSize:10.5,color:"#444",lineHeight:1.9,marginBottom:8}}>
                <b>AI 분석 의견:</b> {llmResult.analysis}</p>}
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:11,marginTop:8}}>
                <thead><tr>
                  <th style={{...TS.th,background:"#e8e8f8",width:"25%"}}>항목</th>
                  <th style={{...TS.th,background:"#e8f0e8",width:"37%"}}>패턴매칭 엔진</th>
                  <th style={{...TS.th,background:"#e8e8f8",width:"38%"}}>ATLAS AI</th>
                </tr></thead>
                <tbody>
                  <tr><td style={{...TS.td,fontWeight:700}}>추천 도표</td>
                    <td style={{...TS.td,textAlign:"center"}}>{d.id}</td>
                    <td style={{...TS.td,textAlign:"center",color:d.id===llmResult.diagram_id?"#27ae60":"#e67e22",fontWeight:700}}>
                      {llmResult.diagram_id||"-"} {d.id===llmResult.diagram_id?"✅ 일치":"⚠️ 상이"}</td></tr>
                  <tr><td style={{...TS.td,fontWeight:700}}>과실비율</td>
                    <td style={{...TS.td,textAlign:"center"}}>{r.faultA}% : {r.faultB}%</td>
                    <td style={{...TS.td,textAlign:"center"}}>{llmResult.fault_a!==undefined?`${llmResult.fault_a}% : ${llmResult.fault_b}%`:"-"}</td></tr>
                  <tr><td style={{...TS.td,fontWeight:700}}>신뢰도</td>
                    <td style={{...TS.td,textAlign:"center"}}>{r.confidence||"-"}</td>
                    <td style={{...TS.td,textAlign:"center"}}>{llmResult.confidence||"-"}</td></tr>
                  {llmResult.detected_modifiers?.length>0&&<tr><td style={{...TS.td,fontWeight:700}}>AI 감지 수정요소</td>
                    <td colSpan={2} style={TS.td}>{llmResult.detected_modifiers.join(", ")}</td></tr>}
                </tbody>
              </table>
            </div>
            {d.id!==llmResult.diagram_id&&llmResult.diagram_id&&<div style={{padding:8,background:"#fff8e1",border:"1px solid #ffe082",borderRadius:6,fontSize:10.5,lineHeight:1.7}}>
              <b>⚠️ 도표 불일치 안내:</b> 패턴매칭 엔진(도표 {d.id})과 ATLAS AI(도표 {llmResult.diagram_id})의 추천이 다릅니다.
              사고 상황을 재검토하시거나, 전문가 확인을 권장합니다.
            </div>}
          </div></div>}

          {/* 9. 종합 의견 */}
          <div style={TS.sec}><div style={{...TS.st,borderLeftColor:"#c0392b"}}>제{llmResult&&!llmResult.error?9:8}장 종합 의견</div><div style={{...TS.sb,fontSize:11.5,lineHeight:2.2,color:"#333"}}>
            <p>본 건 교통사고에 대하여 손해보험협회 「자동차사고 과실비율 인정기준(2023.6)」을 적용하여 분석한 결과,
            도표 <b>{d.id}</b>({d.t})이 가장 적합한 것으로 판단됩니다.</p>
            <p style={{marginTop:8}}>기본 과실비율({d.bf.p!==undefined?`보행자 ${d.bf.p}%`:`A ${d.bf.a||0}% : B ${d.bf.b||0}%`})에
            {r.mods?.length>0?` 수정요소(${r.mods.join(', ')})를 반영하여`:' 수정요소 없이'}
            {' '}최종 과실비율을 <b>{r.labelA} {r.faultA}% : {r.labelB} {r.faultB}%</b>로 산정합니다.</p>
            {llmResult&&!llmResult.error&&<p style={{marginTop:8,padding:8,background:"#f0f8f0",border:"1px solid #c8e6c9",borderRadius:6}}>
              <b>🤖 AI 종합 판단:</b> ATLAS AI 분석 결과,
              {d.id===llmResult.diagram_id
                ?<> 도표 <b>{d.id}</b>이 적합하다는 점에서 <span style={{color:"#27ae60",fontWeight:700}}>패턴매칭 엔진과 일치</span>하여 분석 신뢰도가 높습니다.
                  {llmResult.fault_a!==undefined&&Math.abs(r.faultA-llmResult.fault_a)<=5
                    ?' 과실비율도 유사하게 산정되었습니다.'
                    :llmResult.fault_a!==undefined?` 다만 과실비율은 AI가 ${llmResult.fault_a}:${llmResult.fault_b}으로 산정하여 일부 차이가 있으므로 참고하시기 바랍니다.`
                    :''}</>
                :<> 도표 <b>{llmResult.diagram_id}</b>을 추천하여 <span style={{color:"#e67e22",fontWeight:700}}>패턴매칭 결과(도표 {d.id})와 상이</span>합니다.
                  사고 정황의 재검토를 권장하며, 양쪽 분석 결과를 종합적으로 참고하시기 바랍니다.</>}
            </p>}
            {vidEnv&&<p style={{marginTop:8}}>영상 환경 분석 결과 사고 당시 <b>{vidEnv.timeOfDay}</b>(평균밝기 {vidEnv.avgBr})이며,
            {vidEnv.hasRed||vidEnv.hasGreen?" 신호등이 감지되어 신호교차로 사고로 판단됩니다.":" 신호등 감지가 명확하지 않아 추가 확인이 필요합니다."}</p>}
            {gpuResult&&gpuResult.success&&<p style={{marginTop:8}}>GPU 객체 탐지(ATLAS Pro) 결과 <b>{gpuResult.summary.accident_type}</b> 사고로 추정되며,
            차량 {gpuResult.summary.vehicle_count}대{gpuResult.summary.has_pedestrian?", 보행자":""}{gpuResult.summary.has_bicycle?", 자전거/PM":""}가 감지되었습니다.
            {gpuResult.summary.has_signal?` 신호등(${gpuResult.summary.signal_color})이 확인되었습니다.`:""}</p>}
            <p style={{marginTop:12,fontWeight:700,color:"#c0392b"}}>본 감정서는 AI 분석에 기반한 참고자료이며, 법적 구속력이 없습니다.
            정확한 과실비율은 보험사 심의 또는 법원 판단을 통해 최종 확정됩니다.</p>
          </div></div>

          {/* FOOTER */}
          <div style={{marginTop:30,padding:14,border:"1px solid #e0e0e0",borderRadius:6,background:"#fefefe",fontSize:10,color:"#888",textAlign:"center",lineHeight:1.8}}>
            본 감정서는 손해보험협회 「자동차사고 과실비율 인정기준(2023년 6월)」을 기반으로 AI가 자동 생성한 참고 문서입니다.<br/>
            법적 효력이 없으며, 실제 보상 및 소송에서의 과실비율은 관련 법률 및 판례에 따라 달리 적용될 수 있습니다.<br/>
            정확한 과실비율 판단은 보험사, 손해사정인 또는 법률전문가에게 문의하시기 바랍니다.
          </div>
          <div style={{textAlign:"center",marginTop:20,paddingTop:16,borderTop:"2px solid #1a1a2e"}}>
            <div style={{fontSize:13,fontWeight:800,letterSpacing:1}}>MD Labs</div>
            <div style={{fontSize:10,color:"#666",marginTop:2}}>AI Mobility Data Intelligence</div>
            <div className="stamp" style={{display:"inline-flex",flexDirection:"column",alignItems:"center",justifyContent:"center",border:"2px solid #3b5998",borderRadius:"50%",width:62,height:62,textAlign:"center",fontWeight:900,fontSize:10,color:"#3b5998",marginTop:10,lineHeight:1.3}}>
              <span>MD Labs</span><span style={{fontSize:8}}>AI v7</span>
            </div>
            <div style={{fontSize:9,color:"#aaa",marginTop:10}}>Document ID: {reportId} | Generated: {fmtDate} {fmtTime}</div>
          </div>
        </div>
      </div>
    </div>;
  }

  // ═══ RESULT PAGE ═══
  if(page==="result"){
    const r=result;
    return<div style={{minHeight:"100vh",background:C.bg,color:C.t1,fontFamily:"var(--sans)"}}>
      <div style={{padding:"10px 16px",background:"rgba(6,9,16,.9)",backdropFilter:"blur(20px)",borderBottom:`1px solid ${C.b1}`,position:"sticky",top:0,zIndex:50}}>
        <div style={{...mx,display:"flex",alignItems:"center",justifyContent:"space-between",padding:0}}>
          <button onClick={()=>{setPage("input");resetSteps();setShowReport(false)}} style={{background:"none",border:"none",color:C.t2,cursor:"pointer",fontSize:16,padding:"4px 6px"}}>← 돌아가기</button>
          <Btn small primary onClick={()=>{setInput("");setResult(null);setFiles([]);setVidSrc(null);setVidEnv(null);setVidFrames([]);setOcrResult(null);setPdfText("");resetSteps();setShowReport(false);setSavedId(null);setFbSent(false);setLlmResult(null);setLlmLoading(false);setPage("input")}}>🔄 새 분석</Btn>
          {result&&!result.error&&<button onClick={()=>setShowReport(true)} style={{padding:"5px 14px",borderRadius:8,border:"none",background:"linear-gradient(135deg,#2c5aa0,#6366f1)",color:"#fff",fontSize:12,fontWeight:700,cursor:"pointer",marginLeft:6}}>📄 AI 감정서</button>}
        </div>
      </div>
      <div style={{...mx,paddingTop:14,paddingBottom:80}}>
        <AgentPipeline stepStates={stepStates}/>
        {r?.error?
          <div style={{background:C.card,border:`1px solid ${C.amber}20`,borderRadius:16,padding:24,textAlign:"center",animation:"fadeUp .3s"}}>
            <div style={{fontSize:36,marginBottom:8}}>🤔</div>
            <p style={{fontSize:14,fontWeight:700,color:"#fcd34d",marginBottom:6}}>도표 매칭 실패</p>
            {vidEnv&&<div style={{background:"rgba(99,102,241,.06)",border:"1px solid rgba(99,102,241,.12)",borderRadius:10,padding:10,marginBottom:12,textAlign:"left"}}>
              <div style={{fontSize:10,fontWeight:700,color:"#818cf8",marginBottom:4}}>🎬 영상에서 감지된 정보:</div>
              <div style={{fontSize:11,color:C.t2,lineHeight:1.6}}>
                시간대: <b style={{color:vidEnv.timeOfDay==="야간"?"#fbbf24":"#60a5fa"}}>{vidEnv.timeOfDay}</b> (밝기 {vidEnv.avgBr})<br/>
                {vidEnv.hasRed&&<>🔴 적색 신호 감지<br/></>}
                {vidEnv.hasGreen&&<>🟢 녹색 신호 감지<br/></>}
                {vidEnv.hasYellow&&<>🟡 황색 신호 감지<br/></>}
                {!vidEnv.hasRed&&!vidEnv.hasGreen&&!vidEnv.hasYellow&&<>신호등 색상 미감지<br/></>}
              </div>
            </div>}
            <p style={{fontSize:11,color:C.t2,lineHeight:1.7,marginBottom:12}}>
              영상만으로는 사고 유형을 정확히 판단하기 어렵습니다.<br/>
              <b style={{color:"#e2e8f0"}}>사고 상황을 텍스트로 함께 입력</b>해주세요.
            </p>
            <div style={{textAlign:"left",marginBottom:12}}>
              <div style={{fontSize:10,fontWeight:700,color:C.t3,marginBottom:4}}>💡 입력 예시:</div>
              {["교차로에서 녹색 직진 중 적색 신호위반 차량과 충돌","차선변경 중 측면 충돌","비보호좌회전 중 직진 차량과 충돌","후행차가 추돌","주차장에서 출차 중 통로 직진 차량과 접촉"].map((ex,i)=>
                <button key={i} onClick={()=>{setInput(ex);setPage("input");resetSteps()}} style={{display:"block",width:"100%",textAlign:"left",padding:"6px 10px",borderRadius:7,border:`1px solid ${C.b1}`,background:"rgba(12,17,30,.5)",color:C.t2,fontSize:10.5,cursor:"pointer",marginBottom:2,lineHeight:1.5}}>
                  <span style={{color:C.indigo,marginRight:4}}>▸</span>{ex}
                </button>)}
            </div>
            <Btn primary onClick={()=>{setPage("input");resetSteps()}}>다시 입력</Btn>
          </div>
        :r&&(()=>{const d=r.diagram;return<div style={{animation:"fadeUp .3s"}}>
          <div style={{background:`linear-gradient(135deg,rgba(59,130,246,.06),rgba(139,92,246,.04))`,border:`1px solid rgba(99,102,241,.12)`,borderRadius:18,padding:20,marginBottom:14}}>
            <div style={{display:"flex",gap:5,marginBottom:10,flexWrap:"wrap"}}><Tag color={C.blue}>{d.cat}</Tag><Tag color={C.amber}>{d.id}</Tag><Tag>{d.sub}</Tag><Tag color={r.confidence==="상"?C.emerald:C.amber}>신뢰도:{r.confidence} ({r.matchScore}점)</Tag></div>
            <h2 style={{fontSize:"clamp(16px,4vw,22px)",fontWeight:800,marginBottom:2}}>{d.t}</h2>
            <FBar la={r.labelA} lb={r.labelB} va={r.faultA} vb={r.faultB}/>
            <div style={{display:"flex",gap:10,justifyContent:"center"}}>
              {[{l:r.labelA,v:r.faultA,c:C.blue},{l:r.labelB,v:r.faultB,c:C.red}].map((p,i)=>
                <div key={i} style={{flex:1,maxWidth:180,padding:14,borderRadius:14,textAlign:"center",background:`${p.c}06`,border:`1px solid ${p.c}12`}}>
                  <div style={{fontSize:10,color:p.c,fontWeight:600,marginBottom:3}}>{p.l}</div>
                  <div style={{fontSize:28,fontWeight:900,color:p.c,fontFamily:"var(--mono)"}}>{p.v}%</div>
                </div>)}
            </div>
          </div>

          {r.alts?.length>0&&<div style={{background:C.card,border:`1px solid ${C.b1}`,borderRadius:14,padding:14,marginBottom:10}}>
            <div style={{fontSize:11,fontWeight:700,color:C.t3,marginBottom:6}}>📋 유사 도표</div>
            {r.alts.map(a=><div key={a.id} style={{padding:"5px 8px",borderRadius:7,background:"rgba(6,9,16,.3)",marginBottom:3,fontSize:11,color:C.t2}}>
              <Tag color={C.t3} sx={{fontSize:9,marginRight:4}}>{a.id}</Tag>{a.t} <span style={{fontSize:9,color:C.t3}}>({a.score}점)</span>
            </div>)}
          </div>}

          {pdfText&&<div style={{background:C.card,border:`1px solid ${C.cyan}10`,borderRadius:14,padding:14,marginBottom:10}}>
            <div style={{display:"flex",alignItems:"center",gap:5,marginBottom:6}}><span>📄</span><span style={{fontSize:11,fontWeight:700,color:C.t3}}>PDF 추출 텍스트</span></div>
            <pre style={{padding:8,borderRadius:8,background:"rgba(6,9,16,.5)",fontSize:10,color:C.t2,lineHeight:1.5,whiteSpace:"pre-wrap",fontFamily:"var(--mono)",maxHeight:150,overflowY:"auto"}}>{pdfText.slice(0,3000)}</pre>
            <Btn small onClick={()=>{addToKB(parsePrecedent(pdfText),r?.diagram?.id,r?.diagram?.cat)}} sx={{marginTop:6,fontSize:10}}>🧠 학습DB 저장</Btn>
          </div>}

          {ocrResult?.text&&<div style={{background:C.card,border:`1px solid ${C.cyan}10`,borderRadius:14,padding:14,marginBottom:10}}>
            <div style={{fontSize:11,fontWeight:700,color:C.t3,marginBottom:6}}>🔍 OCR 텍스트 (신뢰도 {ocrResult.confidence}%)</div>
            <pre style={{padding:8,borderRadius:8,background:"rgba(6,9,16,.5)",fontSize:10,color:C.t2,whiteSpace:"pre-wrap",maxHeight:100,overflowY:"auto"}}>{ocrResult.text}</pre>
          </div>}

          {vidEnv&&<div style={{background:C.card,border:`1px solid ${C.violet}10`,borderRadius:14,padding:14,marginBottom:10}}>
            <div style={{fontSize:11,fontWeight:700,color:C.t3,marginBottom:6}}>🎬 영상 환경</div>
            <div style={{display:"flex",gap:6,flexWrap:"wrap"}}><Tag color={vidEnv.timeOfDay==="야간"?C.amber:C.blue}>{vidEnv.timeOfDay}</Tag><Tag>밝기{vidEnv.avgBr}</Tag>{vidEnv.hasRed&&<Tag color={C.red}>🔴 적색</Tag>}{vidEnv.hasGreen&&<Tag color={C.emerald}>🟢 녹색</Tag>}{vidEnv.hasYellow&&<Tag color={C.amber}>🟡 황색</Tag>}</div>
          </div>}

          {r.similar?.length>0&&<div style={{background:C.card,border:`1px solid ${C.violet}10`,borderRadius:14,padding:14,marginBottom:10}}>
            <div style={{fontSize:11,fontWeight:700,color:C.t3,marginBottom:6}}>🧠 유사 판례 {r.similar.length}건 {r.dbPrecedents?.length>0&&<span style={{fontSize:9,color:C.emerald}}>(DB {r.dbPrecedents.length}건 포함)</span>}</div>
            {r.similar.map(c=><div key={c.id} style={{padding:8,borderRadius:8,background:"rgba(6,9,16,.3)",marginBottom:4,fontSize:11}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <span>{c.source==='supabase'?<Tag color={C.emerald} sx={{fontSize:8,marginRight:3}}>DB</Tag>:<Tag color={C.violet} sx={{fontSize:8,marginRight:3}}>KB</Tag>}
                  <span style={{color:C.blue}}>{c.fault_a||c.faultA||'?'}%</span>:<span style={{color:C.red}}>{c.fault_b||c.faultB||'?'}%</span>
                  {' · '}{c.case_name||c.accidentType||''}
                </span>
                <span style={{fontSize:9,color:C.t3}}>{c.matchScore}점</span>
              </div>
              {c.source==='supabase'&&<div style={{fontSize:10,color:C.t3,marginTop:3}}>
                {c.case_number&&<span>{c.case_number} · </span>}{c.court&&<span>{c.court} · </span>}{c.date&&<span>{c.date}</span>}
                {c.summary&&<div style={{marginTop:2,color:C.t2,lineHeight:1.5}}>{c.summary.slice(0,150)}</div>}
              </div>}
            </div>)}
          </div>}

          {(r.appliedMods?.length>0||r.laws?.length>0)&&<div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:10}}>
            {r.appliedMods?.length>0&&<div style={{background:C.card,border:`1px solid ${C.b1}`,borderRadius:14,padding:14,maxHeight:200,overflowY:"auto"}}>
              <div style={{fontSize:11,fontWeight:700,color:C.t3,marginBottom:6,position:"sticky",top:0,background:C.card,paddingBottom:4}}>🔧 수정요소</div>
              {r.appliedMods.map((m,i)=><div key={i} style={{padding:"4px 8px",borderRadius:7,marginBottom:2,background:m.applied?`${C.blue}06`:"rgba(15,23,42,.3)",fontSize:11}}>
                {m.applied?"✅":"⬜"} {m.n} <span style={{fontFamily:"var(--mono)",color:m.v>0?"#f87171":"#60a5fa"}}>{m.v>0?"+":""}{m.v}%</span>
              </div>)}
            </div>}
            {r.laws?.length>0&&<div style={{background:C.card,border:`1px solid ${C.b1}`,borderRadius:14,padding:14,maxHeight:200,overflowY:"auto"}}>
              <div style={{fontSize:11,fontWeight:700,color:C.t3,marginBottom:6,position:"sticky",top:0,background:C.card,paddingBottom:4}}>📖 관련 법규</div>
              {r.laws.map((l,i)=><div key={i} style={{padding:"4px 7px",borderRadius:7,background:"rgba(6,9,16,.3)",marginBottom:2,borderLeft:`3px solid ${C.indigo}`}}>
                <div style={{fontSize:10,fontWeight:700,color:"#a5b4fc"}}>{l.a}</div>
                <div style={{fontSize:9,color:C.t2}}>{l.d}</div>
              </div>)}
            </div>}
          </div>}

          <div style={{textAlign:"center",marginBottom:14}}>
            <button onClick={()=>setShowReport(true)} style={{padding:"12px 32px",borderRadius:12,border:"none",background:"linear-gradient(135deg,#1e3a6e,#3b5998,#6366f1)",color:"#fff",fontSize:14,fontWeight:800,cursor:"pointer",boxShadow:"0 4px 20px rgba(59,89,152,.4)",letterSpacing:1}}>
              📄 AI 감정서 작성
            </button>
            <p style={{fontSize:10,color:C.t3,marginTop:6}}>전문 감정서 형식으로 출력 · 인쇄/PDF 저장 가능</p>
          </div>

          {/* v8.5 ATLAS AI + 엔진 비교 + 학습레이블 */}
          {r.primarySource&&<div style={{background:r.primarySource==='claude'?"rgba(99,102,241,.04)":"rgba(59,130,246,.04)",border:`1px solid ${r.primarySource==='claude'?C.violet:C.blue}15`,borderRadius:14,padding:14,marginBottom:10}}>
            <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:10}}>
              <span style={{fontSize:16}}>{r.primarySource==='claude'?'🤖':'📋'}</span>
              <div>
                <div style={{fontSize:12,fontWeight:800,color:r.primarySource==='claude'?C.violet:C.blue}}>
                  {r.primarySource==='claude'?'ATLAS AI 1차 추론 결과':'엔진 결과 (ATLAS AI 폴백)'}
                </div>
              </div>
            </div>
            {r.claudeResult&&<div style={{marginBottom:10}}>
              {r.claudeResult.reasoning&&<div style={{padding:10,borderRadius:8,background:"rgba(99,102,241,.04)",border:`1px solid ${C.violet}10`,marginBottom:8}}>
                <div style={{fontSize:10,fontWeight:700,color:C.violet,marginBottom:4}}>🧠 AI 추론</div>
                <p style={{fontSize:11,color:C.t2,lineHeight:1.8,whiteSpace:"pre-line"}}>{r.claudeResult.reasoning}</p>
              </div>}
              {r.claudeResult.analysis&&<div style={{padding:10,borderRadius:8,background:"rgba(16,185,129,.03)",border:`1px solid ${C.emerald}10`,marginBottom:8}}>
                <div style={{fontSize:10,fontWeight:700,color:C.emerald,marginBottom:4}}>📝 분석</div>
                <p style={{fontSize:11,color:C.t2,lineHeight:1.8,whiteSpace:"pre-line"}}>{r.claudeResult.analysis}</p>
              </div>}
            </div>}
            {r.engineMatch&&<div style={{background:"rgba(6,9,16,.4)",borderRadius:10,padding:10,border:`1px solid ${C.b1}`}}>
              <div style={{fontSize:10,fontWeight:700,color:C.t3,marginBottom:8}}>📊 엔진 vs ATLAS AI</div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:4,fontSize:10}}>
                <div style={{fontWeight:700,color:C.t3,padding:"4px 6px"}}>항목</div>
                <div style={{fontWeight:700,color:C.blue,padding:"4px 6px",textAlign:"center"}}>📋 엔진</div>
                <div style={{fontWeight:700,color:C.violet,padding:"4px 6px",textAlign:"center"}}>🤖 ATLAS</div>
                <div style={{color:C.t2,padding:"4px 6px",borderTop:`1px solid ${C.b1}`}}>도표</div>
                <div style={{color:C.t2,padding:"4px 6px",textAlign:"center",borderTop:`1px solid ${C.b1}`}}>{r.engineMatch.match.id}</div>
                <div style={{color:r.claudeResult?.diagram_id===r.engineMatch.match.id?C.emerald:C.amber,fontWeight:700,padding:"4px 6px",textAlign:"center",borderTop:`1px solid ${C.b1}`}}>
                  {r.claudeResult?.diagram_id||'-'} {r.claudeResult?.diagram_id===r.engineMatch.match.id?'✅':'⚠️'}
                </div>
                <div style={{color:C.t2,padding:"4px 6px",borderTop:`1px solid ${C.b1}`}}>과실</div>
                <div style={{color:C.t2,padding:"4px 6px",textAlign:"center",fontFamily:"var(--mono)",borderTop:`1px solid ${C.b1}`}}>A {r.engineFault?.a} : B {r.engineFault?.b}</div>
                <div style={{color:C.t2,padding:"4px 6px",textAlign:"center",fontFamily:"var(--mono)",fontWeight:700,borderTop:`1px solid ${C.b1}`}}>A {r.faultA} : B {r.faultB}</div>
              </div>
              {r.diagramMatch==='불일치'&&<div style={{marginTop:6,padding:6,background:`${C.amber}06`,borderRadius:6,fontSize:10,color:C.amber}}>⚠️ 도표 불일치 — 학습 데이터 축적</div>}
              {r.diagramMatch==='일치'&&<div style={{marginTop:6,padding:6,background:`${C.emerald}06`,borderRadius:6,fontSize:10,color:C.emerald}}>✅ 도표 일치 — 높은 신뢰도</div>}
              {(()=>{
                const fDiff=Math.abs((r.faultA||0)-(r.engineFault?.a||0));
                const dMatch=r.diagramMatch==='일치';
                let grade,gColor;
                if(dMatch&&fDiff<=5){grade='정확';gColor='#10b981'}
                else if(dMatch&&fDiff<=15){grade='부합';gColor='#f59e0b'}
                else if(!dMatch&&fDiff<=20){grade='검토';gColor='#f97316'}
                else{grade='틀림';gColor='#ef4444'}
                return<div style={{marginTop:6,padding:"6px 10px",borderRadius:8,background:`${gColor}08`,border:`1px solid ${gColor}20`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                  <span style={{fontSize:10,color:gColor,fontWeight:700}}>📊 분석 결과 (학습반영): <span style={{fontSize:12,padding:"1px 8px",borderRadius:4,background:`${gColor}15`}}>{grade}</span></span>
                  <span style={{fontSize:9,color:"#64748b"}}>과실차이 {fDiff}%p</span>
                </div>
              })()}
            </div>}
          </div>}

          {savedId&&savedId!=='local'&&<div style={{background:C.card,border:`1px solid ${C.emerald}15`,borderRadius:14,padding:14,marginBottom:10,textAlign:"center"}}>
            <div style={{fontSize:11,fontWeight:700,color:C.emerald,marginBottom:8}}>✅ 분석 결과가 서버에 저장되었습니다</div>
            {!fbSent?<div>
              <div style={{fontSize:10,color:C.t3,marginBottom:8}}>분석 결과를 평가해주세요 (학습에 반영됩니다)</div>
              <div style={{display:"flex",gap:6,justifyContent:"center"}}>
                <button onClick={()=>{sendFeedback(savedId,true,'정확');setFbSent('정확')}} style={{padding:"8px 16px",borderRadius:8,border:"2px solid rgba(16,185,129,.5)",background:"rgba(16,185,129,.18)",color:"#10b981",fontSize:12,fontWeight:700,cursor:"pointer"}}>✅ 정확</button>
                <button onClick={()=>{sendFeedback(savedId,true,'부합');setFbSent('부합')}} style={{padding:"8px 16px",borderRadius:8,border:"2px solid rgba(245,158,11,.5)",background:"rgba(245,158,11,.18)",color:"#f59e0b",fontSize:12,fontWeight:700,cursor:"pointer"}}>🟡 부합</button>
                <button onClick={()=>{sendFeedback(savedId,false,'검토');setFbSent('검토')}} style={{padding:"8px 16px",borderRadius:8,border:"2px solid rgba(249,115,22,.5)",background:"rgba(249,115,22,.18)",color:"#f97316",fontSize:12,fontWeight:700,cursor:"pointer"}}>🟠 검토</button>
                <button onClick={()=>{sendFeedback(savedId,false,'틀림');setFbSent('틀림')}} style={{padding:"8px 16px",borderRadius:8,border:"2px solid rgba(239,68,68,.5)",background:"rgba(239,68,68,.18)",color:"#ef4444",fontSize:12,fontWeight:700,cursor:"pointer"}}>❌ 틀림</button>
              </div>
            </div>:
            <div style={{fontSize:11,color:fbSent==='정확'?"#10b981":fbSent==='부합'?"#f59e0b":fbSent==='검토'?"#f97316":"#ef4444",fontWeight:600}}>
              {'평가: '+fbSent+' — 감사합니다! 학습에 반영됩니다.'}
            </div>}
          </div>}
          {!savedId&&<div style={{textAlign:"center",marginBottom:10}}><span style={{fontSize:9,color:C.t3}}>💾 서버 저장 중...</span></div>}
          {savedId==='local'&&<div style={{textAlign:"center",marginBottom:10}}><span style={{fontSize:9,color:C.t3}}>✅ 로컬 분석 완료 (서버 미연결)</span></div>}

          <div style={{padding:10,borderRadius:10,background:`${C.amber}04`,border:`1px solid ${C.amber}08`,textAlign:"center"}}>
            <p style={{fontSize:9.5,color:C.t3}}>⚠️ 참고용 · 법적 구속력 없음 · 정확한 판단은 보험사·전문가 문의</p>
          </div>
        </div>})()}

        {showReport&&result&&!result.error&&<AIReport r={result} pdfText={pdfText} ocrResult={ocrResult} vidEnv={vidEnv} llmResult={llmResult} onClose={()=>setShowReport(false)}/>}
      </div>
    </div>;
  }

  // ═══ INPUT PAGE ═══
  return<div style={{minHeight:"100vh",background:C.bg,color:C.t1,fontFamily:"var(--sans)"}}>
    <div style={{padding:"10px 16px",background:"rgba(6,9,16,.9)",backdropFilter:"blur(20px)",borderBottom:`1px solid ${C.b1}`,position:"sticky",top:0,zIndex:50}}>
      <div style={{...mx,display:"flex",alignItems:"center",gap:8,padding:0}}>
        <div style={{flex:1}}><div style={{fontWeight:900,fontSize:15,letterSpacing:-.3}}>MD Labs <span style={{fontWeight:700,fontSize:12,color:C.blue}}>ATLAS Pro</span></div><div style={{fontSize:9,color:C.t2,letterSpacing:.8,fontWeight:500}}>AI Traffic Legal Analysis System</div></div>
        <div style={{display:"flex",alignItems:"center",gap:4}}>
          <span style={{fontSize:8,color:C.t3,padding:"2px 6px",borderRadius:4,border:`1px solid ${C.b1}`}}>{DB.length}도표 · 69K판례</span>
          <div style={{display:"flex",borderRadius:4,overflow:"hidden",border:`1px solid ${C.b1}`}}>
            <span style={{padding:"2px 6px",fontSize:8,fontWeight:700,background:"rgba(99,102,241,.15)",color:C.blue,cursor:"pointer"}}>KR</span>
            <span style={{padding:"2px 6px",fontSize:8,color:C.t3,cursor:"pointer"}}>EN</span>
          </div>
        </div>
        {gpuAvail&&<span style={{fontSize:8,color:"#27ae60",padding:"2px 6px",borderRadius:4,background:"rgba(39,174,96,.1)",border:"1px solid rgba(39,174,96,.3)",marginLeft:4,cursor:"pointer"}} onClick={()=>{
          const m=prompt("GPU 모드 선택:\n\n1 = LOCAL (무료, PC 직접)\n2 = NGROK (무료, 외부 터널)\n3 = CLOUD (유료, 24시간)\n\n현재: "+gpuMode.toUpperCase()+"\nURL: "+GPU_SERVER_URL,"");
          if(m==='1'){localStorage.setItem('atlas_gpu_mode','local');localStorage.removeItem('atlas_gpu_ngrok_url');localStorage.removeItem('atlas_gpu_cloud_url');location.reload()}
          else if(m==='2'){const u=prompt("ngrok URL:",GPU_MODES.ngrok||"https://xxxxx.ngrok-free.dev");if(u){localStorage.setItem('atlas_gpu_mode','ngrok');localStorage.setItem('atlas_gpu_ngrok_url',u);location.reload()}}
          else if(m==='3'){const u=prompt("Cloud GPU URL:",GPU_MODES.cloud||"https://your-cloud-gpu.com");if(u){localStorage.setItem('atlas_gpu_mode','cloud');localStorage.setItem('atlas_gpu_cloud_url',u);location.reload()}}
        }}>🖥️ GPU {gpuMode==='cloud'?'☁️유료':'🏠무료'} 연결됨</span>}
        {gpuAvail===false&&<span style={{fontSize:8,color:"#e74c3c",padding:"2px 6px",borderRadius:4,background:"rgba(231,76,60,.1)",border:"1px solid rgba(231,76,60,.2)",marginLeft:4,cursor:"pointer"}} onClick={()=>{
          const m=prompt("GPU 모드 선택:\n\n1 = LOCAL (무료, PC 직접)\n2 = NGROK (무료, 외부 터널)\n3 = CLOUD (유료, 24시간)\n\n현재: "+gpuMode.toUpperCase()+"\nURL: "+GPU_SERVER_URL,"");
          if(m==='1'){localStorage.setItem('atlas_gpu_mode','local');location.reload()}
          else if(m==='2'){const u=prompt("ngrok URL:",GPU_MODES.ngrok||"https://xxxxx.ngrok-free.dev");if(u){localStorage.setItem('atlas_gpu_mode','ngrok');localStorage.setItem('atlas_gpu_ngrok_url',u);location.reload()}}
          else if(m==='3'){const u=prompt("Cloud GPU URL:",GPU_MODES.cloud||"https://your-cloud-gpu.com");if(u){localStorage.setItem('atlas_gpu_mode','cloud');localStorage.setItem('atlas_gpu_cloud_url',u);location.reload()}}
        }}>GPU 미연결 ⚙️</span>}
        {stats.total>0&&<button onClick={()=>setShowKB(!showKB)} style={{padding:"4px 8px",borderRadius:7,border:`1px solid ${showKB?`${C.violet}30`:C.b1}`,background:showKB?`${C.violet}08`:"transparent",color:showKB?C.violet:C.t3,fontSize:10,fontWeight:600,cursor:"pointer"}}>🧠 {stats.total}</button>}
      </div>
    </div>
    <div style={{...mx,paddingTop:14,paddingBottom:80}}>
      <div style={{textAlign:"center",marginBottom:18}}>
        <h1 style={{fontSize:"clamp(20px,5vw,30px)",fontWeight:900,lineHeight:1.3,marginBottom:4}}>
          교통사고 <span style={{background:`linear-gradient(135deg,${C.blue},${C.violet})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>과실비율</span> 분석 시스템
        </h1>
        <p style={{fontSize:12,color:C.t2}}>ATLAS AI 추론 → 사고 상황 입력 → 과실비율 즉시 산정</p>
      </div>

      {running&&<AgentPipeline stepStates={stepStates}/>}

      {showKB&&<div style={{background:C.card,border:`1px solid ${C.violet}10`,borderRadius:14,padding:14,marginBottom:12,animation:"fadeUp .2s"}}>
        <div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}>
          <span style={{fontSize:11,fontWeight:700,color:C.t3}}>🧠 학습 DB ({kb.length}건)</span>
          {kb.length>0&&<Btn small onClick={()=>{if(confirm('전체 삭제?')){setKb([]);saveKB([])}}} sx={{color:C.red,fontSize:9}}>전체삭제</Btn>}
        </div>
        <textarea id="kb-input" placeholder="판례문 붙여넣기 → 파싱 저장" style={{width:"100%",padding:8,borderRadius:8,border:`1px solid ${C.b1}`,background:"rgba(6,9,16,.5)",color:C.t1,fontSize:11,resize:"vertical",minHeight:50,outline:"none"}}/>
        <Btn small primary onClick={()=>{const el=document.getElementById('kb-input');if(el?.value?.length>=20){addToKB(parsePrecedent(el.value));el.value=''}}} sx={{marginTop:4}}>파싱 & 저장</Btn>
        {kb.slice(0,6).map(c=><div key={c.id} style={{display:"flex",justifyContent:"space-between",padding:"4px 6px",borderRadius:6,background:"rgba(6,9,16,.3)",marginTop:3,fontSize:10}}>
          <span>{c.accidentType} <span style={{color:C.blue}}>{c.faultA}</span>:<span style={{color:C.red}}>{c.faultB}</span> {c.caseNumber||''}</span>
          <button onClick={()=>removeFromKB(c.id)} style={{background:"none",border:"none",color:C.t3,cursor:"pointer",fontSize:10}}>✕</button>
        </div>)}
      </div>}

      <div style={{background:C.card,border:`1px solid ${C.b1}`,borderRadius:18,padding:18,marginBottom:12}}>
        <div style={{display:"flex",alignItems:"center",gap:5,marginBottom:12}}><span style={{fontSize:15}}>📝</span><span style={{fontSize:14,fontWeight:800}}>사고 내용 기록</span></div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:10}}>
          <div><div style={{fontSize:10,fontWeight:600,color:C.t3,marginBottom:3}}>차종 및 연식</div>
            <input placeholder="예: 현대 아이오닉 5 (2023)" style={{width:"100%",padding:"9px 10px",borderRadius:8,border:`1px solid ${C.b2}`,background:"rgba(6,9,16,.5)",color:C.t1,fontSize:11,outline:"none"}}/></div>
          <div><div style={{fontSize:10,fontWeight:600,color:C.t3,marginBottom:3}}>차량 번호</div>
            <input placeholder="예: 12가 3456" style={{width:"100%",padding:"9px 10px",borderRadius:8,border:`1px solid ${C.b2}`,background:"rgba(6,9,16,.5)",color:C.t1,fontSize:11,outline:"none"}}/></div>
          <div><div style={{fontSize:10,fontWeight:600,color:C.t3,marginBottom:3}}>차대번호 (VIN) <span style={{fontSize:8,color:C.t3}}>(선택)</span></div>
            <input placeholder="영문/숫자 혼합 17자리" style={{width:"100%",padding:"9px 10px",borderRadius:8,border:`1px solid ${C.b2}`,background:"rgba(6,9,16,.5)",color:C.t1,fontSize:11,outline:"none",fontFamily:"var(--mono)"}}/></div>
        </div>
        <div style={{marginBottom:10}}>
          <div style={{fontSize:10,fontWeight:600,color:C.t3,marginBottom:3}}>사고 내용 설명 <span style={{color:C.red}}>*</span></div>
          <textarea ref={taRef} value={input} onChange={e=>setInput(e.target.value)}
            placeholder={"1) 사고 발생 시간:\n2) 사고 발생 장소:\n3) 보험 가입 여부:\n4) 경찰 신고 여부:\n5) 사고 내용 설명:\n\n예: 편도 2차로에서 1차로 직진 중 2차로 차량이 깜빡이 없이 차선변경하여 측면 충돌"}
            style={{width:"100%",padding:12,borderRadius:12,border:`1px solid ${C.b2}`,background:"rgba(6,9,16,.5)",color:C.t1,fontSize:12,outline:"none",resize:"vertical",minHeight:140,lineHeight:1.8,userSelect:"text",WebkitUserSelect:"text"}}/>
          <div style={{fontSize:9.5,color:C.t3,marginTop:4}}>{input.length}자{input.length>=5&&<span style={{color:C.emerald}}> ✓</span>}</div>
        </div>
      </div>

      <div style={{background:C.card,border:`1px solid ${C.b1}`,borderRadius:18,padding:18,marginBottom:12}}>
        <div style={{display:"flex",alignItems:"center",gap:5,marginBottom:10}}><span style={{fontSize:14}}>📎</span><span style={{fontSize:12,fontWeight:700}}>파일 첨부</span><span style={{fontSize:10,color:C.t3}}>(선택)</span></div>
        <label style={{display:"flex",flexDirection:"column",alignItems:"center",padding:18,borderRadius:12,border:`2px dashed ${C.b2}`,background:"rgba(6,9,16,.3)",cursor:"pointer"}}
          onDragOver={e=>{e.preventDefault();e.currentTarget.classList.add('drop-active')}}
          onDragLeave={e=>e.currentTarget.classList.remove('drop-active')}
          onDrop={e=>{e.preventDefault();e.currentTarget.classList.remove('drop-active');addFiles(e.dataTransfer.files)}}>
          <input type="file" multiple accept="image/*,video/*,.txt,.pdf,application/pdf" onChange={e=>{if(e.target.files?.length)addFiles(e.target.files)}} style={{display:"none"}}/>
          <div style={{fontSize:20,marginBottom:3}}>📤</div>
          <div style={{fontSize:11,fontWeight:600}}>클릭 또는 드래그</div>
          <div style={{fontSize:9.5,color:C.t3,marginTop:2}}>📄 PDF(EDR보고서) · 🖼️ 이미지 · 🎬 영상 (최대 50MB)</div>
        </label>
        {files.length>0&&<div style={{marginTop:8}}>{files.map(f=><div key={f.id} style={{display:"flex",gap:8,padding:6,borderRadius:8,background:"rgba(6,9,16,.3)",border:`1px solid ${f.pdf?`${C.cyan}15`:C.b1}`,marginBottom:3}}>
          <div style={{width:36,height:36,borderRadius:7,overflow:"hidden",background:"rgba(15,23,42,.4)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,fontSize:14}}>
            {f.preview?<img src={f.preview} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:f.pdf?"📄":f.type?.startsWith('video/')?"🎬":"📁"}
          </div>
          <div style={{flex:1,minWidth:0}}>
            <div style={{fontSize:10.5,fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{f.name}</div>
            <div style={{fontSize:9.5,color:f.pdf?C.cyan:C.t3}}>{(f.size/1024/1024).toFixed(1)}MB · {f.pdf?"📄 PDF":f.type?.startsWith('image/')?"🔍 OCR":f.type?.startsWith('video/')?"🎬 영상":"📁 파일"}</div>
          </div>
          <button onClick={()=>{setFiles(p=>p.filter(x=>x.id!==f.id));if(f.type?.startsWith('video/')){setVidSrc(null);setVidFrames([]);setVidEnv(null)}}} style={{background:"none",border:"none",color:C.t3,cursor:"pointer",fontSize:12,padding:"2px"}}>✕</button>
        </div>)}</div>}
        {vidSrc&&<div style={{marginTop:8}}>
          <video ref={vidRef} src={vidSrc} controls playsInline preload="metadata" style={{width:"100%",maxHeight:180,borderRadius:8,background:"#000"}}/>
          <div style={{padding:"6px 8px",borderRadius:7,background:`${C.amber}05`,border:`1px solid ${C.amber}10`,marginTop:4,fontSize:10,color:"#fcd34d"}}>💡 영상에서 환경정보를 추출합니다. <b>텍스트도 함께 입력</b>하면 정확도가 높아집니다.</div>
        </div>}
      </div>

            {/* 동의서 */}
      <div style={{background:C.card,border:`1px solid ${C.b1}`,borderRadius:18,padding:18,marginBottom:12}}>
        <div style={{fontSize:12,fontWeight:800,color:"#fbbf24",marginBottom:8}}>사고 분석 자료 제공 및 활용 동의서</div>
        <div style={{maxHeight:120,overflowY:"auto",padding:10,borderRadius:8,background:"rgba(6,9,16,.5)",border:`1px solid ${C.b1}`,fontSize:10,color:C.t2,lineHeight:1.8,marginBottom:8}}>
          <p>엠디랩스(이하 "회사")는 이용자의 소중한 데이터를 바탕으로 전문적인 사고 분석 서비스를 제공합니다.</p>
          <p style={{marginTop:6,fontWeight:700}}>1. 개인정보의 수집 및 이용 (필수)</p>
          <p>• 수집 항목: 사고 내용, 차량 정보, 첨부 자료</p>
          <p>• 수집 목적: 사고 분석 결과 제공, 서비스 품질 향상</p>
          <p>• 보유 기간: 서비스 목적 달성 후 1년</p>
          <p style={{marginTop:6,fontWeight:700}}>2. 분석 결과의 성격 및 한계</p>
          <p>• 본 분석 결과는 AI 기반의 참고 자료이며, 실제 법적 판단과 다를 수 있습니다.</p>
          <p style={{marginTop:6,fontWeight:700}}>3. 제공 자료의 적법성</p>
          <p>• 이용자는 제공하는 자료가 본인이 적법하게 보유한 것임을 확인합니다.</p>
        </div>
        <label style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",padding:"8px 0"}}>
          <input type="checkbox" checked={agreed} onChange={e=>setAgreed(e.target.checked)} style={{width:18,height:18,accentColor:C.blue,cursor:"pointer",flexShrink:0}}/>
          <span style={{fontSize:11,color:agreed?C.t1:C.t3,fontWeight:agreed?600:400}}>위 동의서의 내용을 모두 확인하였으며, 이에 동의합니다.</span>
        </label>
      </div>

      <button onClick={runAnalysis} disabled={running||!agreed||(!input.trim()&&files.length===0&&!vidSrc)}
        style={{width:"100%",padding:"14px 20px",borderRadius:14,border:"none",
          background:running?"rgba(99,102,241,.12)":agreed&&(input.trim()||files.length>0||vidSrc)?`linear-gradient(135deg,${C.blue},${C.violet})`:"#1e293b",
          color:running?"#818cf8":agreed&&(input.trim()||files.length>0||vidSrc)?"#fff":"#475569",
          fontSize:15,fontWeight:800,cursor:running?"wait":"pointer",transition:"all .3s",marginBottom:18,
          animation:running?"pulse 1.5s infinite":"none"}}>
        {running?"🤖 ATLAS AI 추론 중...":"⚖️ 과실비율 분석 시작"}
      </button>

      <div style={{marginBottom:16}}>
        <div style={{fontSize:10,fontWeight:700,color:C.t3,marginBottom:4}}>📌 예시 (좌우 스크롤)</div>
        <div style={{display:"flex",gap:6,overflowX:"auto",paddingBottom:6,WebkitOverflowScrolling:"touch"}}>
          {examples.map((ex,i)=><button key={i} onClick={()=>{setInput(ex);taRef.current?.focus()}}
            style={{flexShrink:0,width:220,textAlign:"left",padding:"8px 10px",borderRadius:8,border:`1px solid ${C.b1}`,background:"rgba(12,17,30,.5)",color:C.t2,fontSize:10,cursor:"pointer",lineHeight:1.4}}>
            <span style={{color:C.indigo,fontWeight:700,marginRight:4}}>0{i+1}</span>{ex.slice(0,60)}...
          </button>)}
        </div>
      </div>

      <div style={{textAlign:"center",padding:"10px 0"}}>
        
      </div>
    </div>
  </div>;
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
