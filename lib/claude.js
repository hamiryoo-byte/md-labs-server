const Anthropic = require('@anthropic-ai/sdk');
const client = new Anthropic({ apiKey: process.env.CLAUDE_API_KEY });

// ═══════════════════════════════════════════════════════════════
// ATLAS-4.1: 2단계 강제 분류 + A/B 라벨 동기화
// 핵심 개선: 카테고리 확정 → 도표 선택 (점프 분류 차단)
// 기존 문제: 434종 + 도표 동시 제시 → 카테고리 넘나드는 오분류
// ═══════════════════════════════════════════════════════════════

// ═══ 수정요소 가이드 (기존 유지) ═══
const MODIFIER_GUIDE = `
## 수정요소 (12가지 가감 인자)
| 수정요소 | 가감값 | 비고 |
|---------|--------|------|
| 1. 현저한 과실 (음주/약물) | +10~20 | 해당 측에 가산 |
| 2. 중대한 과실 (음주 0.08%↑) | +20~30 | 해당 측에 가산 |
| 3. 무면허 운전 | +10 | 해당 측에 가산 |
| 4. 과속 (20km/h 이상) | +5~10 | 해당 측에 가산 |
| 5. 대형차 | +5 | 상대방에게 감산 |
| 6. 직진차 명백한 선진입 | -10 | 해당 측에 감산 |
| 7. 직진차 현저한 과속 | +10 | 해당 측에 가산 |
| 8. 이면도로/생활도로 | ±5 | 상황에 따라 |
| 9. 야간 (시야불량) | +5 | 해당 측에 가산 |
| 10. 전방주시의무 위반 | +5~10 | 해당 측에 가산 |
| 11. 방향지시등 미사용 | +5~10 | 해당 측에 가산 |
| 12. 비보호좌회전시 주의의무 | +5~10 | 해당 측에 가산 |

적용 규칙: 최종 = 기본비율 + Σ(수정요소), 범위 0~100
`;

// ═══ 판례 레퍼런스 (기존 유지, 압축) ═══
const PRECEDENT_GUIDE = `
## 실제 판례 기반 과실비율 레퍼런스 (1,851건 DB)

### 주요 판례
- [50:50] 수원지방법원-2019가단560688 — 신호교차로 이륜차 직진 vs 자동차 좌회전
- [20:80] 울산지방법원-2021가단126015 — 비보호좌회전/유턴 금지 위반
- [30:70] 의정부지방법원고양지원-2012가단37919 — 어린이보호구역 제한속도 초과 vs 무단횡단
- [85:15] 청주지방법원-2014나1271 — 불법 유턴 차량 급진입
- [10:90] 전주지방법원-2012가단19118 — 차량 보행자 보호의무 90% 인정

### 통계 (전체 1,851건)
50:50(366건), 30:70(261건), 20:80(239건), 40:60(198건), 10:90(140건)

### 활용 지침
1. 도표의 기본 과실비율을 우선 적용
2. 판례로 타당성 교차 검증
3. 분석 의견에 관련 판례번호 인용 가능
`;

/**
 * ATLAS-4.0: 2단계 강제 분류 + 도표 매칭
 */
async function analyzeAccident(text, diagramList) {
  const systemPrompt = `당신은 한국 손해보험협회 「자동차사고 과실비율 인정기준(2023.6)」 전문 분석가입니다.
교통사고 상황을 분석하여 가장 적합한 도표를 선택하고 과실비율을 산정합니다.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
★★★ 필수 2단계 분류 절차 (이 순서를 반드시 따르십시오) ★★★
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## STEP 1: 당사자 유형 + 사고 카테고리 확정

### 1-A) 당사자 유형 판별 (최우선 — 건너뛰지 마십시오)

입력 텍스트에서 아래 키워드를 탐지하여 당사자 유형을 확정합니다:

| 키워드 | 당사자 유형 | 도표 ID 범위 |
|--------|------------|-------------|
| 자전거, 자전거도로, 바이크, 이륜(자전거) | **차대자전거** | 거1~거26만 사용 |
| 보행자, 횡단보도, 보행, 무단횡단, 어린이, 보행중 | **차대사람** | 보1~보33만 사용 |
| 위 키워드 모두 없음 | **차대차** | 101~626 사용 |

### 1-B) 차대차인 경우 하위 유형 확정

| 핵심 키워드 | 하위 유형 | 도표 ID 범위 |
|------------|----------|-------------|
| 교차로, 녹색, 적색, 황색, 신호, 좌회전, 우회전, 비보호 | 교차로(신호) | **101~126** |
| 무신호, 같은폭, 넓은도로/좁은도로, 일시정지 | 교차로(무신호) | **201~223** |
| 중앙선, 대향, 역주행, 정면충돌 | 대향 | **301~317** |
| 차선변경, 추월, 같은방향, 앞차/뒤차, 추돌, 급정거 | 동행 | **401~428** |
| 합류, 진입로, 톨게이트, 가속차로 | 합류 | **501~510** |
| 고속도로, 본선, 갓길, 졸음 | 고속도로 | **551~561** |
| 주차장, 주차, 후진, 출차, 개문, 유턴, 도로외, 골목 | 기타 | **601~626** |

### 1-C) 차대자전거인 경우 하위 유형 확정
- 교차로, 우회전, 좌회전 → 거1~거7 (교차로)
- 같은방향, 추월 → 거2~거21 (동행)
- 그 외 → 거4~거26 (기타)

### 1-D) 차대사람인 경우 하위 유형 확정
- 횡단보도 → 보1~보10 (횡단보도)
- 그 외 → 보11~보33 (기타보행)

## STEP 2: 확정된 카테고리 내에서 도표 선택

STEP 1에서 확정된 도표 ID 범위만 검토하여 가장 적합한 도표를 선택합니다.
다른 범위의 도표는 절대 선택하지 마십시오.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ 절대 금지 규칙 (위반 시 심각한 오분류)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. "자전거" 키워드 있음 → 거 시리즈만 선택 (101~626 사용 금지)
2. "보행자/횡단보도" 키워드 있음 → 보 시리즈만 선택
3. 차량 2대만의 사고 → 보/거 시리즈 사용 금지
4. "주차장/후진/출차/개문" → 601~626만 선택 (교차로 101~223 사용 금지)
5. "녹색/적색/황색/신호" → 101~126 우선 (동행 401~428이 아님)
6. "유턴" → 601~626 기타 범위 우선 검토

위 금지 규칙을 위반하는 것보다 "해당 카테고리에서 가장 근접한 도표"를 선택하는 것이 훨씬 낫습니다.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ A/B 라벨 규칙 (반드시 도표 기준으로 할당)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

과실비율의 A/B는 반드시 **선택한 도표의 A/B 정의**를 따르십시오.
사용자 입력에서 "A", "B"로 부른 당사자와 도표의 A/B가 다를 수 있습니다.

**처리 절차:**
1. 도표를 선택하면 해당 도표의 label_a, label_b 정의를 확인합니다
2. 사용자 입력의 각 당사자가 도표의 A/B 중 어디에 해당하는지 매핑합니다
3. 도표의 A/B 정의에 맞춰 fault_a, fault_b를 할당합니다

**예시:**
- 도표 106: A=직진(30%), B=비보호좌회전(70%)
- 입력: "비보호좌회전 A + 직진 B"
- → 사용자의 "A"(비보호좌회전)는 도표의 B에 해당
- → 사용자의 "B"(직진)는 도표의 A에 해당
- → 응답: fault_a=30, fault_b=70, label_a="직진", label_b="비보호좌회전"

**도표 목록의 제목 해석 규칙:**
도표 목록에서 "X vs Y" 형식의 제목은 A=X, B=Y를 의미합니다.
예: "101: 녹색직진 vs 적색직진" → A=녹색직진, B=적색직진
예: "106: 직진 vs 비보호좌회전" → A=직진, B=비보호좌회전
도표에 기본과실이 표시된 경우 (예: A30:B70) 반드시 그 값을 base_fault으로 사용하십시오.

**절대 사용자 입력의 A/B 순서를 따르지 마십시오. 도표의 A/B 정의가 항상 우선합니다.**

${MODIFIER_GUIDE}

${PRECEDENT_GUIDE}

## 응답 형식
반드시 아래 JSON만 출력하십시오. 마크다운 코드블록이나 설명 텍스트 없이 순수 JSON만 출력합니다.
{
  "step1_category": "차대차|차대사람|차대자전거",
  "step1_subcategory": "교차로신호|교차로무신호|대향|동행|합류|고속도로|기타|횡단보도|기타보행|교차로자전거|동행자전거|기타자전거",
  "step1_keywords": "카테고리 판별에 사용한 핵심 키워드",
  "step1_id_range": "검토한 도표 ID 범위 (예: 101~126)",
  "diagram_id": "선택한 도표 ID",
  "diagram_title": "도표 제목",
  "category": "차대차|차대사람|차대자전거",
  "confidence": 0~100 숫자,
  "reasoning": "도표 선택 이유 (2~3문장)",
  "fault_a": 최종과실비율A,
  "fault_b": 최종과실비율B,
  "base_fault_a": 기본과실비율A,
  "base_fault_b": 기본과실비율B,
  "label_a": "A측 명칭",
  "label_b": "B측 명칭",
  "detected_modifiers": ["감지된 수정요소들"],
  "modifier_detail": [{"name":"수정요소명","target":"A|B","value":가감값,"reason":"근거"}],
  "legal_basis": ["관련 법규"],
  "precedent_refs": ["유사 판례번호"],
  "analysis": "종합 분석 (3~5문장)"
}`;

  const userPrompt = `다음 교통사고를 분석해주세요.

★ 반드시 STEP 1(카테고리 확정) → STEP 2(도표 선택) 순서를 따르십시오.
★ STEP 1에서 확정된 도표 ID 범위 밖의 도표는 절대 선택하지 마십시오.
★ A/B 과실비율은 반드시 도표의 A/B 정의를 따르십시오 (사용자 입력의 A/B 순서가 아님).

## 사고 상황
${text}

## 사용 가능한 도표 목록
${diagramList}`;

  const response = await client.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 2000,
    system: systemPrompt,
    messages: [{ role: 'user', content: userPrompt }],
  });

  const content = response.content[0]?.text || '';
  const clean = content.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();

  let parsed;
  try {
    parsed = JSON.parse(clean);
  } catch (e) {
    // JSON 파싱 실패 시 정규식으로 추출 시도
    const jsonMatch = clean.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      try { parsed = JSON.parse(jsonMatch[0]); }
      catch { parsed = { error: 'JSON 파싱 실패', raw: content }; }
    } else {
      parsed = { error: 'JSON 파싱 실패', raw: content };
    }
  }

  return {
    result: parsed,
    usage: {
      input_tokens: response.usage?.input_tokens || 0,
      output_tokens: response.usage?.output_tokens || 0,
      model: 'claude-sonnet-4-20250514',
    }
  };
}

/**
 * ATLAS-4.0: AI 감정서 생성 (판례 인용 포함)
 */
async function generateReport(analysisData) {
  const response = await client.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 3000,
    system: `당신은 교통사고 손해사정 전문가입니다.
감정서에 포함될 분석 의견을 작성하세요.
전문적이고 객관적인 어조를 사용하며, 법적 근거를 명시하세요.
한국어로 작성하세요.

${MODIFIER_GUIDE}

${PRECEDENT_GUIDE}`,
    messages: [{
      role: 'user',
      content: `다음 분석 결과를 바탕으로 감정서 종합 의견을 작성해주세요:

사고 유형: ${analysisData.category} — ${analysisData.diagram_title}
적용 도표: ${analysisData.diagram_id}

기본 과실비율: ${analysisData.label_a} ${analysisData.base_fault_a}% : ${analysisData.label_b} ${analysisData.base_fault_b}%
수정요소: ${(analysisData.modifiers || analysisData.detected_modifiers || []).join(', ') || '없음'}
수정요소 상세: ${JSON.stringify(analysisData.modifier_detail || [])}
최종 과실비율: ${analysisData.label_a} ${analysisData.fault_a}% : ${analysisData.label_b} ${analysisData.fault_b}%
유사 판례: ${(analysisData.precedent_refs || []).join(', ') || '없음'}
사고 상황: ${analysisData.input_text}

아래 항목을 포함하여 작성:
1. 사고 유형 판단 근거
2. 과실비율 인정기준 적용 설명
3. 과실비율 산정 논리
4. 수정요소 적용 근거
5. 유사 판례 인용 (있는 경우)
6. 법적 근거 설명 (도로교통법, 민법 등)
7. 유의사항 및 참고사항`
    }],
  });

  return {
    text: response.content[0]?.text || '',
    usage: {
      input_tokens: response.usage?.input_tokens || 0,
      output_tokens: response.usage?.output_tokens || 0,
      model: 'claude-sonnet-4-20250514',
    }
  };
}

module.exports = { analyzeAccident, generateReport };
