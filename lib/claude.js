const Anthropic = require('@anthropic-ai/sdk');
const client = new Anthropic({ apiKey: process.env.CLAUDE_API_KEY });

// ═══════════════════════════════════════════════════════════════
// ATLAS-3.1: 434종 과실비율 분류 체계 + 1,851건 판례 DB 통합
// 4개 분류축: 사고장소(15) × 장소특징(61) × 객체A(180) × 객체B(174)
// + 실제 법원 판결 과실비율 레퍼런스
// ═══════════════════════════════════════════════════════════════

const CLASSIFICATION_GUIDE = `
## 🔷 4축 분류 체계 (손해보험협회 인정기준)

### [축1] 사고장소 (15종)
0=직선도로, 1=사거리교차로(무신호), 2=사거리교차로(신호), 3=T자형교차로,
4=차도와차도아닌장소, 5=주차장, 6=회전교차로, 7=횡단보도(무신호),
8=횡단보도(신호), 9=횡단보도없음, 10=횡단보도(무신호)부근,
11=횡단보도(신호)부근, 12=육교/지하도부근, 13=고속도로, 14=자전거도로

### [축2] 사고장소 특징 (주요 61종 중 핵심)
0=추돌, 1=합류, 2=열린문접촉, 3=역주행(중앙선침범), 4=이면도로교행,
5=추월, 6=차로변경(진로변경), 7=안전지대통과, 8=정차후출발, 9=긴급자동차,
10=동일폭도로, 11=대로와소로, 12=일시정지표시, 13=일방통행표지,
14=교차로내진로변경, 15=2개차량나란히통행, 16=좌우회전각도90도미만,
17=2개차로동시우회전, 18=측면진입, 19=일시정지표지, 20=차도아닌→차도진입,
21=차도→차도아닌장소진입, 22=주차구역과통로, 23=회전차로1차로형,
24=회전차로2차로형, 25=직선도로, 26=교차로통과후, 27=교차로통과전,
28=교차로(대로소로), 29=교차로(동일폭), 30=단일로(중앙선없음),
31=보도와차도, 32=보도차도(구분없음), 48=유턴구역, 49=맞은편진입,
50=노면표시위반, 59=비보호좌회전, 60=신호등한쪽만있음

### [축3] 사고객체 A 진행정보 (주요 유형)
직진, 좌회전, 우회전, 유턴, 추돌, 차로변경, 정차후출발, 후진,
[녹색신호]직진, [적색신호]직진, [황색신호]직진,
[녹색좌회전신호]좌회전, 횡단보도횡단, 보도보행, 차도보행 등 180종

### [축4] 사고객체 B 진행정보 (주요 유형)
직진, 좌회전, 우회전, 추월, 중앙선침범, 차로변경, 진로변경,
[적색신호]직진, [녹색신호]직진, 보도침범, 차도주행, 후진 등 174종

## 🔷 434종 핵심 과실비율 매핑 (사고유형별 기본 과실비율)

### 직선도로 (유형 0~20)
| 유형 | 장소특징 | A | B | A과실 | B과실 |
|------|---------|---|---|-------|-------|
| 0 | 추돌 | 1차사고차량추돌 | 선행차 | 80 | 20 |
| 1 | 추돌 | 후행추돌 | 선행직진 | 100 | 0 |
| 2 | 추돌 | 주정차 | 후행추돌 | 0 | 100 |
| 3 | 합류 | 본선직진 | 합류진입 | 40 | 60 |
| 4 | 문열림 | 후행직진 | 정차중문열림 | 20 | 80 |
| 5 | 중앙선침범 | 직진 | 중앙선침범 | 0 | 100 |
| 6 | 이면도로교행 | 마주보며직진 | 마주보며직진 | 50 | 50 |
| 7 | 추월(실선) | 선행직진 | 실선추월 | 0 | 100 |
| 8 | 추월(점선) | 선행직진 | 급접거리추월 | 0 | 100 |
| 9 | 추월(쌍방) | 중앙선추월(후방) | 중앙선추월(전방) | 60 | 40 |
| 10 | 추월위반 | 실선추월 | 선행직진 | 100 | 0 |
| 11 | 진로변경 | 후행직진 | 선행진로변경 | 30 | 70 |
| 12 | 동시진로변경 | 동시변경 | 동시변경 | 50 | 50 |
| 16 | 정차후출발 | 정차후출발 | 추월 | 80 | 20 |
| 17 | 긴급차(중앙선) | 직진 | 긴급차중앙선통행 | 60 | 40 |

### 사거리교차로 무신호 (유형 21~59)
| 유형 | 장소특징 | A | B | A과실 | B과실 |
|------|---------|---|---|-------|-------|
| 21 | 동일폭 | 우측직진 | 좌측직진 | 40 | 60 |
| 24 | 동일폭(대향좌회전) | 마주보며직진 | 마주보며좌회전 | 30 | 70 |
| 27 | 동일폭(우회전vs직진) | 우회전 | 직진 | 60 | 40 |
| 31 | 대로소로 | 대로직진 | 소로직진 | 30 | 70 |
| 44 | 일시정지 | 표지없는도로직진 | 일시정지위반직진 | 20 | 80 |

### 사거리교차로 신호 (유형 60~105)
| 유형 | 장소특징 | A | B | A과실 | B과실 |
|------|---------|---|---|-------|-------|
| 60 | 측면(녹vs적) | 녹색직진 | 적색직진 | 0 | 100 |
| 63 | 측면(황vs적) | 황색직진 | 적색직진 | 30 | 70 |
| 65 | 측면(적vs적) | 적색직진 | 적색직진 | 50 | 50 |
| 79 | 비보호좌회전 | 녹색좌회전(비보호) | 녹색직진 | 80 | 20 |
| 91 | 유턴(상시) | 마주보며직진 | 상시유턴 | 20 | 80 |

### T자형 교차로 (유형 106~122)
| 유형 | 장소특징 | A | B | A과실 | B과실 |
|------|---------|---|---|-------|-------|
| 106 | 동일폭 | 직진 | 우회전 | 30 | 70 |
| 110 | 대로소로 | 대로직진 | 소로좌회전 | 10 | 90 |
| 111 | 대로소로 | 대로직진 | 소로우회전 | 20 | 80 |

### 차도/주차장/회전교차로 (유형 123~132)
| 유형 | A | B | A과실 | B과실 |
|------|---|---|-------|-------|
| 123 | 차도직진 | 차도아닌곳→중앙선침범진입 | 0 | 100 |
| 124 | 차도직진 | 차도아닌곳→우회전진입 | 20 | 80 |
| 126 | 통로직진 | 주차구역직진출자 | 30 | 70 |
| 128 | 회전교차로진입 | 교차로내회전 | 80 | 20 |

### 차대보행자 횡단보도 (유형 133~169)
| 유형 | 장소 | A(보행자) | B(차량) | A과실 | B과실 |
|------|------|----------|---------|-------|-------|
| 133 | 횡단보도(무신호) | 횡단 | 직진 | 0 | 100 |
| 154 | 횡단보도(신호)통과전 | 적색횡단 | 녹색직진 | 70 | 30 |
| 155 | 횡단보도(신호)통과전 | 녹색횡단 | 적색직진 | 0 | 100 |
| 160 | 횡단보도없음(대로소로) | 소로횡단 | 소로주행 | 10 | 90 |
| 163 | 횡단보도없음(단일로) | 횡단 | 직진 | 20 | 80 |
| 164 | 보도와차도 | 보도보행 | 보도침범 | 0 | 100 |
| 169 | 보도차도(구분없음) | 가장자리보행 | 차도주행 | 0 | 100 |
`;

// ═══════════════════════════════════════════════════════════════
// 12가지 수정요소 (가감 인자)
// ═══════════════════════════════════════════════════════════════

const MODIFIER_GUIDE = `
## 🔷 수정요소 (12가지 가감 인자)
아래 요소가 감지되면 기본 과실비율에서 가감합니다:

| 수정요소 | A가산 | B가산 | 비고 |
|---------|-------|-------|------|
| 1. 현저한 과실 (음주/약물) | +10~20 | +10~20 | 해당 측에 가산 |
| 2. 중대한 과실 (음주 0.08%↑) | +20~30 | +20~30 | 해당 측에 가산 |
| 3. 무면허 운전 | +10 | +10 | 해당 측에 가산 |
| 4. 과속 (20km/h 이상) | +5~10 | +5~10 | 해당 측에 가산 |
| 5. 대형차 | +5 | +5 | 상대방에게 감산 |
| 6. 직진차 명백한 선진입 | -10 | -10 | 해당 측에 감산 |
| 7. 직진차 현저한 과속 | +10 | +10 | 해당 측에 가산 |
| 8. 이면도로/생활도로 | ±5 | ±5 | 상황에 따라 |
| 9. 야간 (시야불량) | +5 | +5 | 해당 측에 가산 |
| 10. 전방주시의무 위반 | +5~10 | +5~10 | 해당 측에 가산 |
| 11. 방향지시등 미사용 | +5~10 | +5~10 | 해당 측에 가산 |
| 12. 비보호좌회전시 주의의무 | +5~10 | +5~10 | 해당 측에 가산 |

**적용 규칙:** 수정요소는 해당 당사자의 과실에 가산/감산하되, 합산 과실비율은 0~100 범위를 넘지 않습니다.
최종 과실비율 = 기본비율 + Σ(수정요소) → min 0, max 100
`;

// ═══════════════════════════════════════════════════════════════
// 실제 판례 레퍼런스 (AI HUB 민사법 판결문 1,851건 DB)
// ═══════════════════════════════════════════════════════════════

const PRECEDENT_GUIDE = `
## 🔷 실제 판례 기반 과실비율 레퍼런스 (1,851건 DB)
유사 사고 분석 시 아래 실제 판결을 참고하여 과실비율의 타당성을 검증하세요.

### 교차로 사고 (675건)
주요 과실비율: 20:80(113건), 50:50(82건), 30:70(79건), 40:60(72건), 10:90(61건)
  [50:50] 수원지방법원-2019가단560688 — 신호교차로 이륜차 직진 vs 자동차 좌회전, 황색/적색 신호 경합
  [20:80] 울산지방법원-2021가단126015 — 비보호좌회전/유턴 금지 위반, 전방주시의무 해태 인정
  [30:70] 의정부지방법원고양지원-2012가단37919 — 어린이보호구역 제한속도 초과 vs 무단횡단

### 추돌 사고 (218건)
주요 과실비율: 30:70(35건), 50:50(29건), 20:80(24건), 40:60(23건), 10:90(20건)
  [20:80] 서울남부지방법원-2020나71619 — 이륜차 vs 차량, 심의위원회 과실비율 심의결정
  [50:50] 광주지방법원-2022가단552822 — 택시 vs 차량 교차로 내 과실 경합
  [85:15] 청주지방법원-2014나1271 — 불법 유턴 차량 3차로→1차로 급진입

### 보행자 사고 (211건)
주요 과실비율: 50:50(30건), 30:70(30건), 20:80(29건), 10:90(21건), 40:60(20건)
  [30:70] 의정부지방법원고양지원-2012가단37919 — 어린이보호구역 보행자 무단횡단 vs 과속
  [20:80] 서울남부지방법원-2020나71619 — 보행자 보호의무 위반
  [10:90] 전주지방법원-2012가단19118 — 차량 보행자 보호의무, 책임 90% 인정

### 이륜차/PM 사고 (116건)
주요 과실비율: 20:80(24건), 30:70(17건), 50:50(15건), 10:90(9건), 40:60(9건)
  [50:50] 수원지방법원-2019가단560688 — 이륜차 적색진입 vs 자동차 황색진입, 이륜차 특성 고려
  [20:80] 울산지방법원-2020나13885 — 소로/대로 교차로 이륜차 사고, 폭 넓은 도로 우선
  [10:90] 전주지방법원-2012가단19118 — 이륜차 안전모 미착용 과실상계

### 과실비율 통계 (전체 1,851건)
50:50(366건), 30:70(261건), 20:80(239건), 40:60(198건), 10:90(140건),
80:20(127건), 70:30(127건), 60:40(117건), 90:10(63건), 15:85(50건)

### 판례 활용 지침
1. 434종 테이블의 기본 과실비율을 우선 적용
2. 실제 판례의 과실비율로 타당성 교차 검증
3. 판례에서 인정된 수정요소(음주, 과속, 신호위반 등) 참고
4. 분석 의견에 관련 판례번호 인용 가능
`;

/**
 * ATLAS-3.1: 434종 분류 체계 + 1,851건 판례 통합 Claude API
 * 사고 텍스트 → 도표 매칭 + 과실비율 분석 + 판례 근거
 */
async function analyzeAccident(text, diagramList) {
  const systemPrompt = `당신은 한국 교통사고 과실비율 전문 분석가입니다.
손해보험협회 「자동차사고 과실비율 인정기준(2023년 6월)」을 기준으로 분석합니다.
또한, AI HUB 민사법 판결문 1,851건의 실제 판례 DB를 참고하여 분석의 정확도를 높입니다.

${CLASSIFICATION_GUIDE}

${MODIFIER_GUIDE}

${PRECEDENT_GUIDE}

## 🔷 분석 절차
1. 사고 텍스트에서 4축 정보를 추출하세요:
   - 사고장소 (15종 중 어디?)
   - 장소특징 (61종 중 무엇?)
   - A차량/객체 진행정보 (180종 중 무엇?)
   - B차량/객체 진행정보 (174종 중 무엇?)
2. 4축 조합으로 434종 과실비율 테이블에서 가장 적합한 사고유형을 찾으세요.
3. 아래 도표 목록에서도 가장 적합한 도표를 선택하세요.
4. 수정요소를 감지하여 최종 과실비율을 산정하세요.
5. 유사한 실제 판례가 있으면 판례번호를 인용하여 분석 근거를 보강하세요.

## 🔷 도표 목록 (MD Labs DB)
${diagramList}

## 🔷 응답 형식 (반드시 JSON으로만 응답)
{
  "diagram_id": "도표번호",
  "diagram_title": "도표 제목",
  "category": "차대차|차대사람|차대자전거",
  "confidence": "상|중|하",
  "accident_type_434": 434종_사고유형번호_또는_-1,
  "classification": {
    "place": "사고장소 (한글)",
    "place_code": 사고장소코드,
    "feature": "장소특징 (한글)",
    "feature_code": 장소특징코드,
    "vehicle_a": "A 진행정보 (한글)",
    "vehicle_b": "B 진행정보 (한글)"
  },
  "reasoning": "이 도표/사고유형을 선택한 이유 (2-3문장)",
  "fault_a": 최종과실비율A,
  "fault_b": 최종과실비율B,
  "base_fault_a": 기본과실비율A,
  "base_fault_b": 기본과실비율B,
  "label_a": "A측 명칭",
  "label_b": "B측 명칭",
  "detected_modifiers": ["감지된 수정요소들"],
  "modifier_detail": [
    {"name": "수정요소명", "target": "A|B", "value": 가감값, "reason": "근거"}
  ],
  "modifier_reasoning": "수정요소 적용 근거",
  "legal_basis": ["관련 법규 조문"],
  "precedent_refs": ["유사 판례번호 (있는 경우)"],
  "analysis": "종합 분석 의견 (3-5문장)"
}`;

  const response = await client.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 2000,
    system: systemPrompt,
    messages: [{ role: 'user', content: `다음 교통사고를 분석해주세요:\n\n${text}` }],
  });

  const content = response.content[0]?.text || '';
  const clean = content.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();

  let parsed;
  try {
    parsed = JSON.parse(clean);
  } catch (e) {
    parsed = { error: 'JSON 파싱 실패', raw: content };
  }

  return {
    result: parsed,
    usage: {
      input_tokens: response.usage?.input_tokens || 0,
      output_tokens: response.usage?.output_tokens || 0,
      model: 'claude-sonnet-4-20250514',
    }
  };
}

/**
 * ATLAS-3.1: 강화된 AI 감정서 생성 (판례 인용 포함)
 */
async function generateReport(analysisData) {
  const response = await client.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 3000,
    system: `당신은 교통사고 손해사정 전문가입니다.
감정서에 포함될 분석 의견을 작성하세요.
전문적이고 객관적인 어조를 사용하며, 법적 근거를 명시하세요.
한국어로 작성하세요.

${CLASSIFICATION_GUIDE}

${PRECEDENT_GUIDE}

위 434종 분류 체계와 1,851건 판례를 참고하여, 해당 사고가 어떤 유형에 해당하는지 명확히 기술하세요.
4축 분류(사고장소, 장소특징, A정보, B정보)를 감정서에 포함하세요.
유사 판례가 있으면 판례번호를 인용하여 분석 근거를 보강하세요.`,
    messages: [{
      role: 'user',
      content: `다음 분석 결과를 바탕으로 감정서 종합 의견을 작성해주세요:

사고 유형: ${analysisData.category} — ${analysisData.diagram_title}
적용 도표: ${analysisData.diagram_id}
434종 사고유형: ${analysisData.accident_type_434 || '미분류'}

4축 분류:
- 사고장소: ${analysisData.classification?.place || '미상'}
- 장소특징: ${analysisData.classification?.feature || '미상'}
- A 진행정보: ${analysisData.classification?.vehicle_a || '미상'}
- B 진행정보: ${analysisData.classification?.vehicle_b || '미상'}

기본 과실비율: ${analysisData.label_a} ${analysisData.base_fault_a}% : ${analysisData.label_b} ${analysisData.base_fault_b}%
수정요소: ${(analysisData.modifiers || []).join(', ') || '없음'}
수정요소 상세: ${JSON.stringify(analysisData.modifier_detail || [])}
최종 과실비율: ${analysisData.label_a} ${analysisData.fault_a}% : ${analysisData.label_b} ${analysisData.fault_b}%
유사 판례: ${(analysisData.precedent_refs || []).join(', ') || '없음'}
사고 상황: ${analysisData.input_text}

아래 항목을 포함하여 작성:
1. 사고 유형 판단 근거 (4축 분류 기반)
2. 434종 과실비율 인정기준 적용 설명
3. 과실비율 산정 논리
4. 수정요소 적용 근거
5. 유사 판례 인용 (있는 경우)
6. 법적 근거 설명 (도로교통법, 민법 등)
7. 유의사항 및 참고사항`
    }],
  });

  return {
    text: response.content[0]?.text || '',
    usage: {
      input_tokens: response.usage?.input_tokens || 0,
      output_tokens: response.usage?.output_tokens || 0,
      model: 'claude-sonnet-4-20250514',
    }
  };
}

module.exports = { analyzeAccident, generateReport };
